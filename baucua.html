<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <!-- Quan tr·ªçng: viewport-fit=cover ƒë·ªÉ x·ª≠ l√Ω v√πng an to√†n tai th·ªè/home bar -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>B·∫ßu Cua Global VIP - HC88</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
  <!-- SUPABASE LIBRARY -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { oswald: ['Oswald', 'sans-serif'], roboto: ['Roboto', 'sans-serif'] },
          colors: { gold: '#FFD700', 'gold-dark': '#B8860B', plate: '#E5E7EB' },
          boxShadow: { 'glow': '0 0 15px rgba(255, 215, 0, 0.5)' },
          screens: { 'short': { 'raw': '(max-height: 700px)' } }
        }
      }
    }
  </script>

  <style>
    /* CORE SETUP */
    body {
      background: radial-gradient(circle at 50% -20%, #0f172a 0%, #020617 100%);
      color: white; overflow: hidden; touch-action: manipulation; user-select: none;
      -webkit-tap-highlight-color: transparent; font-family: 'Roboto', sans-serif;
      /* Fix full height mobile */
      height: 100vh; height: 100dvh;
    }
    
    /* GLASS PANEL */
    .glass {
      background: rgba(15, 23, 42, 0.92); backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }

    /* 3D BOWL & PLATE - AUTO SCALE */
    .plate-container {
      width: 260px; height: 260px; margin: 0 auto;
      display: flex; align-items: center; justify-content: center; position: relative;
      transition: transform 0.3s ease;
    }
    /* M√†n h√¨nh th·∫•p < 720px: Thu nh·ªè 85% */
    @media (max-height: 720px) { .plate-container { transform: scale(0.85); } }
    /* M√†n h√¨nh r·∫•t th·∫•p < 620px: Thu nh·ªè 75% v√† ƒë·∫©y l√™n */
    @media (max-height: 620px) { .plate-container { transform: scale(0.75); margin-top: -30px; } }

    .plate {
      position: absolute; width: 240px; height: 240px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #475569, #1e293b);
      box-shadow: 0 20px 50px rgba(0,0,0,0.8), inset 0 2px 5px rgba(255,255,255,0.1);
      border: 6px solid #334155; z-index: 1;
    }
    .bowl {
      position: absolute; width: 220px; height: 220px; border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #64748b, #0f172a);
      box-shadow: inset 0 10px 30px rgba(255,255,255,0.15), 0 25px 60px rgba(0,0,0,0.9);
      z-index: 20; display: flex; align-items: center; justify-content: center;
      transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .bowl::before { content: ''; position: absolute; inset: 10px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.05); }
    .bowl.open { transform: translate(40px, -130px) rotate(15deg); }
    .bowl.shaking { animation: shake 0.4s ease-in-out infinite; }
    @keyframes shake { 0%,100%{transform:translate(0,0) rotate(0)} 25%{transform:translate(-5px,5px) rotate(-5deg)} 75%{transform:translate(5px,-5px) rotate(5deg)} }

    /* DICE */
    .dice { 
      width: 44px; height: 44px; background: white; border-radius: 8px; 
      position: absolute; box-shadow: 0 4px 8px rgba(0,0,0,0.5); 
      display: flex; align-items: center; justify-content: center;
      font-size: 28px; border: 1px solid rgba(0,0,0,0.1);
      transition: all 0.5s;
    }
    
    /* MASCOT COLORS */
    .bg-nai { background: linear-gradient(135deg, #795548 0%, #5d4037 100%); border-color: #8d6e63; }
    .bg-bau { background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); border-color: #66bb6a; }
    .bg-ga  { background: linear-gradient(135deg, #ffc107 0%, #ffa000 100%); border-color: #ffd54f; }
    .bg-ca  { background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); border-color: #42a5f5; }
    .bg-cua { background: linear-gradient(135deg, #ff5722 0%, #e64a19 100%); border-color: #ff7043; }
    .bg-tom { background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); border-color: #f06292; }

    /* BETTING BUTTONS */
    .bet-btn { position: relative; transition: all 0.15s; overflow: visible; border-width: 1px; border-style: solid; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    .bet-btn:active { transform: scale(0.96); }
    .bet-btn.winner { 
      box-shadow: 0 0 0 2px #FFD700, 0 0 15px #FFD700; z-index: 10;
      animation: pulse-gold 1s infinite;
    }
    @keyframes pulse-gold { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }

    .marker { 
      position: absolute; top: -4px; right: -4px; 
      background: #fbbf24; color: black; font-weight: 900; 
      font-size: 9px; padding: 1px 5px; border-radius: 99px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 20;
      min-width: 18px;
    }

    /* CHIPS */
    .chip { 
      width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-weight: 900; font-size: 9px; cursor: pointer; border: 2px dashed rgba(255,255,255,0.4);
      transition: transform 0.2s; position: relative;
    }
    .chip.active { transform: translateY(-5px) scale(1.1); border-style: solid; border-color: #fbbf24; box-shadow: 0 8px 20px rgba(0,0,0,0.5); }
    .bg-1k { background: #64748b; } .bg-5k { background: #3b82f6; } .bg-10k { background: #ef4444; }
    .bg-50k { background: #a855f7; } .bg-100k { background: #f59e0b; color: black; } .bg-500k { background: #10b981; color: black; }

    /* ROADMAP */
    .road-col { display: flex; flex-direction: column; gap: 1px; }
    .road-icon { font-size: 9px; line-height: 1; }

    /* MODAL */
    .modal-overlay { 
      position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100;
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
      display: flex; align-items: center; justify-content: center;
    }
    .modal-overlay.show { opacity: 1; pointer-events: auto; }
    .modal-content { transform: scale(0.8); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .modal-overlay.show .modal-content { transform: scale(1); }

    /* SAFE AREA PADDING UTILITY */
    .pb-safe { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; display: inline-block; }
    .status-dot.online { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
  </style>
</head>
<body class="flex flex-col">

  <!-- HEADER -->
  <header class="h-12 bg-slate-900/90 border-b border-white/5 flex items-center justify-between px-3 fixed top-0 w-full z-50 shrink-0">
    <div class="flex items-center gap-2">
      <a href="games.html" class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-slate-400 border border-white/10 active:bg-slate-700">
        <i class="fa-solid fa-chevron-left text-sm"></i>
      </a>
      <div>
        <div class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">Global Table</div>
        <div class="flex items-center gap-1.5 font-oswald text-base leading-none">
          <span class="text-white">B·∫¶U CUA</span>
          <span class="text-gold font-bold">VIP</span>
        </div>
      </div>
    </div>
    <div class="text-right">
      <div class="text-[9px] text-slate-500 font-bold" id="user-id">ID: ...</div>
      <div class="flex items-center gap-2 bg-slate-800/50 px-2.5 py-0.5 rounded-full border border-white/5 mt-0.5">
        <span id="conn-dot" class="status-dot"></span>
        <i class="fa-solid fa-wallet text-gold text-[10px]"></i>
        <span id="balance" class="font-oswald text-sm text-white">---</span>
      </div>
    </div>
  </header>

  <!-- MAIN AREA -->
  <main class="flex-1 mt-12 flex flex-col relative w-full overflow-hidden">
    
    <!-- STATUS BAR -->
    <div class="h-8 flex items-center justify-center px-4 z-30 mt-2 shrink-0">
      <div class="glass px-4 py-0.5 rounded-full flex items-center gap-3 border border-emerald-500/20 shadow-lg">
        <span id="status-txt" class="text-[9px] font-black text-emerald-300 uppercase tracking-widest">ƒêANG C∆Ø·ª¢C</span>
        <span class="w-[1px] h-2 bg-white/10"></span>
        <span id="timer" class="font-oswald font-bold text-base text-white">--</span>
      </div>
    </div>

    <!-- GAME TABLE -->
    <div class="flex-1 flex items-center justify-center -mt-4 relative">
      <div class="plate-container">
        <div class="plate">
          <div id="dice-container" class="absolute inset-0 z-10"></div>
        </div>
        <div id="bowl" class="bowl">
          <div class="text-6xl opacity-10"><i class="fa-solid fa-dragon"></i></div>
        </div>
      </div>
    </div>

    <!-- CONTROL PANEL - FIXED BOTTOM & SAFE AREA -->
    <div class="glass rounded-t-[2rem] border-t border-white/10 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] z-40 relative pb-safe">
      
      <!-- ROADMAP -->
      <div class="px-4 py-1.5 border-b border-white/5 flex items-center justify-between mb-2 bg-black/20 rounded-t-[2rem]">
        <span class="text-[9px] text-slate-400 font-bold uppercase tracking-wider"><i class="fa-solid fa-clock-rotate-left mr-1"></i> L·ªãch s·ª≠</span>
        <div id="roadmap" class="flex items-center gap-1.5 overflow-hidden justify-end h-7"></div>
      </div>

      <div class="px-3 space-y-2">
        <!-- BETTING GRID (Reduced height for mobile) -->
        <div class="grid grid-cols-3 gap-1.5">
          <!-- H√†ng 1 -->
          <button class="bet-btn bg-nai rounded-xl h-16 flex flex-col items-center justify-center relative group" onclick="game.placeBet(0)">
            <div class="text-xl drop-shadow-md">ü¶å</div>
            <span class="text-[9px] font-bold text-white/90 uppercase mt-0.5 drop-shadow">NAI</span>
            <div id="badge-0" class="marker hidden">0</div>
          </button>
          <button class="bet-btn bg-bau rounded-xl h-16 flex flex-col items-center justify-center relative group" onclick="game.placeBet(1)">
            <div class="text-xl drop-shadow-md">üéÉ</div>
            <span class="text-[9px] font-bold text-white/90 uppercase mt-0.5 drop-shadow">B·∫¶U</span>
            <div id="badge-1" class="marker hidden">0</div>
          </button>
          <button class="bet-btn bg-ga rounded-xl h-16 flex flex-col items-center justify-center relative group" onclick="game.placeBet(2)">
            <div class="text-xl drop-shadow-md">üêì</div>
            <span class="text-[9px] font-bold text-white/90 uppercase mt-0.5 drop-shadow">G√Ä</span>
            <div id="badge-2" class="marker hidden">0</div>
          </button>

          <!-- H√†ng 2 -->
          <button class="bet-btn bg-ca rounded-xl h-16 flex flex-col items-center justify-center relative group" onclick="game.placeBet(3)">
            <div class="text-xl drop-shadow-md">üêü</div>
            <span class="text-[9px] font-bold text-white/90 uppercase mt-0.5 drop-shadow">C√Å</span>
            <div id="badge-3" class="marker hidden">0</div>
          </button>
          <button class="bet-btn bg-cua rounded-xl h-16 flex flex-col items-center justify-center relative group" onclick="game.placeBet(4)">
            <div class="text-xl drop-shadow-md">ü¶Ä</div>
            <span class="text-[9px] font-bold text-white/90 uppercase mt-0.5 drop-shadow">CUA</span>
            <div id="badge-4" class="marker hidden">0</div>
          </button>
          <button class="bet-btn bg-tom rounded-xl h-16 flex flex-col items-center justify-center relative group" onclick="game.placeBet(5)">
            <div class="text-xl drop-shadow-md">ü¶ê</div>
            <span class="text-[9px] font-bold text-white/90 uppercase mt-0.5 drop-shadow">T√îM</span>
            <div id="badge-5" class="marker hidden">0</div>
          </button>
        </div>

        <!-- CHIPS -->
        <div class="flex justify-between items-center py-1 overflow-x-auto gap-2 scrollbar-hide">
          <div class="chip bg-1k" onclick="game.setChip(1000, this)">1k</div>
          <div class="chip bg-5k" onclick="game.setChip(5000, this)">5k</div>
          <div class="chip bg-10k active" onclick="game.setChip(10000, this)">10k</div>
          <div class="chip bg-50k" onclick="game.setChip(50000, this)">50k</div>
          <div class="chip bg-100k" onclick="game.setChip(100000, this)">100k</div>
          <div class="chip bg-500k" onclick="game.setChip(500000, this)">500k</div>
        </div>

        <!-- ACTIONS -->
        <div class="grid grid-cols-4 gap-2 h-10 mb-1">
          <button onclick="game.cancelBets()" class="rounded-lg bg-slate-800 border border-white/10 text-slate-400 text-[9px] font-bold uppercase active:scale-95 transition">H·ªßy</button>
          <button onclick="game.rebet()" class="rounded-lg bg-slate-700 border border-white/10 text-white text-[9px] font-bold uppercase active:scale-95 transition">C∆∞·ª£c l·∫°i</button>
          <button onclick="game.confirmBets()" class="col-span-2 rounded-lg bg-gradient-to-r from-gold-dark to-gold text-black font-black text-xs uppercase shadow-lg shadow-gold/20 active:scale-95 transition flex items-center justify-center gap-2">
            ƒê·∫∂T C∆Ø·ª¢C <i class="fa-solid fa-check"></i>
          </button>
        </div>

      </div>
    </div>
  </main>

  <!-- MODAL RESULT -->
  <div id="modal-result" class="modal-overlay">
    <div class="modal-content bg-slate-900 border-2 border-gold/30 rounded-3xl p-6 w-64 text-center shadow-2xl relative overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-gold to-transparent"></div>
      
      <div class="flex justify-center gap-2 mb-4 mt-2">
        <div id="res-d1" class="w-12 h-12 rounded-lg bg-white flex items-center justify-center text-2xl shadow-lg border border-slate-300"></div>
        <div id="res-d2" class="w-12 h-12 rounded-lg bg-white flex items-center justify-center text-2xl shadow-lg border border-slate-300"></div>
        <div id="res-d3" class="w-12 h-12 rounded-lg bg-white flex items-center justify-center text-2xl shadow-lg border border-slate-300"></div>
      </div>
      
      <div id="mod-win" class="text-xl font-black text-white mb-2"></div>
      <div class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">T·ª± ƒë·ªông ƒë√≥ng sau 5s</div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="fixed top-16 left-1/2 -translate-x-1/2 glass px-4 py-2 rounded-full flex items-center gap-2 opacity-0 pointer-events-none transition-all duration-300 z-[200] border border-white/10 shadow-xl w-max max-w-[90%]">
    <i id="toast-icon" class="fa-solid fa-info-circle text-xs"></i>
    <span id="toast-msg" class="text-[10px] font-bold text-white uppercase tracking-wider truncate">Th√¥ng b√°o</span>
  </div>

  <script>
    // ===== 1. SUPABASE CONFIGURATION =====
    const SUPABASE_URL = 'https://sfbaytcmpgceapdcdyer.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmYmF5dGNtcGdjZWFwZGNkeWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NDQ2MzYsImV4cCI6MjA4MTEyMDYzNn0.DeXO91pcCzQJHMcXTk9Eilcsk9IoGIPzOM-Ube4zRb8';
    const WALLET_TABLE = 'users';              
    const WALLET_BALANCE_COLUMN = 'balance'; 

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===== 2. GAME DATA =====
    const MASCOTS = [
      { id: 0, name: 'NAI', icon: 'ü¶å' },
      { id: 1, name: 'B·∫¶U', icon: 'üéÉ' },
      { id: 2, name: 'G√Ä', icon: 'üêì' },
      { id: 3, name: 'C√Å', icon: 'üêü' },
      { id: 4, name: 'CUA', icon: 'ü¶Ä' },
      { id: 5, name: 'T√îM', icon: 'ü¶ê' }
    ];

    const CONFIG = {
      PERIOD: 40000,
      PHASES: { SHAKE: 3000, BET: 28000, LOCK: 32000, REVEAL: 40000 },
      LIMITS: { MIN: 2000, MAX: 500000 }
    };

    // ===== 3. GAME LOGIC =====
    const app = {
      user: null, 
      realtimeChannel: null,
      showToast: (msg, type='info') => {
        const t = document.getElementById("toast");
        const i = document.getElementById("toast-icon");
        document.getElementById("toast-msg").innerText = msg;
        if (type === 'error') i.className = "fa-solid fa-circle-xmark text-red-500 text-xs"; 
        else if (type === 'success') i.className = "fa-solid fa-circle-check text-green-500 text-xs"; 
        else i.className = "fa-solid fa-info-circle text-blue-500 text-xs"; 
        t.classList.remove("opacity-0", "pointer-events-none");
        setTimeout(() => t.classList.add("opacity-0", "pointer-events-none"), 3000);
      }
    };

    const game = {
      roundId: 0,
      phase: 'WAIT',
      resolved: false,
      modalTimeout: null,
      
      bets: {
        pending: [0,0,0,0,0,0],
        confirmed: [0,0,0,0,0,0],
        lastRound: null
      },
      currentChip: 10000,

      // --- INIT ---
      init: async () => {
        const uid = localStorage.getItem("my_wallet_uid");
        if (!uid) {
          alert("Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");
          window.location.href = "index.html";
          return;
        }

        app.user = { id: uid, balance: 0 };
        document.getElementById("user-id").innerText = "ID: " + uid.substring(0, 8).toUpperCase();
        document.getElementById("conn-dot").classList.add("online");

        await game.loadBalance();
        game.setupRealtimeBalance();
        
        const now = Date.now();
        game.roundId = Math.floor(now / CONFIG.PERIOD); 
        
        await game.checkPendingState();
        game.renderRoadmap();
        
        game.loop();
        setInterval(game.loop, 100);
      },

      // --- DATA SYNC ---
      loadBalance: async () => {
        try {
          const { data } = await supabaseClient.from(WALLET_TABLE).select(WALLET_BALANCE_COLUMN).eq('id', app.user.id).maybeSingle();
          if (!data) { await supabaseClient.from(WALLET_TABLE).insert({ id: app.user.id, balance: 0 }); app.user.balance = 0; } 
          else { app.user.balance = data[WALLET_BALANCE_COLUMN] || 0; }
          game.updateBalanceUI();
        } catch (e) {}
      },

      setupRealtimeBalance: () => {
        if (!app.user) return;
        if (app.realtimeChannel) supabaseClient.removeChannel(app.realtimeChannel);
        app.realtimeChannel = supabaseClient.channel('wallet-changes')
          .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: WALLET_TABLE, filter: `id=eq.${app.user.id}` },
            (payload) => {
              const newBal = payload.new[WALLET_BALANCE_COLUMN];
              if (newBal !== undefined && newBal !== app.user.balance) {
                app.user.balance = newBal;
                game.updateBalanceUI();
              }
            }
          ).subscribe();
      },

      syncBalance: async () => {
        if (!app.user) return;
        await supabaseClient.from(WALLET_TABLE).update({ [WALLET_BALANCE_COLUMN]: app.user.balance }).eq('id', app.user.id);
      },

      updateBalanceUI: () => {
        const b = app.user.balance;
        const fmt = b >= 1000000 ? (b/1000000).toFixed(2)+'M' : (b >= 1000 ? (b/1000).toFixed(0)+'k' : b.toLocaleString());
        document.getElementById("balance").innerText = fmt;
      },

      // --- STORAGE STATE ---
      savePendingState: () => {
        const data = { roundId: game.roundId, bets: game.bets.confirmed };
        localStorage.setItem("bc_pending_bet", JSON.stringify(data));
      },
      clearPendingState: () => { localStorage.removeItem("bc_pending_bet"); },
      checkPendingState: async () => {
        const raw = localStorage.getItem("bc_pending_bet");
        if (!raw) return;
        try {
            const data = JSON.parse(raw);
            const now = Date.now();
            const currentRound = Math.floor(now / CONFIG.PERIOD);

            if (data.roundId < currentRound) {
                const res = game.getResult(data.roundId);
                let totalWin = 0;
                const counts = [0,0,0,0,0,0];
                res.dice.forEach(d => counts[d]++);

                data.bets.forEach((betAmt, mascotId) => {
                    if (betAmt > 0 && counts[mascotId] > 0) {
                        totalWin += betAmt + (betAmt * counts[mascotId]);
                    }
                });

                if (totalWin > 0) {
                    app.user.balance += totalWin;
                    await game.syncBalance();
                    app.showToast(`B·∫°n th·∫Øng ${totalWin.toLocaleString()} v√°n tr∆∞·ªõc!`, 'success');
                }
                game.clearPendingState();
            } else if (data.roundId === currentRound) {
                game.roundId = currentRound;
                game.bets.confirmed = data.bets;
                game.updateBadges();
            }
        } catch (e) { console.error(e); }
      },

      // --- CORE LOOP ---
      loop: () => {
        const now = Date.now();
        const rid = Math.floor(now / CONFIG.PERIOD);
        const cyc = now % CONFIG.PERIOD;
        
        if (rid !== game.roundId) game.newRound(rid);

        const tm = document.getElementById("timer");
        const st = document.getElementById("status-txt");
        const bowl = document.getElementById("bowl");

        if (cyc < CONFIG.PHASES.SHAKE) {
          game.setPhase('SHAKE');
          st.innerText = "ƒêANG L·∫ÆC"; st.className = "text-[9px] font-black text-blue-300 uppercase tracking-widest";
          tm.innerText = "";
          bowl.classList.add("shaking"); bowl.classList.remove("open");
        } else if (cyc < CONFIG.PHASES.BET) {
          game.setPhase('BET');
          st.innerText = "ƒê·∫∂T C∆Ø·ª¢C"; st.className = "text-[9px] font-black text-emerald-300 uppercase tracking-widest";
          const left = Math.ceil((CONFIG.PHASES.BET - cyc)/1000);
          tm.innerText = left;
          bowl.classList.remove("shaking");
        } else if (cyc < CONFIG.PHASES.LOCK) {
          game.setPhase('LOCK');
          st.innerText = "CH·ªú M·ªû"; st.className = "text-[9px] font-black text-rose-300 uppercase tracking-widest";
          tm.innerText = "--";
          bowl.classList.remove("shaking");
        } else {
          game.setPhase('REVEAL');
          st.innerText = "K·∫æT QU·∫¢"; st.className = "text-[9px] font-black text-gold uppercase tracking-widest";
          
          if (!game.resolved) {
            game.resolved = true;
            const res = game.getResult(rid);
            game.renderDice(res.dice);
            setTimeout(() => {
              bowl.classList.add("open");
              game.highlightWin(res.dice);
              game.payout(res);
              game.addRoadmap(res); 
            }, 500);
          }
        }
      },

      setPhase: (p) => {
        if (game.phase !== p) {
          game.phase = p;
          if (p === 'BET') {
             document.querySelectorAll('.bet-btn').forEach(b => b.classList.remove('winner', 'disabled'));
             game.updateBadges();
          } else if (p === 'LOCK') {
             document.querySelectorAll('.bet-btn').forEach(b => b.classList.add('disabled'));
          }
        }
      },

      newRound: (id) => {
        game.roundId = id;
        game.resolved = false;
        
        let hasBet = false;
        if(game.bets.confirmed.some(b => b > 0)) hasBet = true;
        if (hasBet) game.bets.lastRound = [...game.bets.confirmed];

        game.bets.pending = [0,0,0,0,0,0];
        game.bets.confirmed = [0,0,0,0,0,0];
        
        game.updateBadges();
        document.getElementById("dice-container").innerHTML = "";
        document.getElementById("bowl").classList.remove("open", "shaking");
        document.getElementById("modal-result").classList.remove("show");
        
        game.clearPendingState();
        game.renderRoadmap();
      },

      // --- BETTING UI ---
      setChip: (val, el) => {
        game.currentChip = val;
        document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
        el.classList.add("active");
      },

      placeBet: (idx) => {
        if (game.phase !== 'BET') return app.showToast("Ch∆∞a ƒë·∫øn gi·ªù c∆∞·ª£c!", "error");
        
        const currentTotal = game.bets.pending[idx] + game.bets.confirmed[idx];
        if (currentTotal + game.currentChip > CONFIG.LIMITS.MAX) {
            return app.showToast(`C∆∞·ª£c t·ªëi ƒëa ${CONFIG.LIMITS.MAX.toLocaleString()}!`, "error");
        }

        const totalPending = game.bets.pending.reduce((a,b)=>a+b,0);
        if (totalPending + game.currentChip > app.user.balance) return app.showToast("S·ªë d∆∞ kh√¥ng ƒë·ªß!", "error");

        game.bets.pending[idx] += game.currentChip;
        game.updateBadges();
      },

      cancelBets: () => {
        game.bets.pending = [0,0,0,0,0,0];
        game.updateBadges();
        app.showToast("ƒê√£ h·ªßy c∆∞·ª£c ch·ªù");
      },

      rebet: () => {
        if (game.phase !== 'BET') return app.showToast("Ch∆∞a ƒë·∫øn gi·ªù c∆∞·ª£c!", "error");
        if (!game.bets.lastRound) return app.showToast("Kh√¥ng c√≥ l·ªãch s·ª≠ c∆∞·ª£c!", "error");

        for (let i=0; i<6; i++) {
           const oldVal = game.bets.lastRound[i];
           if (oldVal > 0) {
               const cur = game.bets.pending[i] + game.bets.confirmed[i];
               if (cur + oldVal <= CONFIG.LIMITS.MAX) {
                   game.bets.pending[i] += oldVal;
               }
           }
        }
        game.updateBadges();
        app.showToast("ƒê√£ ch·ªçn l·∫°i c∆∞·ª£c c≈©");
      },

      confirmBets: async () => {
        if (game.phase !== 'BET') return app.showToast("H·∫øt gi·ªù c∆∞·ª£c!", "error");
        
        const total = game.bets.pending.reduce((a,b)=>a+b,0);
        if (total === 0) return;

        // Check Min
        for (let i=0; i<6; i++) {
            if (game.bets.pending[i] > 0) {
                const finalAmt = game.bets.pending[i] + game.bets.confirmed[i];
                if (finalAmt < CONFIG.LIMITS.MIN) {
                    return app.showToast(`C∆∞·ª£c t·ªëi thi·ªÉu ${CONFIG.LIMITS.MIN.toLocaleString()}!`, "error");
                }
            }
        }

        if (total > app.user.balance) return app.showToast("S·ªë d∆∞ kh√¥ng ƒë·ªß!", "error");

        app.user.balance -= total;
        game.updateBalanceUI();
        
        for (let i=0; i<6; i++) {
          game.bets.confirmed[i] += game.bets.pending[i];
          game.bets.pending[i] = 0;
        }
        game.updateBadges();
        
        await game.syncBalance();
        game.savePendingState(); 
        app.showToast("ƒê·∫∑t c∆∞·ª£c th√†nh c√¥ng!", "success");
      },

      updateBadges: () => {
        for (let i=0; i<6; i++) {
          const t = game.bets.pending[i] + game.bets.confirmed[i];
          const el = document.getElementById(`badge-${i}`);
          if (t > 0) {
            el.classList.remove("hidden");
            el.innerText = t >= 1000 ? (t/1000).toFixed(0)+'k' : t;
          } else {
            el.classList.add("hidden");
          }
        }
      },

      // --- RESULT & PAYOUT ---
      getResult: (id) => {
        const rng = (seed) => {
          let t = seed += 0x6D2B79F5;
          t = Math.imul(t ^ t >>> 15, t | 1);
          t ^= t + Math.imul(t ^ t >>> 7, t | 61);
          return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }
        const dice = [];
        for(let i=0; i<3; i++) {
            dice.push(Math.floor(rng(id*100 + i) * 6));
        }
        return { dice };
      },

      renderDice: (dice) => {
        const c = document.getElementById("dice-container");
        c.innerHTML = "";
        const pos = [{x:90,y:80}, {x:60,y:130}, {x:120,y:130}]; // Adjusted for scale
        
        dice.forEach((dId, i) => {
          const d = document.createElement("div");
          d.className = `dice`;
          d.innerText = MASCOTS[dId].icon;
          const rx = (Math.random()-0.5)*15;
          const ry = (Math.random()-0.5)*15;
          d.style.left = (pos[i].x + rx) + "px";
          d.style.top = (pos[i].y + ry) + "px";
          d.style.transform = `rotate(${Math.random()*360}deg)`;
          c.appendChild(d);
        });
      },

      highlightWin: (dice) => {
        const hits = new Set(dice);
        hits.forEach(id => {
           const b = document.querySelector(`[onclick="game.placeBet(${id})"]`);
           if(b) b.classList.add('winner');
        });
      },

      payout: async (res) => {
        const counts = [0,0,0,0,0,0];
        res.dice.forEach(d => counts[d]++);
        
        let totalWin = 0;
        let played = false;

        game.bets.confirmed.forEach((amt, idx) => {
            if (amt > 0) {
                played = true;
                if (counts[idx] > 0) {
                    totalWin += amt + (amt * counts[idx]);
                }
            }
        });

        if (played) {
            if (totalWin > 0) {
                app.user.balance += totalWin;
                await game.syncBalance();
                game.showModal(res.dice, totalWin);
            } else {
                game.showModal(res.dice, 0);
            }
            game.clearPendingState();
        }
      },

      showModal: (diceIds, win) => {
        const modal = document.getElementById("modal-result");
        
        document.getElementById("res-d1").innerText = MASCOTS[diceIds[0]].icon;
        document.getElementById("res-d2").innerText = MASCOTS[diceIds[1]].icon;
        document.getElementById("res-d3").innerText = MASCOTS[diceIds[2]].icon;

        const wEl = document.getElementById("mod-win");
        if (win > 0) {
           wEl.innerText = "+" + win.toLocaleString();
           wEl.className = "text-2xl font-black text-green-400 animate-bounce";
        } else {
           wEl.innerText = "CH√öC MAY M·∫ÆN";
           wEl.className = "text-lg font-bold text-slate-500";
        }

        modal.classList.add("show");
        if (game.modalTimeout) clearTimeout(game.modalTimeout);
        game.modalTimeout = setTimeout(() => {
           modal.classList.remove("show");
        }, 5000);
      },

      renderRoadmap: () => {
        const rm = document.getElementById("roadmap");
        rm.innerHTML = "";
        for(let i=12; i>0; i--) {
            if (game.roundId - i >= 0) {
                game.addRoadmap(game.getResult(game.roundId - i));
            }
        }
      },

      addRoadmap: (res) => {
        const rm = document.getElementById("roadmap");
        const col = document.createElement("div");
        col.className = "road-col";
        res.dice.forEach(dId => {
            const sp = document.createElement("span");
            sp.className = "road-icon";
            sp.innerText = MASCOTS[dId].icon;
            col.appendChild(sp);
        });
        rm.appendChild(col);
        if(rm.children.length > 15) rm.removeChild(rm.firstChild);
      }
    };

    window.onload = game.init;
  </script>
</body>
</html>

