<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Crypto Candles VIP - HC88</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;500;700;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
  <!-- SUPABASE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- CANVAS CONFETTI -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 
            oswald: ['Oswald', 'sans-serif'], 
            roboto: ['Roboto', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace']
          },
          colors: { 
            gold: '#FACC15', 
            up: '#0ecb81',     // Green
            down: '#f6465d',   // Red
            dark: '#161a1e',
            card: '#1e2329'
          }
        }
      }
    }
  </script>

  <style>
    /* CORE SETUP */
    body {
      background-color: #161a1e;
      color: #eaecef; overflow: hidden; touch-action: manipulation; user-select: none;
      -webkit-tap-highlight-color: transparent; font-family: 'Roboto', sans-serif;
      height: 100vh; height: 100dvh;
      display: flex; flex-direction: column;
    }
    
    /* CHART AREA (Fixed Height) */
    #chart-container {
      flex: 1; /* Chi·∫øm ph·∫ßn l·ªõn m√†n h√¨nh */
      width: 100%;
      position: relative;
      background: #161a1e;
      border-bottom: 1px solid #2b3139;
    }
    canvas { display: block; width: 100%; height: 100%; }

    /* CONTROLS (Fixed Bottom) */
    #controls-container {
      height: auto;
      background: #1e2329;
      display: flex; flex-direction: column;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
      box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
      z-index: 50;
    }

    /* BUTTONS */
    .btn-action {
      position: relative; overflow: hidden; transition: all 0.1s;
      border-radius: 12px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .btn-action:active { transform: scale(0.96); }
    
    .btn-up { background: rgba(14,203,129,0.1); border-color: rgba(14,203,129,0.3); color: #0ecb81; }
    .btn-up.selected { background: #0ecb81; color: #fff; box-shadow: 0 0 20px rgba(14,203,129,0.4); }
    
    .btn-down { background: rgba(246,70,93,0.1); border-color: rgba(246,70,93,0.3); color: #f6465d; }
    .btn-down.selected { background: #f6465d; color: #fff; box-shadow: 0 0 20px rgba(246,70,93,0.4); }

    .btn-action.disabled { opacity: 0.3; pointer-events: none; filter: grayscale(1); }

    /* CHIPS */
    .chip { 
      height: 32px; min-width: 50px; padding: 0 10px; border-radius: 6px; 
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 10px; cursor: pointer; 
      background: #2b3139; color: #848e9c; 
      transition: all 0.2s; white-space: nowrap;
    }
    .chip.active { 
      background: #FACC15; color: #1e2329;
      font-weight: 900;
    }
    
    /* CANCEL BUTTON */
    .btn-cancel {
        height: 32px; padding: 0 12px; border-radius: 6px;
        background: #363c45; color: #fff; font-weight: bold; font-size: 10px;
        display: flex; align-items: center; justify-content: center;
        border: 1px solid rgba(255,255,255,0.1);
        margin-right: 8px;
    }
    .btn-cancel:active { background: #4a5059; }

    /* ROADMAP DOTS */
    .dot { width: 8px; height: 8px; border-radius: 2px; flex-shrink: 0; }
    .dot.U { background: #0ecb81; box-shadow: 0 0 4px rgba(14,203,129,0.5); }
    .dot.D { background: #f6465d; box-shadow: 0 0 4px rgba(246,70,93,0.5); }

    /* GRID BG */
    .grid-bg {
      background-image: 
        linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 40px 40px;
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="h-12 flex items-center justify-between px-4 shrink-0 bg-[#161a1e] border-b border-[#2b3139] z-50">
    <div class="flex items-center gap-3">
      <a href="games.html" class="w-8 h-8 rounded-lg bg-[#2b3139] flex items-center justify-center text-[#848e9c] active:scale-95">
        <i class="fa-solid fa-chevron-left text-xs"></i>
      </a>
      <div class="flex items-center gap-2">
        <i class="fa-brands fa-bitcoin text-[#F7931A] text-lg"></i>
        <div>
          <div class="font-bold text-sm text-white leading-none">BTC/USDT</div>
          <div class="text-[10px] text-[#848e9c] font-bold">Candles VIP</div>
        </div>
      </div>
    </div>
    
    <div class="text-right">
      <div class="flex items-center gap-1.5 bg-[#2b3139] px-2 py-0.5 rounded border border-white/5">
        <span id="balance" class="font-mono text-sm text-white font-bold">---</span>
        <span class="text-gold text-[10px] font-black">$</span>
      </div>
    </div>
  </header>

  <!-- PROGRESS BAR -->
  <div class="w-full bg-[#2b3139] h-1 shrink-0">
    <div id="phase-bar" class="h-full bg-up w-full transition-all duration-1000 ease-linear"></div>
  </div>

  <!-- CHART AREA -->
  <div id="chart-container" class="grid-bg">
    
    <!-- LIVE PRICE -->
    <div class="absolute top-4 left-4 z-10 pointer-events-none">
      <div id="live-price" class="font-mono text-4xl font-bold tracking-tighter text-up drop-shadow-md">--.--</div>
      <div id="price-change" class="text-[10px] font-bold text-up flex items-center gap-1 mt-1">
        <i class="fa-solid fa-caret-up"></i> <span>0.00%</span>
      </div>
    </div>

    <!-- TIMER & PHASE -->
    <div class="absolute top-4 right-4 z-10 text-right pointer-events-none">
      <div id="phase-badge" class="inline-block px-2 py-0.5 rounded bg-up/20 text-up text-[10px] font-bold uppercase mb-1 backdrop-blur border border-up/30">
        ƒê·∫∂T L·ªÜNH
      </div>
      <div class="font-oswald text-4xl font-bold text-white drop-shadow-md" id="timer-display">15</div>
    </div>

    <!-- CANVAS -->
    <canvas id="candle-chart"></canvas>

    <!-- LOCK INFO (Hidden) -->
    <div id="lock-overlay" class="absolute inset-0 z-0 pointer-events-none hidden">
      <div class="absolute top-1/2 left-0 w-full border-t border-dashed border-[#FACC15] opacity-50"></div>
      <div class="absolute top-1/2 right-2 -translate-y-1/2 bg-[#FACC15] text-black text-[10px] font-mono font-bold px-1 rounded">
        LOCK: <span id="lock-price-val"></span>
      </div>
    </div>

  </div>

  <!-- CONTROLS -->
  <div id="controls-container">
    
    <!-- ROADMAP (L·ªãch s·ª≠) -->
    <div class="px-3 py-1.5 border-b border-[#2b3139] flex items-center justify-between bg-[#161a1e]">
      <span class="text-[9px] font-bold text-[#848e9c] uppercase">K·∫øt qu·∫£ g·∫ßn ƒë√¢y</span>
      <div id="roadmap" class="flex items-center gap-1 overflow-hidden justify-end">
        <!-- Dots injected here -->
      </div>
    </div>

    <!-- CHIP SELECTOR & CANCEL -->
    <div class="py-2 px-3 overflow-x-auto no-scrollbar flex items-center gap-2 border-b border-[#2b3139]">
      <button onclick="game.cancelBet()" class="btn-cancel shrink-0 active:scale-95 transition">
        <i class="fa-solid fa-rotate-left mr-1"></i> H·ª¶Y
      </button>
      <div class="w-[1px] h-6 bg-[#2b3139] mx-1"></div>
      <div class="chip" onclick="game.setChip(2000)">2k</div>
      <div class="chip active" onclick="game.setChip(10000)">10k</div>
      <div class="chip" onclick="game.setChip(50000)">50k</div>
      <div class="chip" onclick="game.setChip(100000)">100k</div>
      <div class="chip" onclick="game.setChip(500000)">500k</div>
    </div>

    <!-- BET BUTTONS -->
    <div class="p-3 grid grid-cols-2 gap-3 h-24">
      
      <!-- UP BUTTON -->
      <button id="btn-up" class="btn-action btn-up h-full group" onclick="game.placeBet('UP')">
        <div class="flex flex-col items-center gap-0.5">
          <i class="fa-solid fa-arrow-trend-up text-xl mb-0.5"></i>
          <span class="font-oswald text-xl font-bold">MUA</span>
          <span class="text-[9px] opacity-80 font-mono">1.95x</span>
        </div>
        <!-- Badge -->
        <div id="badge-UP" class="absolute top-2 right-2 bg-black/40 text-white text-[9px] px-1.5 py-0.5 rounded hidden font-mono"></div>
      </button>

      <!-- DOWN BUTTON -->
      <button id="btn-down" class="btn-action btn-down h-full group" onclick="game.placeBet('DOWN')">
        <div class="flex flex-col items-center gap-0.5">
          <i class="fa-solid fa-arrow-trend-down text-xl mb-0.5"></i>
          <span class="font-oswald text-xl font-bold">B√ÅN</span>
          <span class="text-[9px] opacity-80 font-mono">1.95x</span>
        </div>
        <div id="badge-DOWN" class="absolute top-2 right-2 bg-black/40 text-white text-[9px] px-1.5 py-0.5 rounded hidden font-mono"></div>
      </button>

    </div>
  </div>

  <!-- RESULT MODAL -->
  <div id="modal-overlay" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300">
    <div id="modal-content" class="bg-[#1e2329] border border-white/10 rounded-2xl p-6 w-64 text-center transform scale-90 transition-transform duration-300 shadow-2xl relative">
      <div class="absolute -top-10 left-1/2 -translate-x-1/2 w-20 h-20 bg-white/10 blur-xl rounded-full"></div>
      <div id="modal-icon" class="text-6xl mb-3 drop-shadow-xl"></div>
      <div id="modal-title" class="text-2xl font-oswald font-bold uppercase mb-1"></div>
      <div id="modal-amount" class="font-mono text-xl font-bold"></div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-[#1e2329]/95 backdrop-blur border border-white/10 px-4 py-2 rounded-full flex items-center gap-2 opacity-0 pointer-events-none transition-all duration-300 z-[200] shadow-xl w-max max-w-[90%]">
    <i id="toast-icon" class="fa-solid fa-info-circle text-xs"></i>
    <span id="toast-msg" class="text-[10px] font-bold text-white uppercase tracking-wider">Th√¥ng b√°o</span>
  </div>

  <script>
    // ===== 1. C·∫§U H√åNH =====
    const CONFIG = {
      PHASE_BET: 15,    // 15 gi√¢y C∆∞·ª£c
      PHASE_WAIT: 15,   // 15 gi√¢y ƒê·ª£i
      ODDS: 1.95,
      CANDLE_WIDTH: 15, 
      CANDLE_GAP: 5,    
    };

    const SUPABASE_URL = 'https://sfbaytcmpgceapdcdyer.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmYmF5dGNtcGdjZWFwZGNkeWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NDQ2MzYsImV4cCI6MjA4MTEyMDYzNn0.DeXO91pcCzQJHMcXTk9Eilcsk9IoGIPzOM-Ube4zRb8';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===== 2. APP STATE =====
    const app = {
      user: null, balance: 0,
      showToast: (msg, type='info') => {
        const t = document.getElementById("toast");
        const i = document.getElementById("toast-icon");
        document.getElementById("toast-msg").innerText = msg;
        if (type === 'error') { i.className = "fa-solid fa-circle-xmark text-down"; }
        else if (type === 'success') { i.className = "fa-solid fa-circle-check text-up"; }
        else { i.className = "fa-solid fa-info-circle text-gold"; }
        t.classList.remove("opacity-0", "pointer-events-none");
        setTimeout(() => t.classList.add("opacity-0", "pointer-events-none"), 3000);
      }
    };

    // ===== 3. CANDLESTICK ENGINE =====
    const chart = {
      canvas: document.getElementById('candle-chart'),
      ctx: null,
      candles: [], 
      maxCandles: 30,
      width: 0, height: 0,
      currentPrice: 96500.00,
      currentCandle: { open: 96500, close: 96500, high: 96500, low: 96500 },

      init: () => {
        chart.ctx = chart.canvas.getContext('2d');
        window.addEventListener('resize', chart.resize);
        chart.resize();
        
        let p = chart.currentPrice;
        for(let i=0; i<chart.maxCandles; i++) {
          const change = (Math.random() - 0.5) * 40;
          const open = p;
          const close = p + change;
          const high = Math.max(open, close) + Math.random() * 5;
          const low = Math.min(open, close) - Math.random() * 5;
          chart.candles.push({ open, close, high, low });
          p = close;
        }
        chart.currentPrice = p;
        chart.resetCurrentCandle();
        
        requestAnimationFrame(chart.draw);
      },

      resize: () => {
        const wrap = document.getElementById('chart-container');
        chart.width = wrap.clientWidth;
        chart.height = wrap.clientHeight;
        chart.canvas.width = chart.width * 2;
        chart.canvas.height = chart.height * 2;
        chart.ctx.scale(2, 2);
      },

      resetCurrentCandle: () => {
        chart.currentCandle = { 
          open: chart.currentPrice, close: chart.currentPrice, 
          high: chart.currentPrice, low: chart.currentPrice 
        };
      },

      tick: () => {
        const volatility = 12;
        const change = (Math.random() - 0.5) * volatility;
        chart.currentPrice += change;

        chart.currentCandle.close = chart.currentPrice;
        if (chart.currentPrice > chart.currentCandle.high) chart.currentCandle.high = chart.currentPrice;
        if (chart.currentPrice < chart.currentCandle.low) chart.currentCandle.low = chart.currentPrice;

        const el = document.getElementById('live-price');
        el.innerText = chart.currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2});
        
        const isUp = chart.currentPrice >= chart.currentCandle.open;
        el.className = isUp ? "font-mono text-4xl font-bold tracking-tighter text-up transition-colors" : "font-mono text-4xl font-bold tracking-tighter text-down transition-colors";
        
        const changeEl = document.getElementById('price-change');
        changeEl.className = isUp ? "text-[10px] font-bold text-up flex items-center gap-1 mt-1" : "text-[10px] font-bold text-down flex items-center gap-1 mt-1";
        changeEl.innerHTML = isUp ? `<i class="fa-solid fa-caret-up"></i>` : `<i class="fa-solid fa-caret-down"></i>`;
      },

      closeCandle: () => {
        chart.candles.push({ ...chart.currentCandle });
        if (chart.candles.length > chart.maxCandles) chart.candles.shift();
        chart.resetCurrentCandle();
      },

      draw: () => {
        const { ctx, width, height, candles, currentCandle } = chart;
        ctx.clearRect(0, 0, width, height);

        const allData = [...candles, currentCandle];
        let minVal = Infinity, maxVal = -Infinity;
        allData.forEach(c => {
            if(c.low < minVal) minVal = c.low;
            if(c.high > maxVal) maxVal = c.high;
        });
        const range = maxVal - minVal || 1;
        const padding = height * 0.15;
        const getY = (val) => height - padding - ((val - minVal) / range) * (height - 2*padding);

        // Grid
        ctx.beginPath();
        ctx.strokeStyle = '#2b3139';
        ctx.lineWidth = 1;
        for(let i=1; i<5; i++) {
          const y = (height/5)*i;
          ctx.moveTo(0, y); ctx.lineTo(width, y);
        }
        ctx.stroke();

        const candleW = (width / (chart.maxCandles + 2)) * 0.6;
        const spacing = width / (chart.maxCandles + 2);

        allData.forEach((c, i) => {
            const x = i * spacing + (spacing/2);
            const yOpen = getY(c.open);
            const yClose = getY(c.close);
            const yHigh = getY(c.high);
            const yLow = getY(c.low);
            
            const isGreen = c.close >= c.open;
            const color = isGreen ? '#0ecb81' : '#f6465d';

            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = 1;

            ctx.beginPath();
            ctx.moveTo(x, yHigh);
            ctx.lineTo(x, yLow);
            ctx.stroke();

            const bodyH = Math.max(Math.abs(yClose - yOpen), 1);
            const bodyY = Math.min(yOpen, yClose);
            ctx.fillRect(x - candleW/2, bodyY, candleW, bodyH);
            
            // Current Price Line
            if (i === allData.length - 1) {
                ctx.beginPath();
                ctx.setLineDash([2, 2]);
                ctx.moveTo(0, yClose);
                ctx.lineTo(width, yClose);
                ctx.stroke();
                ctx.setLineDash([]);
                
                ctx.fillStyle = color;
                ctx.fillRect(width - 50, yClose - 9, 50, 18);
                ctx.fillStyle = isGreen ? '#000' : '#fff';
                ctx.font = "bold 9px JetBrains Mono";
                ctx.fillText(c.close.toFixed(2), width - 46, yClose + 3);
            }
        });

        requestAnimationFrame(chart.draw);
      }
    };

    // ===== 4. GAME LOGIC =====
    const game = {
      phase: 'BET',
      timeLeft: CONFIG.PHASE_BET,
      lockPrice: 0,
      
      currentChip: 10000,
      betSide: null,
      betAmount: 0,
      isBetPlaced: false,
      history: [], // For roadmap
      
      timerInterval: null,

      init: async () => {
        const uid = localStorage.getItem("my_wallet_uid");
        if (!uid) { alert("Login required!"); window.location.href = "index.html"; return; }
        
        app.user = { id: uid };
        await game.loadBalance();
        game.setupRealtimeBalance();

        chart.init();
        
        setInterval(chart.tick, 400); // T·ªëc ƒë·ªô nh·∫£y gi√°
        setInterval(chart.closeCandle, 1000); // 1s/n·∫øn
        
        game.startRound();
      },

      loadBalance: async () => {
        const { data } = await supabaseClient.from('users').select('balance').eq('id', app.user.id).maybeSingle();
        if (data) { app.balance = data.balance; game.updateBalanceUI(); }
      },

      setupRealtimeBalance: () => {
        supabaseClient.channel('wallet-changes').on('postgres_changes', 
          { event: 'UPDATE', schema: 'public', table: 'users', filter: `id=eq.${app.user.id}` },
          (payload) => { app.balance = payload.new.balance; game.updateBalanceUI(); }
        ).subscribe();
      },

      updateBalanceUI: () => {
        document.getElementById("balance").innerText = app.balance.toLocaleString('en-US');
      },

      startRound: () => {
        game.phase = 'BET';
        game.timeLeft = CONFIG.PHASE_BET;
        game.lockPrice = 0;
        game.betSide = null;
        game.betAmount = 0;
        game.isBetPlaced = false;

        game.resetUI();
        
        if (game.timerInterval) clearInterval(game.timerInterval);
        game.timerInterval = setInterval(game.loop, 1000);
      },

      loop: () => {
        game.timeLeft--;
        document.getElementById('timer-display').innerText = game.timeLeft;
        
        const bar = document.getElementById('phase-bar');
        
        if (game.phase === 'BET') {
            const pct = (game.timeLeft / CONFIG.PHASE_BET) * 100;
            bar.style.width = pct + '%';
            
            if (game.timeLeft <= 0) game.switchPhaseToWait();
        } else {
            const pct = (game.timeLeft / CONFIG.PHASE_WAIT) * 100;
            bar.style.width = pct + '%';
            
            if (game.timeLeft <= 0) {
                game.processResult();
                clearInterval(game.timerInterval);
            }
        }
      },

      switchPhaseToWait: () => {
        game.phase = 'WAIT';
        game.timeLeft = CONFIG.PHASE_WAIT;
        game.lockPrice = chart.currentPrice;

        const badge = document.getElementById('phase-badge');
        badge.innerText = "CH·ªú K·∫æT QU·∫¢";
        badge.className = "inline-block px-2 py-0.5 rounded bg-down/20 text-down text-[10px] font-bold uppercase mb-1 backdrop-blur border border-down/30";
        
        const bar = document.getElementById('phase-bar');
        bar.className = "h-full bg-down w-full"; 

        document.getElementById('btn-up').classList.add('disabled');
        document.getElementById('btn-down').classList.add('disabled');
        
        const lock = document.getElementById('lock-overlay');
        lock.classList.remove('hidden');
        document.getElementById('lock-price-val').innerText = game.lockPrice.toFixed(2);
        
        app.showToast("ƒê√£ kh√≥a gi√°! ƒêang ch·ªù k·∫øt qu·∫£...", "info");
      },

      processResult: async () => {
        const result = chart.currentPrice >= game.lockPrice ? 'UP' : 'DOWN';
        
        // Add History
        game.addHistory(result);

        if (game.isBetPlaced) {
            const isWin = game.betSide === result;
            if (isWin) {
                const profit = Math.floor(game.betAmount * CONFIG.ODDS);
                app.balance += profit;
                await supabaseClient.from('users').update({ balance: app.balance }).eq('id', app.user.id);
                game.updateBalanceUI();
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                game.showModal(true, profit, result);
            } else {
                game.showModal(false, 0, result);
            }
        } else {
            app.showToast(`K·∫øt qu·∫£: ${result === 'UP' ? 'TƒÇNG' : 'GI·∫¢M'}`, 'info');
            setTimeout(game.startRound, 3000);
        }
      },

      // --- USER ACTIONS ---
      setChip: (val) => {
        if (game.phase !== 'BET') return;
        game.currentChip = val;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        const chips = document.querySelectorAll('.chip');
        chips.forEach(c => {
             if(c.innerText.includes(val >= 1000 ? (val/1000)+'k' : val)) c.classList.add('active');
        });
      },

      placeBet: async (side) => {
        if (game.phase !== 'BET') return app.showToast("ƒê√£ h·∫øt gi·ªù!", 'error');
        if (game.isBetPlaced) return app.showToast("ƒê√£ c∆∞·ª£c r·ªìi!", 'error');
        if (game.currentChip > app.balance) return app.showToast("S·ªë d∆∞ kh√¥ng ƒë·ªß", 'error');

        game.betSide = side;
        game.betAmount = game.currentChip;
        game.isBetPlaced = true;

        app.balance -= game.betAmount;
        game.updateBalanceUI();
        await supabaseClient.from('users').update({ balance: app.balance }).eq('id', app.user.id);

        const btnUp = document.getElementById('btn-up');
        const btnDown = document.getElementById('btn-down');
        
        if (side === 'UP') {
            btnUp.classList.add('selected');
            btnDown.classList.add('disabled');
            document.getElementById('badge-UP').innerText = game.betAmount.toLocaleString();
            document.getElementById('badge-UP').classList.remove('hidden');
        } else {
            btnDown.classList.add('selected');
            btnUp.classList.add('disabled');
            document.getElementById('badge-DOWN').innerText = game.betAmount.toLocaleString();
            document.getElementById('badge-DOWN').classList.remove('hidden');
        }
        app.showToast("ƒê·∫∑t c∆∞·ª£c th√†nh c√¥ng!", "success");
      },

      cancelBet: async () => {
        if (game.phase !== 'BET') return app.showToast("Kh√¥ng th·ªÉ h·ªßy l√∫c n√†y!", 'error');
        if (!game.isBetPlaced) return app.showToast("Ch∆∞a c√≥ c∆∞·ª£c n√†o!", 'info');

        // Ho√†n ti·ªÅn
        app.balance += game.betAmount;
        game.updateBalanceUI();
        await supabaseClient.from('users').update({ balance: app.balance }).eq('id', app.user.id);

        // Reset state
        game.isBetPlaced = false;
        game.betSide = null;
        game.betAmount = 0;

        // Reset UI Buttons
        document.getElementById('btn-up').classList.remove('selected', 'disabled');
        document.getElementById('btn-down').classList.remove('selected', 'disabled');
        document.getElementById('badge-UP').classList.add('hidden');
        document.getElementById('badge-DOWN').classList.add('hidden');

        app.showToast("ƒê√£ h·ªßy c∆∞·ª£c!", 'info');
      },

      // --- UI HELPERS ---
      addHistory: (res) => {
        game.history.push(res);
        if(game.history.length > 20) game.history.shift();
        
        const rm = document.getElementById('roadmap');
        rm.innerHTML = '';
        game.history.forEach(r => {
            const d = document.createElement('div');
            d.className = `dot ${r === 'UP' ? 'U' : 'D'}`;
            rm.appendChild(d);
        });
      },

      resetUI: () => {
        const btnUp = document.getElementById('btn-up');
        const btnDown = document.getElementById('btn-down');
        btnUp.className = "btn-action btn-up h-full group";
        btnDown.className = "btn-action btn-down h-full group";
        document.getElementById('badge-UP').classList.add('hidden');
        document.getElementById('badge-DOWN').classList.add('hidden');
        
        const badge = document.getElementById('phase-badge');
        badge.innerText = "ƒê·∫∂T L·ªÜNH";
        badge.className = "inline-block px-2 py-0.5 rounded bg-up/20 text-up text-[10px] font-bold uppercase mb-1 backdrop-blur border border-up/30";
        
        const bar = document.getElementById('phase-bar');
        bar.className = "h-full bg-up w-full";
        
        document.getElementById('lock-overlay').classList.add('hidden');
      },

      showModal: (isWin, amount, result) => {
        const overlay = document.getElementById('modal-overlay');
        const content = document.getElementById('modal-content');
        
        overlay.classList.remove('opacity-0', 'pointer-events-none');
        content.classList.remove('scale-90');
        content.classList.add('scale-100');
        
        const icon = document.getElementById('modal-icon');
        const title = document.getElementById('modal-title');
        const amt = document.getElementById('modal-amount');
        
        if (isWin) {
            icon.innerHTML = 'üèÜ';
            title.innerText = "TH·∫ÆNG L·ªöN";
            title.className = "text-2xl font-oswald font-bold uppercase mb-1 text-up";
            amt.innerText = "+" + amount.toLocaleString();
            amt.className = "font-mono text-xl font-bold text-up";
        } else {
            icon.innerHTML = 'üìâ';
            title.innerText = "THUA CU·ªòC";
            title.className = "text-2xl font-oswald font-bold uppercase mb-1 text-[#848e9c]";
            amt.innerText = "-" + game.betAmount.toLocaleString();
            amt.className = "font-mono text-xl font-bold text-[#848e9c]";
        }
        
        setTimeout(() => {
            overlay.classList.add('opacity-0', 'pointer-events-none');
            content.classList.add('scale-90');
            content.classList.remove('scale-100');
            game.startRound();
        }, 3000); // 3s result show
      }
    };

    window.onload = game.init;
  </script>
</body>
</html>

