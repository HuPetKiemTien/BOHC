<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Crypto Binary VIP - HC88</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;500;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <!-- SUPABASE LIBRARY -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 
            oswald: ['Oswald', 'sans-serif'], 
            roboto: ['Roboto', 'sans-serif'],
            mono: ['Share Tech Mono', 'monospace']
          },
          colors: { 
            gold: '#FFD700', 
            up: '#00ff88', 
            down: '#ff0055',
            dark: '#0b0e14'
          },
          boxShadow: { 
            'glow-up': '0 0 20px rgba(0, 255, 136, 0.4)',
            'glow-down': '0 0 20px rgba(255, 0, 85, 0.4)'
          },
          animation: {
            'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          }
        }
      }
    }
  </script>

  <style>
    /* CORE SETUP */
    body {
      background-color: #0b0e14;
      background-image: 
        linear-gradient(rgba(0, 255, 136, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 136, 0.03) 1px, transparent 1px);
      background-size: 20px 20px;
      color: white; overflow: hidden; touch-action: manipulation; user-select: none;
      -webkit-tap-highlight-color: transparent; font-family: 'Roboto', sans-serif;
      height: 100vh; height: 100dvh;
    }
    
    /* GLASS PANEL */
    .glass {
      background: rgba(20, 25, 35, 0.85); backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    /* CHART CONTAINER */
    #chart-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    canvas { display: block; width: 100%; height: 100%; }

    /* PRICE DISPLAY */
    .price-tick { transition: color 0.3s; }
    .price-up { color: #00ff88; text-shadow: 0 0 10px rgba(0,255,136,0.3); }
    .price-down { color: #ff0055; text-shadow: 0 0 10px rgba(255,0,85,0.3); }

    /* BET BUTTONS */
    .btn-trade {
      position: relative; overflow: hidden; transition: all 0.2s;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .btn-trade:active { transform: scale(0.96); }
    
    .btn-up { background: linear-gradient(180deg, rgba(0,255,136,0.1) 0%, rgba(0,255,136,0.2) 100%); border-color: #00ff88; }
    .btn-up.active-bet { box-shadow: 0 0 20px rgba(0,255,136,0.6); background: rgba(0,255,136,0.3); }
    
    .btn-down { background: linear-gradient(180deg, rgba(255,0,85,0.1) 0%, rgba(255,0,85,0.2) 100%); border-color: #ff0055; }
    .btn-down.active-bet { box-shadow: 0 0 20px rgba(255,0,85,0.6); background: rgba(255,0,85,0.3); }

    /* PROGRESS BAR */
    .progress-ring__circle {
      transition: stroke-dashoffset 1s linear;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }

    /* CHIPS */
    .chip { 
      width: 38px; height: 38px; border-radius: 50%; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 9px; cursor: pointer; 
      border: 1px solid rgba(255,255,255,0.2);
      background: #1e293b; color: #94a3b8;
      transition: all 0.2s;
    }
    .chip.active { 
      transform: translateY(-5px) scale(1.1); 
      border-color: #FFD700; color: #FFD700; background: #332f18;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }

    /* HISTORY DOTS */
    .dot { width: 6px; height: 6px; border-radius: 50%; }
    .dot-u { background: #00ff88; box-shadow: 0 0 4px #00ff88; }
    .dot-d { background: #ff0055; box-shadow: 0 0 4px #ff0055; }

    /* UI UTILS */
    .pb-safe { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #555; display: inline-block; }
    .status-dot.online { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
  </style>
</head>
<body class="flex flex-col">

  <!-- HEADER -->
  <header class="h-12 bg-[#0b0e14]/90 border-b border-white/5 flex items-center justify-between px-3 fixed top-0 w-full z-50 shrink-0 backdrop-blur-md">
    <div class="flex items-center gap-2">
      <a href="games.html" class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center text-slate-400 border border-white/5 active:bg-slate-700">
        <i class="fa-solid fa-chevron-left text-xs"></i>
      </a>
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full bg-orange-500/20 flex items-center justify-center border border-orange-500/50">
            <i class="fa-brands fa-bitcoin text-orange-500 text-lg"></i>
        </div>
        <div>
          <div class="text-[9px] text-slate-500 font-bold uppercase tracking-widest leading-none">BTC/USDT</div>
          <div class="font-oswald text-base text-white leading-none mt-0.5">BINARY <span class="text-gold text-xs align-top">VIP</span></div>
        </div>
      </div>
    </div>
    <div class="text-right">
      <div class="flex items-center gap-2 bg-slate-900 px-3 py-1 rounded border border-white/10">
        <span id="conn-dot" class="status-dot"></span>
        <span class="text-gold text-[10px]">$</span>
        <span id="balance" class="font-mono text-sm text-white font-bold">---</span>
      </div>
    </div>
  </header>

  <!-- MAIN CHART AREA -->
  <main class="flex-1 mt-12 flex flex-col relative w-full overflow-hidden">
    
    <!-- LIVE PRICE OVERLAY -->
    <div class="absolute top-4 left-4 z-20">
      <div class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">Gi√° th·ªã tr∆∞·ªùng</div>
      <div id="live-price" class="font-mono text-4xl font-bold tracking-tighter price-up">95,420.50</div>
      <div class="flex items-center gap-2 mt-1">
        <span class="px-1.5 py-0.5 rounded bg-white/5 text-[9px] text-slate-400 border border-white/5">VOL: 24M</span>
        <span id="trend-indicator" class="text-[9px] font-bold text-up flex items-center gap-1"><i class="fa-solid fa-caret-up"></i> +0.45%</span>
      </div>
    </div>

    <!-- COUNTDOWN OVERLAY -->
    <div class="absolute top-4 right-4 z-20 flex flex-col items-end">
      <div id="phase-badge" class="px-2 py-0.5 rounded bg-emerald-500/20 text-emerald-400 border border-emerald-500/50 text-[9px] font-bold uppercase tracking-widest mb-1 backdrop-blur-sm">ƒê·∫∂T C∆Ø·ª¢C</div>
      <div class="relative w-12 h-12 flex items-center justify-center">
        <svg class="w-full h-full transform -rotate-90">
          <circle cx="24" cy="24" r="20" stroke="rgba(255,255,255,0.1)" stroke-width="3" fill="none"></circle>
          <circle id="timer-ring" cx="24" cy="24" r="20" stroke="#FFD700" stroke-width="3" fill="none" stroke-dasharray="126" stroke-dashoffset="0" class="progress-ring__circle"></circle>
        </svg>
        <span id="timer-text" class="absolute font-oswald text-lg font-bold text-white">20</span>
      </div>
    </div>

    <!-- CANVAS CHART -->
    <div id="chart-wrapper" class="w-full h-full bg-[#0b0e14]">
      <canvas id="crypto-chart"></canvas>
    </div>

    <!-- LOCK LINE MARKER (Hidden by default) -->
    <div id="lock-line" class="absolute right-[20%] top-0 bottom-0 w-[1px] border-l border-dashed border-white/30 z-10 hidden flex-col justify-center items-center">
      <span class="bg-slate-800 text-[9px] px-1 py-0.5 rounded text-slate-400 border border-white/10 mt-20">Kh√≥a</span>
    </div>

  </main>

  <!-- CONTROL PANEL -->
  <div class="glass border-t border-white/10 z-40 relative pb-safe">
    
    <!-- INFO BAR -->
    <div class="flex items-center justify-between px-4 py-2 bg-black/40 border-b border-white/5">
      <div class="flex items-center gap-2">
        <span class="text-[9px] text-slate-500 font-bold uppercase">Phi√™n:</span>
        <span id="session-id" class="font-mono text-[10px] text-slate-300">#82931</span>
      </div>
      <div class="flex items-center gap-1" id="roadmap">
        <!-- History dots injected here -->
      </div>
    </div>

    <div class="p-3 space-y-3">
      
      <!-- BET BUTTONS -->
      <div class="grid grid-cols-2 gap-3 h-20">
        <!-- BUY / UP -->
        <button id="btn-up" class="btn-trade btn-up rounded-xl flex flex-col items-center justify-center gap-1 group" onclick="game.placeBet('UP')">
          <div class="flex items-center gap-2">
            <i class="fa-solid fa-arrow-trend-up text-xl text-up drop-shadow-lg"></i>
            <span class="font-oswald text-2xl text-white font-bold">MUA</span>
          </div>
          <div class="flex items-center gap-2 text-[10px] text-up/80 font-mono">
            <span>x1.95</span>
            <span id="badge-UP" class="bg-black/50 px-1.5 rounded text-white hidden">0</span>
          </div>
        </button>

        <!-- SELL / DOWN -->
        <button id="btn-down" class="btn-trade btn-down rounded-xl flex flex-col items-center justify-center gap-1 group" onclick="game.placeBet('DOWN')">
          <div class="flex items-center gap-2">
            <i class="fa-solid fa-arrow-trend-down text-xl text-down drop-shadow-lg"></i>
            <span class="font-oswald text-2xl text-white font-bold">B√ÅN</span>
          </div>
          <div class="flex items-center gap-2 text-[10px] text-down/80 font-mono">
            <span>x1.95</span>
            <span id="badge-DOWN" class="bg-black/50 px-1.5 rounded text-white hidden">0</span>
          </div>
        </button>
      </div>

      <!-- CHIPS & ACTIONS -->
      <div class="flex items-center gap-2">
        <!-- Scrollable Chips -->
        <div class="flex-1 overflow-x-auto scrollbar-hide">
          <div class="flex items-center gap-2 pr-2">
            <div class="chip" onclick="game.setChip(2000, this)">2k</div>
            <div class="chip active" onclick="game.setChip(10000, this)">10k</div>
            <div class="chip" onclick="game.setChip(50000, this)">50k</div>
            <div class="chip" onclick="game.setChip(100000, this)">100k</div>
            <div class="chip" onclick="game.setChip(500000, this)">500k</div>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <button onclick="game.cancelBets()" class="h-9 px-3 rounded bg-slate-800 border border-white/10 text-slate-400 text-[10px] font-bold uppercase active:scale-95">H·ªßy</button>
        <button onclick="game.confirmBets()" class="h-9 px-4 rounded bg-gold text-black border border-gold text-[10px] font-black uppercase active:scale-95 shadow-[0_0_15px_rgba(255,215,0,0.3)]">
          X√°c nh·∫≠n
        </button>
      </div>

    </div>
  </div>

  <!-- RESULT MODAL -->
  <div id="modal-result" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="bg-slate-900 border border-white/10 rounded-2xl p-6 w-64 text-center transform scale-90 transition-transform duration-300" id="modal-content">
      <div id="res-icon" class="text-5xl mb-3 drop-shadow-2xl"></div>
      <div id="res-title" class="text-2xl font-oswald font-bold text-white mb-1"></div>
      <div id="res-profit" class="font-mono text-lg font-bold"></div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 glass px-5 py-2.5 rounded-full flex items-center gap-3 opacity-0 pointer-events-none transition-all duration-300 z-[200] border border-white/10 shadow-2xl w-max max-w-[90%]">
    <i id="toast-icon" class="fa-solid fa-info-circle text-sm"></i>
    <span id="toast-msg" class="text-[11px] font-bold text-white uppercase tracking-wider truncate">Th√¥ng b√°o</span>
  </div>

  <script>
    // ===== 1. CONFIG & SUPABASE =====
    const SUPABASE_URL = 'https://sfbaytcmpgceapdcdyer.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmYmF5dGNtcGdjZWFwZGNkeWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NDQ2MzYsImV4cCI6MjA4MTEyMDYzNn0.DeXO91pcCzQJHMcXTk9Eilcsk9IoGIPzOM-Ube4zRb8';
    const WALLET_TABLE = 'users';              
    const WALLET_BALANCE_COLUMN = 'balance'; 

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const CONFIG = {
      ROUND_TIME: 30, // 30s total
      BET_TIME: 20,   // 20s to bet
      LIMITS: { MIN: 2000, MAX: 500000 },
      ODDS: 1.95
    };

    // ===== 2. APP STATE =====
    const app = {
      user: null, 
      balance: 0,
      realtimeChannel: null,
      
      showToast: (msg, type='info') => {
        const t = document.getElementById("toast");
        const i = document.getElementById("toast-icon");
        document.getElementById("toast-msg").innerText = msg;
        if (type === 'error') { i.className = "fa-solid fa-circle-xmark text-red-500"; }
        else if (type === 'success') { i.className = "fa-solid fa-circle-check text-green-500"; }
        else { i.className = "fa-solid fa-info-circle text-blue-500"; }
        t.classList.remove("opacity-0", "pointer-events-none");
        setTimeout(() => t.classList.add("opacity-0", "pointer-events-none"), 3000);
      }
    };

    // ===== 3. CHART & PRICE ENGINE =====
    const chart = {
      canvas: document.getElementById('crypto-chart'),
      ctx: null,
      prices: [],
      maxPoints: 100, // Number of points on screen
      currentPrice: 95420.50,
      width: 0,
      height: 0,
      
      init: () => {
        chart.ctx = chart.canvas.getContext('2d');
        window.addEventListener('resize', chart.resize);
        chart.resize();
        
        // Init dummy data
        for(let i=0; i<chart.maxPoints; i++) {
          chart.prices.push(chart.currentPrice);
        }
        requestAnimationFrame(chart.draw);
      },
      
      resize: () => {
        const wrap = document.getElementById('chart-wrapper');
        chart.width = wrap.clientWidth;
        chart.height = wrap.clientHeight;
        chart.canvas.width = chart.width * 2; // Retina
        chart.canvas.height = chart.height * 2;
        chart.ctx.scale(2, 2);
      },

      updatePrice: () => {
        // Random walk logic
        const change = (Math.random() - 0.5) * 50; 
        chart.currentPrice += change;
        
        // Push new price
        chart.prices.push(chart.currentPrice);
        if(chart.prices.length > chart.maxPoints) chart.prices.shift();
        
        // Update DOM
        const el = document.getElementById('live-price');
        el.innerText = chart.currentPrice.toFixed(2);
        
        if(change >= 0) {
            el.className = "font-mono text-4xl font-bold tracking-tighter price-up";
            document.getElementById('trend-indicator').innerHTML = `<i class="fa-solid fa-caret-up"></i> +${(Math.random()*0.5).toFixed(2)}%`;
            document.getElementById('trend-indicator').className = "text-[9px] font-bold text-up flex items-center gap-1";
        } else {
            el.className = "font-mono text-4xl font-bold tracking-tighter price-down";
            document.getElementById('trend-indicator').innerHTML = `<i class="fa-solid fa-caret-down"></i> -${(Math.random()*0.5).toFixed(2)}%`;
            document.getElementById('trend-indicator').className = "text-[9px] font-bold text-down flex items-center gap-1";
        }
      },

      draw: () => {
        const ctx = chart.ctx;
        const w = chart.width;
        const h = chart.height;
        const prices = chart.prices;

        ctx.clearRect(0, 0, w, h);

        // Calculate Scale
        const min = Math.min(...prices) - 50;
        const max = Math.max(...prices) + 50;
        const range = max - min;

        // Draw Line
        ctx.beginPath();
        const step = w / (chart.maxPoints - 1);
        
        // Gradient Fill
        const lastPrice = prices[prices.length-1];
        const prevPrice = prices[prices.length-2];
        const color = lastPrice >= prevPrice ? '#00ff88' : '#ff0055';
        
        const grad = ctx.createLinearGradient(0, 0, 0, h);
        grad.addColorStop(0, color + '40'); // Opacity hex
        grad.addColorStop(1, color + '00');

        for (let i = 0; i < prices.length; i++) {
          const x = i * step;
          const y = h - ((prices[i] - min) / range) * h;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }

        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.lineJoin = 'round';
        ctx.stroke();

        // Close path for fill
        ctx.lineTo(w, h);
        ctx.lineTo(0, h);
        ctx.fillStyle = grad;
        ctx.fill();

        // Draw Pulsing Dot at tip
        const tipX = (prices.length - 1) * step;
        const tipY = h - ((lastPrice - min) / range) * h;

        ctx.beginPath();
        ctx.arc(tipX, tipY, 4, 0, Math.PI * 2);
        ctx.fillStyle = '#fff';
        ctx.fill();
        
        // Glow
        ctx.beginPath();
        ctx.arc(tipX, tipY, 10, 0, Math.PI * 2);
        ctx.fillStyle = color + '60'; // Semi transparent
        ctx.fill();

        // Lock Line (if phase is locked)
        if (game.phase === 'LOCKED') {
           // Draw lock price line
        }

        requestAnimationFrame(chart.draw);
      }
    };

    // ===== 4. GAME LOGIC =====
    const game = {
      phase: 'BET', // BET, LOCKED, RESULT
      timeLeft: CONFIG.BET_TIME,
      lockPrice: 0,
      
      betAmount: 0,
      currentChip: 10000,
      selectedSide: null, // 'UP' or 'DOWN'
      confirmedBet: null, // { side: 'UP', amount: 1000 }
      
      timerInterval: null,

      init: async () => {
        // Auth Check
        const uid = localStorage.getItem("my_wallet_uid");
        if (!uid) { alert("Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!"); window.location.href = "index.html"; return; }
        
        app.user = { id: uid };
        await game.loadBalance();
        game.setupRealtimeBalance();
        
        chart.init();
        
        // Start Loops
        setInterval(chart.updatePrice, 1000); // Price tick
        game.startRound();
      },

      loadBalance: async () => {
        const { data } = await supabaseClient.from(WALLET_TABLE).select(WALLET_BALANCE_COLUMN).eq('id', app.user.id).maybeSingle();
        if (data) { app.balance = data.balance; game.updateBalanceUI(); }
      },

      setupRealtimeBalance: () => {
        supabaseClient.channel('wallet-changes').on('postgres_changes', 
          { event: 'UPDATE', schema: 'public', table: WALLET_TABLE, filter: `id=eq.${app.user.id}` },
          (payload) => { app.balance = payload.new.balance; game.updateBalanceUI(); }
        ).subscribe();
      },

      updateBalanceUI: () => {
        document.getElementById("balance").innerText = app.balance.toLocaleString();
      },

      startRound: () => {
        game.phase = 'BET';
        game.timeLeft = CONFIG.BET_TIME;
        game.lockPrice = 0;
        game.confirmedBet = null;
        game.selectedSide = null;
        game.betAmount = 0;
        
        game.updateUIPhase();
        game.resetBetUI();
        
        if (game.timerInterval) clearInterval(game.timerInterval);
        
        game.timerInterval = setInterval(() => {
          game.timeLeft--;
          
          // Phase Transitions
          if (game.timeLeft === (CONFIG.ROUND_TIME - CONFIG.BET_TIME)) { // e.g., at 10s left
            game.lockPhase();
          }
          
          if (game.timeLeft <= 0) {
            game.settleRound();
            // Restart after short delay
            setTimeout(game.startRound, 4000);
            clearInterval(game.timerInterval);
          }
          
          game.updateTimerUI();
        }, 1000);
      },

      lockPhase: () => {
        game.phase = 'LOCKED';
        game.lockPrice = chart.currentPrice;
        
        // Update UI
        document.getElementById('phase-badge').innerText = "ƒê√ìNG C∆Ø·ª¢C";
        document.getElementById('phase-badge').className = "px-2 py-0.5 rounded bg-rose-500/20 text-rose-400 border border-rose-500/50 text-[9px] font-bold uppercase tracking-widest mb-1";
        document.getElementById('lock-line').classList.remove('hidden');
        document.getElementById('lock-line').classList.add('flex');
        
        // Disable buttons
        document.getElementById('btn-up').classList.add('opacity-50', 'pointer-events-none');
        document.getElementById('btn-down').classList.add('opacity-50', 'pointer-events-none');
      },

      settleRound: () => {
        game.phase = 'RESULT';
        const endPrice = chart.currentPrice;
        const result = endPrice > game.lockPrice ? 'UP' : 'DOWN';
        
        // Add to history
        game.addHistory(result);

        // Calc Win/Loss
        if (game.confirmedBet) {
          if (game.confirmedBet.side === result) {
            const profit = Math.floor(game.confirmedBet.amount * CONFIG.ODDS);
            app.balance += profit;
            game.syncBalance();
            game.showResultModal(true, profit, result);
          } else {
            game.showResultModal(false, 0, result);
          }
        }
      },

      // --- BETTING LOGIC ---
      setChip: (val, el) => {
        game.currentChip = val;
        document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
        el.classList.add("active");
      },

      placeBet: (side) => {
        if (game.phase !== 'BET') return app.showToast("ƒê√£ kh√≥a c∆∞·ª£c!", "error");
        
        // Toggle side if clicking different one
        if (game.selectedSide && game.selectedSide !== side) {
           game.betAmount = 0; // Reset if switching
        }
        
        game.selectedSide = side;
        
        // Check Limits
        if (game.betAmount + game.currentChip > CONFIG.LIMITS.MAX) return app.showToast("Qu√° gi·ªõi h·∫°n c∆∞·ª£c!", "error");
        if (game.betAmount + game.currentChip > app.balance) return app.showToast("S·ªë d∆∞ kh√¥ng ƒë·ªß!", "error");
        
        game.betAmount += game.currentChip;
        
        // UI Feedback
        document.querySelectorAll('.btn-trade').forEach(b => b.classList.remove('active-bet'));
        const btn = document.getElementById(side === 'UP' ? 'btn-up' : 'btn-down');
        btn.classList.add('active-bet');
        
        document.getElementById('badge-UP').classList.add('hidden');
        document.getElementById('badge-DOWN').classList.add('hidden');
        
        const badge = document.getElementById(`badge-${side}`);
        badge.classList.remove('hidden');
        badge.innerText = game.betAmount.toLocaleString();
      },

      cancelBets: () => {
        if (game.phase !== 'BET') return;
        game.betAmount = 0;
        game.selectedSide = null;
        game.resetBetUI();
        app.showToast("ƒê√£ h·ªßy c∆∞·ª£c");
      },

      confirmBets: async () => {
        if (game.phase !== 'BET') return app.showToast("H·∫øt gi·ªù!", "error");
        if (game.betAmount === 0) return;
        if (game.betAmount < CONFIG.LIMITS.MIN) return app.showToast(`T·ªëi thi·ªÉu ${CONFIG.LIMITS.MIN}`, "error");
        
        // Deduct
        app.balance -= game.betAmount;
        game.updateBalanceUI();
        await game.syncBalance();
        
        game.confirmedBet = { side: game.selectedSide, amount: game.betAmount };
        
        // Lock UI buttons visually
        app.showToast(`ƒê√£ c∆∞·ª£c ${game.selectedSide} ${game.betAmount.toLocaleString()}`, "success");
      },

      syncBalance: async () => {
        await supabaseClient.from(WALLET_TABLE).update({ balance: app.balance }).eq('id', app.user.id);
      },

      // --- UI UPDATES ---
      updateUIPhase: () => {
        document.getElementById('phase-badge').innerText = "ƒê·∫∂T C∆Ø·ª¢C";
        document.getElementById('phase-badge').className = "px-2 py-0.5 rounded bg-emerald-500/20 text-emerald-400 border border-emerald-500/50 text-[9px] font-bold uppercase tracking-widest mb-1";
        document.getElementById('lock-line').classList.add('hidden');
        document.getElementById('lock-line').classList.remove('flex');
        document.getElementById('btn-up').classList.remove('opacity-50', 'pointer-events-none');
        document.getElementById('btn-down').classList.remove('opacity-50', 'pointer-events-none');
      },

      resetBetUI: () => {
        document.querySelectorAll('.btn-trade').forEach(b => b.classList.remove('active-bet'));
        document.getElementById('badge-UP').classList.add('hidden');
        document.getElementById('badge-DOWN').classList.add('hidden');
      },

      updateTimerUI: () => {
        const t = document.getElementById('timer-text');
        const ring = document.getElementById('timer-ring');
        
        t.innerText = game.timeLeft;
        if (game.timeLeft <= 10) t.classList.add('text-rose-500');
        else t.classList.remove('text-rose-500');
        
        // Circle progress
        const radius = 20;
        const circumference = radius * 2 * Math.PI;
        const offset = circumference - (game.timeLeft / CONFIG.ROUND_TIME) * circumference;
        ring.style.strokeDashoffset = offset;
      },

      addHistory: (res) => {
        const rm = document.getElementById("roadmap");
        const d = document.createElement("div");
        d.className = `dot ${res==='UP' ? 'dot-u' : 'dot-d'}`;
        rm.appendChild(d);
        if(rm.children.length > 15) rm.removeChild(rm.firstChild);
        
        // Random session ID
        document.getElementById('session-id').innerText = "#" + Math.floor(10000 + Math.random() * 90000);
      },

      showResultModal: (isWin, amount, res) => {
        const m = document.getElementById('modal-result');
        const c = document.getElementById('modal-content');
        const icon = document.getElementById('res-icon');
        const tit = document.getElementById('res-title');
        const prof = document.getElementById('res-profit');
        
        m.classList.remove('opacity-0', 'pointer-events-none');
        c.classList.remove('scale-90');
        c.classList.add('scale-100');
        
        if (isWin) {
          icon.innerHTML = 'ü§ë';
          tit.innerText = "TH·∫ÆNG L·ªöN";
          tit.className = "text-2xl font-oswald font-bold text-up mb-1";
          prof.innerText = "+" + amount.toLocaleString();
          prof.className = "font-mono text-lg font-bold text-up";
        } else {
          icon.innerHTML = 'üí∏';
          tit.innerText = "THUA CU·ªòC";
          tit.className = "text-2xl font-oswald font-bold text-slate-400 mb-1";
          prof.innerText = res === 'UP' ? "Gi√° TƒÇNG" : "Gi√° GI·∫¢M";
          prof.className = "font-mono text-lg font-bold text-white";
        }
        
        setTimeout(() => {
          m.classList.add('opacity-0', 'pointer-events-none');
          c.classList.add('scale-90');
          c.classList.remove('scale-100');
        }, 3000);
      }
    };

    window.onload = game.init;
  </script>
</body>
</html>

