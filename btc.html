<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>BTC Pro Trading - HC88</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;500;700;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
  <!-- SUPABASE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- CANVAS CONFETTI -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 
            oswald: ['Oswald', 'sans-serif'], 
            roboto: ['Roboto', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace']
          },
          colors: { 
            gold: '#FACC15', 
            up: '#2ebd85',     // Binance Green Standard
            down: '#f6465d',   // Binance Red Standard
            dark: '#161a1e',
            card: '#1e2329',
            line: '#2b3139'
          }
        }
      }
    }
  </script>

  <style>
    /* CORE SETUP */
    body {
      background-color: #161a1e;
      color: #eaecef; overflow: hidden; touch-action: manipulation; user-select: none;
      -webkit-tap-highlight-color: transparent; font-family: 'Roboto', sans-serif;
      height: 100vh; height: 100dvh;
      display: flex; flex-direction: column;
    }
    
    /* CHART AREA */
    #chart-container {
      flex: 1; 
      width: 100%;
      position: relative;
      background: #161a1e;
      border-bottom: 1px solid #2b3139;
      cursor: crosshair;
    }
    canvas { display: block; width: 100%; height: 100%; }

    /* BUTTONS */
    .btn-action {
      position: relative; overflow: hidden; transition: all 0.1s;
      border-radius: 12px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      border: 1px solid rgba(255,255,255,0.05);
      background: #2b3139;
    }
    .btn-action:active { transform: scale(0.98); }
    
    .btn-up { color: #2ebd85; border-color: rgba(46, 189, 133, 0.2); }
    .btn-up.selected { 
      background: rgba(46, 189, 133, 0.15); 
      border-color: #2ebd85; 
      box-shadow: inset 0 0 15px rgba(46, 189, 133, 0.2); 
    }
    
    .btn-down { color: #f6465d; border-color: rgba(246, 70, 93, 0.2); }
    .btn-down.selected { 
      background: rgba(246, 70, 93, 0.15); 
      border-color: #f6465d; 
      box-shadow: inset 0 0 15px rgba(246, 70, 93, 0.2); 
    }

    .btn-action.disabled { opacity: 0.3; pointer-events: none; filter: grayscale(1); }

    /* CHIPS */
    .chip { 
      height: 36px; min-width: 55px; padding: 0 10px; border-radius: 8px; 
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 11px; cursor: pointer; 
      background: #2b3139; color: #848e9c; 
      transition: all 0.2s; white-space: nowrap;
      border: 1px solid transparent;
    }
    .chip.active { 
      background: #FACC15; color: #1e2329; border-color: #FACC15;
      font-weight: 900; box-shadow: 0 2px 8px rgba(250, 204, 21, 0.3);
    }
    
    /* FIXED CANCEL BUTTON */
    .btn-cancel {
        height: 36px; padding: 0 16px; border-radius: 8px;
        background: #363c45; color: #fff; font-weight: bold; font-size: 11px;
        display: flex; align-items: center; justify-content: center;
        border: 1px solid rgba(255,255,255,0.1);
        white-space: nowrap;
        flex-shrink: 0;
    }
    .btn-cancel:active { background: #4a5059; }

    /* BADGE ON BUTTON */
    .bet-badge {
      background: #fff; color: #000;
      font-family: 'JetBrains Mono', monospace; font-weight: 800; font-size: 10px;
      padding: 2px 6px; border-radius: 4px;
      position: absolute; top: 8px; right: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    /* GRID BG */
    .grid-bg {
      background-image: 
        linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size: 40px 40px;
    }

    /* UTILS */
    .pb-safe { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="h-14 flex items-center justify-between px-4 shrink-0 bg-[#161a1e] border-b border-[#2b3139] z-50">
    <div class="flex items-center gap-3">
      <a href="games.html" class="w-9 h-9 rounded-xl bg-[#2b3139] flex items-center justify-center text-[#848e9c] active:scale-95 transition">
        <i class="fa-solid fa-chevron-left text-sm"></i>
      </a>
      <div class="flex items-center gap-2">
        <div class="w-9 h-9 rounded-full bg-orange-500/10 flex items-center justify-center border border-orange-500/20">
            <i class="fa-brands fa-bitcoin text-[#F7931A] text-xl"></i>
        </div>
        <div>
          <div class="font-bold text-sm text-white leading-none">BTC/USDT</div>
          <div class="text-[10px] text-[#848e9c] font-bold mt-0.5">Perpetual</div>
        </div>
      </div>
    </div>
    
    <div class="text-right">
      <div class="text-[9px] text-[#848e9c] font-bold uppercase tracking-wider mb-0.5">T√†i s·∫£n</div>
      <div class="flex items-center justify-end gap-1.5">
        <span id="balance" class="font-mono text-sm text-white font-bold">---</span>
        <span class="text-gold text-[10px] font-black">$</span>
      </div>
    </div>
  </header>

  <!-- PROGRESS BAR -->
  <div class="w-full bg-[#2b3139] h-1 shrink-0">
    <div id="phase-bar" class="h-full bg-up w-full transition-all duration-500 ease-linear"></div>
  </div>

  <!-- CHART AREA -->
  <div id="chart-container" class="grid-bg">
    
    <!-- LIVE PRICE & TIMER (Top Right) -->
    <div class="absolute top-4 right-4 z-10 text-right pointer-events-none">
      <div id="live-price" class="font-mono text-3xl font-bold tracking-tighter text-up drop-shadow-md">--.--</div>
      <div class="flex items-center justify-end gap-2 mt-1">
        <span id="phase-badge" class="px-2 py-0.5 rounded bg-up/20 text-up text-[10px] font-bold uppercase backdrop-blur border border-up/30">ƒê·∫∂T L·ªÜNH</span>
        <span class="font-oswald text-xl font-bold text-white drop-shadow-md w-8 text-center" id="timer-display">15</span>
      </div>
    </div>

    <!-- CANVAS -->
    <canvas id="candle-chart"></canvas>

    <!-- LOCK LINE LABEL (Hidden by default) -->
    <div id="lock-label" class="absolute left-1/2 -translate-x-1/2 bg-[#FACC15] text-black text-[10px] font-mono font-bold px-2 py-0.5 rounded shadow hidden z-20 pointer-events-none border border-white/20">
      LOCK: <span id="lock-price-val"></span>
    </div>

  </div>

  <!-- CONTROLS -->
  <div id="controls-container" class="bg-[#1e2329] z-50 pb-safe shadow-[0_-10px_40px_rgba(0,0,0,0.6)]">
    
    <!-- INFO BAR -->
    <div class="px-4 py-2 border-b border-[#2b3139] flex items-center justify-between bg-[#161a1e]">
      <div class="flex items-center gap-2">
        <div class="w-2 h-2 rounded-full bg-up animate-pulse"></div>
        <span class="text-[10px] font-bold text-[#848e9c] uppercase tracking-wide">Tr·ª±c ti·∫øp</span>
      </div>
      <div id="roadmap" class="flex items-center gap-1 overflow-hidden justify-end"></div>
    </div>

    <!-- CHIP SELECTOR (FIXED CANCEL BUTTON) -->
    <div class="flex items-center px-4 py-3 border-b border-[#2b3139]">
        <!-- N√∫t H·ªßy C·ªë ƒê·ªãnh -->
        <button onclick="game.cancelBet()" class="btn-cancel active:scale-95 transition shadow-lg mr-3">
            <i class="fa-solid fa-rotate-left mr-1.5 text-red-400"></i> H·ª¶Y
        </button>
        
        <!-- V·∫°ch ngƒÉn c√°ch -->
        <div class="w-[1px] h-6 bg-[#2b3139] mr-3 shrink-0"></div>

        <!-- Thanh cu·ªôn chip -->
        <div class="flex-1 overflow-x-auto no-scrollbar flex items-center gap-2">
            <div class="chip" onclick="game.setChip(2000)">2k</div>
            <div class="chip active" onclick="game.setChip(10000)">10k</div>
            <div class="chip" onclick="game.setChip(50000)">50k</div>
            <div class="chip" onclick="game.setChip(100000)">100k</div>
            <div class="chip" onclick="game.setChip(500000)">500k</div>
        </div>
    </div>

    <!-- BET BUTTONS -->
    <div class="p-4 grid grid-cols-2 gap-4 h-24">
      
      <!-- UP -->
      <button id="btn-up" class="btn-action btn-up h-full group" onclick="game.placeBet('UP')">
        <div class="flex flex-col items-center gap-0.5">
          <div class="flex items-center gap-2">
            <i class="fa-solid fa-arrow-trend-up text-xl mb-1"></i>
            <span class="font-oswald text-2xl font-bold text-white">MUA</span>
          </div>
          <span class="text-[10px] opacity-70 font-mono text-white/50 group-[.selected]:text-up group-[.selected]:opacity-100">Payout x1.95</span>
        </div>
        <div id="badge-UP" class="bet-badge hidden"></div>
        <div class="absolute inset-0 bg-up/10 opacity-0 transition-opacity active:opacity-100 pointer-events-none"></div>
      </button>

      <!-- DOWN -->
      <button id="btn-down" class="btn-action btn-down h-full group" onclick="game.placeBet('DOWN')">
        <div class="flex flex-col items-center gap-0.5">
          <div class="flex items-center gap-2">
            <i class="fa-solid fa-arrow-trend-down text-xl mb-1"></i>
            <span class="font-oswald text-2xl font-bold text-white">B√ÅN</span>
          </div>
          <span class="text-[10px] opacity-70 font-mono text-white/50 group-[.selected]:text-down group-[.selected]:opacity-100">Payout x1.95</span>
        </div>
        <div id="badge-DOWN" class="bet-badge hidden"></div>
        <div class="absolute inset-0 bg-down/10 opacity-0 transition-opacity active:opacity-100 pointer-events-none"></div>
      </button>

    </div>
  </div>

  <!-- RESULT MODAL -->
  <div id="modal-overlay" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300">
    <div id="modal-content" class="bg-[#1e2329] border border-white/10 rounded-3xl p-6 w-72 text-center transform scale-90 transition-transform duration-300 shadow-2xl relative overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-white/5 to-transparent pointer-events-none"></div>
      <div id="modal-icon" class="text-6xl mb-4 drop-shadow-2xl animate-bounce"></div>
      <div id="modal-title" class="text-3xl font-oswald font-bold uppercase mb-2"></div>
      <div id="modal-amount" class="font-mono text-2xl font-bold tracking-tight"></div>
      <div class="mt-6 w-full h-1 bg-[#2b3139] rounded overflow-hidden">
        <div class="h-full bg-gold animate-[width_3s_linear_reverse] w-full"></div>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-[#1e2329]/95 backdrop-blur border border-white/10 px-5 py-2.5 rounded-full flex items-center gap-3 opacity-0 pointer-events-none transition-all duration-300 z-[200] shadow-xl w-max max-w-[90%]">
    <i id="toast-icon" class="fa-solid fa-info-circle text-xs"></i>
    <span id="toast-msg" class="text-[11px] font-bold text-white uppercase tracking-wider">Th√¥ng b√°o</span>
  </div>

  <script>
    // ===== 1. C·∫§U H√åNH ƒê·ªíNG B·ªò =====
    const CONFIG = {
      PHASE_BET: 15,    // 15s C∆∞·ª£c
      PHASE_WAIT: 15,   // 15s ƒê·ª£i
      ODDS: 1.95,
      BASE_PRICE: 96500.00
    };

    const SUPABASE_URL = 'https://sfbaytcmpgceapdcdyer.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmYmF5dGNtcGdjZWFwZGNkeWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NDQ2MzYsImV4cCI6MjA4MTEyMDYzNn0.DeXO91pcCzQJHMcXTk9Eilcsk9IoGIPzOM-Ube4zRb8';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===== 2. DETERMINISTIC RNG (ƒê·ªìng b·ªô Multiplayer) =====
    function seededRandom(seed) {
        var x = Math.sin(seed++) * 10000;
        return x - Math.floor(x);
    }

    function generateCandleData(timestampSec) {
        const seed = timestampSec;
        const rand1 = seededRandom(seed);
        const rand2 = seededRandom(seed + 0.1);
        const rand3 = seededRandom(seed + 0.2);
        
        // Trend nh·∫π theo ph√∫t
        const trend = Math.sin(timestampSec / 120) * 8; 
        const volatility = 12; // Bi·∫øn ƒë·ªông h·ª£p l√Ω (12 USD/s)
        const change = (rand1 - 0.5) * volatility + trend;
        
        return {
            change: change,
            highOffset: Math.abs(change) + rand2 * 6,
            lowOffset: -Math.abs(change) - rand3 * 6
        };
    }

    // ===== 3. APP STATE =====
    const app = {
      user: null, balance: 0,
      showToast: (msg, type='info') => {
        const t = document.getElementById("toast");
        const i = document.getElementById("toast-icon");
        document.getElementById("toast-msg").innerText = msg;
        if (type === 'error') { i.className = "fa-solid fa-circle-xmark text-down"; }
        else if (type === 'success') { i.className = "fa-solid fa-circle-check text-up"; }
        else { i.className = "fa-solid fa-info-circle text-gold"; }
        t.classList.remove("opacity-0", "pointer-events-none");
        setTimeout(() => t.classList.add("opacity-0", "pointer-events-none"), 3000);
      }
    };

    // ===== 4. CHART ENGINE (N√ÇNG C·∫§P) =====
    const chart = {
      canvas: document.getElementById('candle-chart'),
      ctx: null,
      width: 0, height: 0,
      
      candles: [], 
      currentCandle: null,
      
      serverTime: Math.floor(Date.now() / 1000),
      basePrice: CONFIG.BASE_PRICE,
      displayPrice: CONFIG.BASE_PRICE,

      init: () => {
        chart.ctx = chart.canvas.getContext('2d');
        window.addEventListener('resize', chart.resize);
        chart.resize();
        
        // Seed history 60s
        const nowSec = Math.floor(Date.now() / 1000);
        // ƒê·ªÉ ƒë·∫£m b·∫£o n·∫øn n·ªëi ti·∫øp nhau, ta t√≠nh tu·∫ßn t·ª±
        let p = CONFIG.BASE_PRICE;
        
        for (let t = nowSec - 60; t < nowSec; t++) {
            const data = generateCandleData(t);
            const open = p;
            const close = p + data.change;
            
            // Logic N·∫øn chu·∫©n: High >= Max(Open, Close), Low <= Min(Open, Close)
            const realHigh = Math.max(open, close) + Math.abs(data.highOffset);
            const realLow = Math.min(open, close) - Math.abs(data.lowOffset);
            
            chart.candles.push({ open, close, high: realHigh, low: realLow, time: t });
            p = close; // Gi√° Close c·ªßa n·∫øn n√†y l√† Open c·ªßa n·∫øn sau
        }
        
        chart.basePrice = p;
        chart.displayPrice = p;
        chart.resetCurrentCandle();
        
        requestAnimationFrame(chart.draw);
      },

      resize: () => {
        const wrap = document.getElementById('chart-container');
        chart.width = wrap.clientWidth;
        chart.height = wrap.clientHeight;
        chart.canvas.width = chart.width * 2;
        chart.canvas.height = chart.height * 2;
        chart.ctx.scale(2, 2);
      },

      resetCurrentCandle: () => {
        chart.currentCandle = { 
            open: chart.basePrice, close: chart.basePrice, 
            high: chart.basePrice, low: chart.basePrice,
            startTime: Date.now()
        };
      },

      update: () => {
        const now = Date.now();
        const nowSec = Math.floor(now / 1000);
        
        // New Candle Logic
        if (nowSec > chart.serverTime) {
            chart.candles.push({...chart.currentCandle});
            if(chart.candles.length > 60) chart.candles.shift();
            
            // QUAN TR·ªåNG: Gi√° m·ªü n·∫øn m·ªõi = Gi√° ƒë√≥ng n·∫øn c≈©
            chart.basePrice = chart.currentCandle.close;
            chart.resetCurrentCandle();
            chart.serverTime = nowSec;
        }

        // Interpolation logic
        const progress = (now % 1000) / 1000; 
        const seedData = generateCandleData(nowSec);
        
        // ƒê√≠ch ƒë·∫øn c·ªßa gi√¢y n√†y
        const targetClose = chart.currentCandle.open + seedData.change;
        
        // T√≠nh gi√° hi·ªán t·∫°i (Visual)
        // D√πng Sine Wave ƒë·ªÉ t·∫°o dao ƒë·ªông gi·∫£ l·∫≠p (noise) xung quanh ƒë∆∞·ªùng th·∫≥ng t·ª´ Open -> Target
        const linearPrice = chart.currentCandle.open + (targetClose - chart.currentCandle.open) * progress;
        const noise = Math.sin(progress * Math.PI * 4) * 2; // Dao ƒë·ªông 2 USD
        
        let visualPrice = linearPrice + noise;
        
        // Khi g·∫ßn h·∫øt gi√¢y, √©p v·ªÅ gi√° target ƒë·ªÉ n·∫øn sau kh·ªõp
        if (progress > 0.9) {
            const blend = (progress - 0.9) * 10; // 0 -> 1
            visualPrice = (visualPrice * (1-blend)) + (targetClose * blend);
        }
        
        chart.displayPrice = visualPrice;
        
        // Update High/Low
        chart.currentCandle.close = visualPrice;
        if(visualPrice > chart.currentCandle.high) chart.currentCandle.high = visualPrice;
        if(visualPrice < chart.currentCandle.low) chart.currentCandle.low = visualPrice;

        // DOM Update
        const el = document.getElementById('live-price');
        el.innerText = visualPrice.toLocaleString('en-US', {minimumFractionDigits: 2});
        
        const isUp = visualPrice >= chart.currentCandle.open;
        el.className = isUp ? "font-mono text-3xl font-bold tracking-tighter text-up drop-shadow-md transition-colors" : "font-mono text-3xl font-bold tracking-tighter text-down drop-shadow-md transition-colors";
      },

      draw: () => {
        const { ctx, width, height, candles, currentCandle } = chart;
        ctx.clearRect(0, 0, width, height);

        const allData = [...candles, currentCandle];
        
        // Viewport: 35 n·∫øn
        const viewSize = 35;
        const viewData = allData.slice(-viewSize);
        
        // T√≠nh Scale Y
        let minVal = Infinity, maxVal = -Infinity;
        viewData.forEach(c => {
            if(c.low < minVal) minVal = c.low;
            if(c.high > maxVal) maxVal = c.high;
        });
        
        if(game.phase === 'WAIT' && game.lockPrice > 0) {
            if(game.lockPrice > maxVal) maxVal = game.lockPrice;
            if(game.lockPrice < minVal) minVal = game.lockPrice;
        }

        const range = maxVal - minVal || 1;
        const padding = height * 0.2;
        const getY = (val) => height - padding - ((val - minVal) / range) * (height - 2*padding);

        // Grid & Labels
        ctx.strokeStyle = '#2b3139';
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let i=1; i<6; i++) {
          const y = (height/6)*i;
          ctx.moveTo(0, y); ctx.lineTo(width, y);
          
          // Price Labels (Both Sides)
          const pLabel = minVal + (range * ((height-y-padding)/(height-2*padding)));
          ctx.fillStyle = '#5e6673';
          ctx.font = '10px JetBrains Mono';
          
          // Left
          ctx.textAlign = 'left';
          ctx.fillText(pLabel.toFixed(2), 5, y - 4);
          
          // Right
          ctx.textAlign = 'right';
          ctx.fillText(pLabel.toFixed(2), width - 5, y - 4);
        }
        ctx.stroke();

        // Lock Line
        if (game.phase === 'WAIT' && game.lockPrice > 0) {
            const lockY = getY(game.lockPrice);
            const badge = document.getElementById('lock-label');
            badge.classList.remove('hidden');
            badge.style.top = (lockY / 2) - 10 + "px"; // CSS px alignment
            
            ctx.beginPath();
            ctx.strokeStyle = '#FACC15';
            ctx.lineWidth = 1.5;
            ctx.setLineDash([6, 4]);
            ctx.moveTo(0, lockY);
            ctx.lineTo(width, lockY);
            ctx.stroke();
            ctx.setLineDash([]);
        } else {
            document.getElementById('lock-label').classList.add('hidden');
        }

        // Draw Candles
        // Logic: N·∫øn hi·ªán t·∫°i ·ªü v·ªã tr√≠ 2/3 m√†n h√¨nh (width * 0.66)
        // C√°c n·∫øn l·ªãch s·ª≠ v·∫Ω l√πi v·ªÅ b√™n tr√°i
        const anchorX = width * 0.7; 
        const spacing = width / 40; // M·∫≠t ƒë·ªô n·∫øn
        const candleW = spacing * 0.65;

        // V·∫Ω ng∆∞·ª£c t·ª´ n·∫øn hi·ªán t·∫°i v·ªÅ qu√° kh·ª©
        [...viewData].reverse().forEach((c, i) => {
            const x = anchorX - (i * spacing);
            
            if (x < -candleW) return; // Skip off-screen

            const yOpen = getY(c.open);
            const yClose = getY(c.close);
            const yHigh = getY(c.high);
            const yLow = getY(c.low);
            
            const isGreen = c.close >= c.open;
            const color = isGreen ? '#2ebd85' : '#f6465d';

            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = 1;

            // Wick
            ctx.beginPath();
            ctx.moveTo(x, yHigh);
            ctx.lineTo(x, yLow);
            ctx.stroke();

            // Body
            const bodyH = Math.max(Math.abs(yClose - yOpen), 1);
            const bodyY = Math.min(yOpen, yClose);
            ctx.fillRect(x - candleW/2, bodyY, candleW, bodyH);
            
            // Price Line (Ch·ªâ cho n·∫øn hi·ªán t·∫°i i=0)
            if (i === 0) {
                ctx.beginPath();
                ctx.setLineDash([2, 2]);
                ctx.moveTo(x, yClose);
                ctx.lineTo(width, yClose);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Label background
                ctx.fillStyle = color;
                ctx.fillRect(width - 55, yClose - 10, 55, 20);
                ctx.fillStyle = isGreen ? '#000' : '#fff';
                ctx.font = "bold 10px JetBrains Mono";
                ctx.textAlign = 'center';
                ctx.fillText(c.close.toFixed(2), width - 27, yClose + 4);
                
                // Pulsing Dot
                ctx.beginPath();
                ctx.arc(x, yClose, 3, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();
            }
        });
        
        requestAnimationFrame(chart.draw);
      }
    };

    // ===== 5. GAME LOGIC =====
    const game = {
      roundId: 0,
      phase: 'BET',
      timeLeft: 0,
      lockPrice: 0,
      
      currentChip: 10000,
      betSide: null,
      betAmount: 0,
      
      history: [],

      init: async () => {
        const uid = localStorage.getItem("my_wallet_uid");
        if (!uid) { alert("Login required!"); window.location.href = "index.html"; return; }
        
        app.user = { id: uid };
        await game.loadBalance();
        game.setupRealtimeBalance();

        chart.init();
        
        setInterval(() => {
            chart.update();
            game.syncLoop();
        }, 16); // 60fps logic loop
      },

      loadBalance: async () => {
        const { data } = await supabaseClient.from('users').select('balance').eq('id', app.user.id).maybeSingle();
        if (data) { app.balance = data.balance; game.updateBalanceUI(); }
      },

      setupRealtimeBalance: () => {
        supabaseClient.channel('wallet-changes').on('postgres_changes', 
          { event: 'UPDATE', schema: 'public', table: 'users', filter: `id=eq.${app.user.id}` },
          (payload) => { app.balance = payload.new.balance; game.updateBalanceUI(); }
        ).subscribe();
      },

      updateBalanceUI: () => {
        document.getElementById("balance").innerText = app.balance.toLocaleString('en-US');
      },

      // --- SYNC LOOP ---
      syncLoop: () => {
        const now = Date.now();
        const totalRoundTime = (CONFIG.PHASE_BET + CONFIG.PHASE_WAIT) * 1000;
        const currentRoundId = Math.floor(now / totalRoundTime);
        const timeIntoRound = now % totalRoundTime;
        
        if (currentRoundId !== game.roundId) {
            game.roundId = currentRoundId;
            game.startNewRound();
        }

        const betTimeMs = CONFIG.PHASE_BET * 1000;
        
        if (timeIntoRound < betTimeMs) {
            // BET PHASE
            if (game.phase !== 'BET') game.resetUI();
            game.phase = 'BET';
            game.timeLeft = Math.ceil((betTimeMs - timeIntoRound) / 1000);
            
            const pct = (timeIntoRound / betTimeMs) * 100;
            document.getElementById('phase-bar').style.width = (100 - pct) + '%';
            document.getElementById('phase-bar').className = "h-full bg-up w-full";
            
        } else {
            // WAIT PHASE
            if (game.phase === 'BET') game.switchPhaseToWait();
            game.phase = 'WAIT';
            game.timeLeft = Math.ceil((totalRoundTime - timeIntoRound) / 1000);
            
            const waitTimeInto = timeIntoRound - betTimeMs;
            const pct = (waitTimeInto / (CONFIG.PHASE_WAIT * 1000)) * 100;
            document.getElementById('phase-bar').style.width = (100 - pct) + '%';
            document.getElementById('phase-bar').className = "h-full bg-down w-full";
            
            if (game.timeLeft <= 0 && !game.resultProcessed) {
                game.processResult();
                game.resultProcessed = true;
            }
        }
        
        document.getElementById('timer-display').innerText = game.timeLeft;
      },

      startNewRound: () => {
        game.resultProcessed = false;
        game.lockPrice = 0;
        
        // Reset local bet state
        game.betAmount = 0;
        game.betSide = null;
        game.resetUI();
      },

      switchPhaseToWait: () => {
        game.lockPrice = chart.displayPrice;
        
        const badge = document.getElementById('phase-badge');
        badge.innerText = "CH·ªú K·∫æT QU·∫¢";
        badge.className = "px-2 py-0.5 rounded bg-down/20 text-down text-[10px] font-bold uppercase backdrop-blur border border-down/30";
        
        document.getElementById('btn-up').classList.add('disabled');
        document.getElementById('btn-down').classList.add('disabled');
        
        document.getElementById('lock-price-val').innerText = game.lockPrice.toLocaleString('en-US', {minimumFractionDigits: 2});
        
        app.showToast("ƒê√£ kh√≥a gi√°! ƒêang ch·ªù k·∫øt qu·∫£...", "info");
      },

      processResult: async () => {
        const result = chart.displayPrice >= game.lockPrice ? 'UP' : 'DOWN';
        
        // Add dot
        const rm = document.getElementById('roadmap');
        const dot = document.createElement('div');
        dot.className = `w-2 h-2 rounded-sm ${result==='UP'?'bg-up shadow-[0_0_5px_#2ebd85]':'bg-down shadow-[0_0_5px_#f6465d]'}`;
        rm.appendChild(dot);
        if(rm.children.length > 20) rm.removeChild(rm.firstChild);

        if (game.betAmount > 0) {
            const isWin = game.betSide === result;
            if (isWin) {
                const profit = Math.floor(game.betAmount * CONFIG.ODDS);
                app.balance += profit;
                await supabaseClient.from('users').update({ balance: app.balance }).eq('id', app.user.id);
                game.updateBalanceUI();
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                game.showModal(true, profit, result);
            } else {
                game.showModal(false, 0, result);
            }
        }
      },

      // --- BETTING LOGIC (STACKING) ---
      setChip: (val) => {
        if (game.phase !== 'BET') return;
        game.currentChip = val;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        const chips = document.querySelectorAll('.chip');
        chips.forEach(c => {
             if(c.innerText.includes(val >= 1000 ? (val/1000)+'k' : val)) c.classList.add('active');
        });
      },

      placeBet: async (side) => {
        if (game.phase !== 'BET') return app.showToast("ƒê√£ kh√≥a c∆∞·ª£c!", 'error');
        if (game.betAmount > 0 && game.betSide !== side) return app.showToast("Kh√¥ng th·ªÉ c∆∞·ª£c 2 b√™n!", 'error');
        if (game.currentChip > app.balance) return app.showToast("S·ªë d∆∞ kh√¥ng ƒë·ªß", 'error');

        // Add to existing bet
        game.betSide = side;
        game.betAmount += game.currentChip;

        // Deduct balance
        app.balance -= game.currentChip;
        game.updateBalanceUI();
        await supabaseClient.from('users').update({ balance: app.balance }).eq('id', app.user.id);

        // UI Update
        const btnUp = document.getElementById('btn-up');
        const btnDown = document.getElementById('btn-down');
        
        if (side === 'UP') {
            btnUp.classList.add('selected');
            btnDown.classList.add('disabled');
            document.getElementById('badge-UP').innerText = game.betAmount.toLocaleString();
            document.getElementById('badge-UP').classList.remove('hidden');
        } else {
            btnDown.classList.add('selected');
            btnUp.classList.add('disabled');
            document.getElementById('badge-DOWN').innerText = game.betAmount.toLocaleString();
            document.getElementById('badge-DOWN').classList.remove('hidden');
        }
        
        if (navigator.vibrate) navigator.vibrate(30);
      },

      cancelBet: async () => {
        if (game.phase !== 'BET') return app.showToast("Kh√¥ng th·ªÉ h·ªßy l√∫c n√†y!", 'error');
        if (game.betAmount === 0) return app.showToast("Ch∆∞a c√≥ c∆∞·ª£c n√†o!", 'info');

        app.balance += game.betAmount;
        game.updateBalanceUI();
        await supabaseClient.from('users').update({ balance: app.balance }).eq('id', app.user.id);

        game.betAmount = 0;
        game.betSide = null;

        document.getElementById('btn-up').classList.remove('selected', 'disabled');
        document.getElementById('btn-down').classList.remove('selected', 'disabled');
        document.getElementById('badge-UP').classList.add('hidden');
        document.getElementById('badge-DOWN').classList.add('hidden');

        app.showToast("ƒê√£ h·ªßy c∆∞·ª£c!", 'info');
      },

      resetUI: () => {
        const btnUp = document.getElementById('btn-up');
        const btnDown = document.getElementById('btn-down');
        btnUp.className = "btn-action btn-up h-full group";
        btnDown.className = "btn-action btn-down h-full group";
        document.getElementById('badge-UP').classList.add('hidden');
        document.getElementById('badge-DOWN').classList.add('hidden');
        
        const badge = document.getElementById('phase-badge');
        badge.innerText = "ƒê·∫∂T L·ªÜNH";
        badge.className = "px-2 py-0.5 rounded bg-up/20 text-up text-[10px] font-bold uppercase backdrop-blur border border-up/30";
        
        document.getElementById('lock-label').classList.add('hidden');
      },

      showModal: (isWin, amount, result) => {
        const overlay = document.getElementById('modal-overlay');
        const content = document.getElementById('modal-content');
        
        overlay.classList.remove('opacity-0', 'pointer-events-none');
        content.classList.remove('scale-90');
        content.classList.add('scale-100');
        
        const icon = document.getElementById('modal-icon');
        const title = document.getElementById('modal-title');
        const amt = document.getElementById('modal-amount');
        
        if (isWin) {
            icon.innerHTML = 'üèÜ';
            title.innerText = "TH·∫ÆNG L·ªöN";
            title.className = "text-2xl font-oswald font-bold uppercase mb-1 text-up";
            amt.innerText = "+" + amount.toLocaleString();
            amt.className = "font-mono text-xl font-bold text-up";
        } else {
            icon.innerHTML = 'üìâ';
            title.innerText = "THUA CU·ªòC";
            title.className = "text-2xl font-oswald font-bold uppercase mb-1 text-[#848e9c]";
            amt.innerText = "-" + game.betAmount.toLocaleString();
            amt.className = "font-mono text-xl font-bold text-[#848e9c]";
        }
        
        setTimeout(() => {
            overlay.classList.add('opacity-0', 'pointer-events-none');
            content.classList.add('scale-90');
            content.classList.remove('scale-100');
        }, 3000);
      }
    };

    window.onload = game.init;
  </script>
</body>
</html>

