<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Crypto Super VIP - HC88</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;500;700;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
  <!-- SUPABASE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- CANVAS CONFETTI -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 
            oswald: ['Oswald', 'sans-serif'], 
            roboto: ['Roboto', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace']
          },
          colors: { 
            gold: '#FACC15', 
            up: '#0ecb81',     // Binance Green Neon
            down: '#f6465d',   // Binance Red Neon
            dark: '#161a1e',
            card: '#1e2329'
          },
          boxShadow: { 
            'glow-up': '0 0 20px rgba(14, 203, 129, 0.4)',
            'glow-down': '0 0 20px rgba(246, 70, 93, 0.4)'
          },
          animation: {
            'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'flash': 'flashWhite 0.3s ease-out'
          },
          keyframes: {
            flashWhite: { '0%': { backgroundColor: 'rgba(255,255,255,0.2)' }, '100%': { backgroundColor: 'transparent' } }
          }
        }
      }
    }
  </script>

  <style>
    /* CORE SETUP */
    body {
      background-color: #161a1e;
      color: #eaecef; overflow: hidden; touch-action: manipulation; user-select: none;
      -webkit-tap-highlight-color: transparent; font-family: 'Roboto', sans-serif;
      height: 100vh; height: 100dvh;
      display: flex; flex-direction: column;
    }
    
    /* CHART & CANVAS */
    #chart-wrapper {
      position: relative; flex: 1; width: 100%; overflow: hidden;
      background: radial-gradient(circle at 50% 50%, #1e2329 0%, #161a1e 100%);
    }
    canvas { display: block; width: 100%; height: 100%; }

    /* BUTTONS */
    .btn-action {
      position: relative; overflow: hidden; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 12px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .btn-action:active { transform: scale(0.96); }
    
    .btn-up { background: linear-gradient(180deg, rgba(14,203,129,0.15) 0%, rgba(14,203,129,0.05) 100%); border-color: rgba(14,203,129,0.3); }
    .btn-up.selected { background: #0ecb81; color: #161a1e; border-color: #0ecb81; box-shadow: 0 0 25px rgba(14,203,129,0.6); }
    
    .btn-down { background: linear-gradient(180deg, rgba(246,70,93,0.15) 0%, rgba(246,70,93,0.05) 100%); border-color: rgba(246,70,93,0.3); }
    .btn-down.selected { background: #f6465d; color: white; border-color: #f6465d; box-shadow: 0 0 25px rgba(246,70,93,0.6); }

    .btn-action.disabled { opacity: 0.4; filter: grayscale(100%); pointer-events: none; }

    /* CHIPS */
    .chip { 
      height: 36px; min-width: 60px; padding: 0 12px; border-radius: 8px; 
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 11px; cursor: pointer; 
      background: #2b3139; color: #848e9c; border: 1px solid transparent;
      transition: all 0.2s; white-space: nowrap;
    }
    .chip.active { 
      background: #FACC15; color: #1e2329; border-color: #FACC15;
      font-weight: 900; box-shadow: 0 4px 12px rgba(250, 204, 21, 0.3);
      transform: translateY(-2px);
    }

    /* PHASE BAR */
    .phase-bar-container {
      width: 100%; height: 4px; background: #2b3139; position: absolute; top: 0; left: 0; z-index: 50;
    }
    .phase-bar { height: 100%; width: 100%; transition: width 1s linear, background-color 0.3s; }

    /* UTILS */
    .pb-safe { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    .glass-panel { background: rgba(30, 35, 41, 0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.1); }
  </style>
</head>
<body>

  <!-- PHASE PROGRESS BAR -->
  <div class="phase-bar-container">
    <div id="main-progress" class="phase-bar bg-up"></div>
  </div>

  <!-- HEADER -->
  <header class="h-14 flex items-center justify-between px-4 shrink-0 z-40 bg-[#161a1e]/80 backdrop-blur">
    <div class="flex items-center gap-3">
      <a href="games.html" class="w-8 h-8 rounded-lg bg-[#2b3139] flex items-center justify-center text-[#848e9c] hover:text-white transition active:scale-95">
        <i class="fa-solid fa-chevron-left text-sm"></i>
      </a>
      <div>
        <div class="flex items-center gap-2">
          <i class="fa-brands fa-bitcoin text-[#F7931A] text-xl"></i>
          <div>
            <div class="font-bold text-sm text-white leading-none">BTC/USDT</div>
            <div class="text-[10px] text-[#848e9c] font-bold">Binary Option</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="text-right bg-[#2b3139] px-3 py-1 rounded-lg border border-white/5">
      <div class="text-[9px] text-[#848e9c] font-bold uppercase tracking-wider">S·ªë d∆∞</div>
      <div class="flex items-center justify-end gap-1">
        <span id="balance" class="font-mono text-sm text-white font-bold">---</span>
        <span class="text-gold text-[10px] font-black">$</span>
      </div>
    </div>
  </header>

  <!-- CHART AREA -->
  <div id="chart-wrapper">
    
    <!-- INFO OVERLAY -->
    <div class="absolute top-4 left-4 z-10 pointer-events-none">
      <div id="live-price" class="font-mono text-4xl font-bold tracking-tighter text-up drop-shadow-lg transition-colors duration-300">--.--</div>
      <div id="trend-info" class="text-[10px] font-bold text-up flex items-center gap-1 mt-1">
        <i class="fa-solid fa-arrow-trend-up"></i> <span>Live Market</span>
      </div>
    </div>

    <!-- TIMER OVERLAY -->
    <div class="absolute top-4 right-4 z-10 pointer-events-none text-right">
      <div id="phase-badge" class="inline-block px-2 py-0.5 rounded bg-up/20 text-up text-[10px] font-bold uppercase mb-1 backdrop-blur-md border border-up/30">
        ƒê·∫∂T L·ªÜNH
      </div>
      <div class="font-oswald text-4xl font-bold text-white drop-shadow-lg" id="timer-display">20</div>
      <div class="text-[9px] text-[#848e9c] uppercase font-bold">Gi√¢y c√≤n l·∫°i</div>
    </div>

    <!-- CANVAS -->
    <canvas id="super-chart"></canvas>

    <!-- LOCK LINE INFO (Hidden by default) -->
    <div id="lock-info" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-20 hidden flex-col items-center">
      <div class="px-3 py-1 bg-dark/80 backdrop-blur rounded border border-white/20 text-xs font-mono font-bold text-white shadow-xl">
        LOCK: <span id="lock-price-display">--.--</span>
      </div>
    </div>

  </div>

  <!-- CONTROL PANEL -->
  <div class="glass-panel z-50 pb-safe shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
    
    <!-- CHIP SELECTOR -->
    <div class="pt-3 pb-2 px-3 overflow-x-auto no-scrollbar flex items-center gap-2">
      <div class="chip" onclick="game.setChip(2000)">2k</div>
      <div class="chip active" onclick="game.setChip(10000)">10k</div>
      <div class="chip" onclick="game.setChip(50000)">50k</div>
      <div class="chip" onclick="game.setChip(100000)">100k</div>
      <div class="chip" onclick="game.setChip(500000)">500k</div>
      <!-- Removed All-in -->
    </div>

    <!-- MAIN BUTTONS -->
    <div class="px-3 pb-3 grid grid-cols-2 gap-3 h-20">
      
      <!-- BUTTON UP -->
      <button id="btn-up" class="btn-action btn-up group" onclick="game.placeBet('UP')">
        <div class="flex items-center gap-2 mb-0.5">
          <i class="fa-solid fa-arrow-trend-up text-lg group-[.selected]:text-dark text-up"></i>
          <span class="font-oswald text-2xl font-bold group-[.selected]:text-dark text-white">MUA</span>
        </div>
        <div class="text-[10px] opacity-80 font-mono group-[.selected]:text-dark text-up">Payout x1.95</div>
        <!-- Badge amount if selected -->
        <div id="badge-UP" class="absolute top-1 right-1 bg-dark/30 text-white text-[9px] px-1.5 rounded hidden font-mono"></div>
      </button>

      <!-- BUTTON DOWN -->
      <button id="btn-down" class="btn-action btn-down group" onclick="game.placeBet('DOWN')">
        <div class="flex items-center gap-2 mb-0.5">
          <i class="fa-solid fa-arrow-trend-down text-lg group-[.selected]:text-white text-down"></i>
          <span class="font-oswald text-2xl font-bold text-white">B√ÅN</span>
        </div>
        <div class="text-[10px] opacity-80 font-mono text-down group-[.selected]:text-white">Payout x1.95</div>
        <div id="badge-DOWN" class="absolute top-1 right-1 bg-dark/30 text-white text-[9px] px-1.5 rounded hidden font-mono"></div>
      </button>

    </div>
  </div>

  <!-- RESULT MODAL -->
  <div id="modal-overlay" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300">
    <div id="modal-content" class="bg-[#1e2329] border border-white/10 rounded-3xl p-6 w-72 text-center transform scale-90 transition-transform duration-300 shadow-2xl relative overflow-hidden">
      <!-- Glow Effect -->
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-white to-transparent opacity-50"></div>
      
      <div id="modal-icon" class="text-6xl mb-4 drop-shadow-2xl animate-bounce"></div>
      <div id="modal-title" class="text-3xl font-oswald font-bold uppercase mb-2"></div>
      <div id="modal-amount" class="font-mono text-2xl font-bold tracking-tight"></div>
      
      <div class="mt-6 text-[10px] text-[#848e9c] font-bold uppercase tracking-widest">T·ª± ƒë·ªông ƒë√≥ng sau 3s</div>
    </div>
  </div>

  <!-- TOAST NOTIFICATION -->
  <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-[#1e2329]/95 backdrop-blur border border-white/10 px-5 py-2.5 rounded-full flex items-center gap-3 opacity-0 pointer-events-none transition-all duration-300 z-[200] shadow-xl w-max max-w-[90%]">
    <i id="toast-icon" class="fa-solid fa-info-circle text-xs"></i>
    <span id="toast-msg" class="text-[11px] font-bold text-white uppercase tracking-wider">Th√¥ng b√°o</span>
  </div>

  <script>
    // ===== 1. C·∫§U H√åNH GAME =====
    const CONFIG = {
      PHASE_1_BET: 20,    // 20 gi√¢y ƒë·∫∑t c∆∞·ª£c
      PHASE_2_WAIT: 10,   // 10 gi√¢y ƒë·ª£i k·∫øt qu·∫£ (kh√≥a)
      ODDS: 1.95          // T·ª∑ l·ªá ƒÉn
    };

    const SUPABASE_URL = 'https://sfbaytcmpgceapdcdyer.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmYmF5dGNtcGdjZWFwZGNkeWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NDQ2MzYsImV4cCI6MjA4MTEyMDYzNn0.DeXO91pcCzQJHMcXTk9Eilcsk9IoGIPzOM-Ube4zRb8';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===== 2. APP STATE =====
    const app = {
      user: null, balance: 0,
      showToast: (msg, type='info') => {
        const t = document.getElementById("toast");
        const i = document.getElementById("toast-icon");
        document.getElementById("toast-msg").innerText = msg;
        if (type === 'error') { i.className = "fa-solid fa-circle-xmark text-down"; }
        else if (type === 'success') { i.className = "fa-solid fa-circle-check text-up"; }
        else { i.className = "fa-solid fa-info-circle text-gold"; }
        t.classList.remove("opacity-0", "pointer-events-none");
        setTimeout(() => t.classList.add("opacity-0", "pointer-events-none"), 3000);
      }
    };

    // ===== 3. ENGINE BI·ªÇU ƒê·ªí (VISUAL) =====
    const chart = {
      canvas: document.getElementById('super-chart'),
      ctx: null,
      data: [],
      maxPoints: 100,
      width: 0, height: 0,
      currentPrice: 42000.00, // Gi√° kh·ªüi ƒëi·ªÉm gi·∫£ l·∫≠p

      init: () => {
        chart.ctx = chart.canvas.getContext('2d');
        window.addEventListener('resize', chart.resize);
        chart.resize();
        // Seed d·ªØ li·ªáu ban ƒë·∫ßu
        for(let i=0; i<chart.maxPoints; i++) {
          chart.currentPrice += (Math.random()-0.5) * 10;
          chart.data.push(chart.currentPrice);
        }
        requestAnimationFrame(chart.draw);
      },

      resize: () => {
        const wrap = document.getElementById('chart-wrapper');
        chart.width = wrap.clientWidth;
        chart.height = wrap.clientHeight;
        chart.canvas.width = chart.width * 2;
        chart.canvas.height = chart.height * 2;
        chart.ctx.scale(2, 2);
      },

      tick: () => {
        const volatility = 15;
        const change = (Math.random() - 0.5) * volatility;
        chart.currentPrice += change;
        chart.data.push(chart.currentPrice);
        if(chart.data.length > chart.maxPoints) chart.data.shift();

        // Update DOM text
        const el = document.getElementById('live-price');
        el.innerText = chart.currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        // M√†u s·∫Øc text d·ª±a tr√™n tƒÉng/gi·∫£m
        if(change >= 0) {
            el.className = "font-mono text-4xl font-bold tracking-tighter text-up drop-shadow-lg transition-colors duration-300";
            document.getElementById('trend-info').innerHTML = '<i class="fa-solid fa-arrow-trend-up"></i> <span>TƒÉng tr∆∞·ªüng</span>';
            document.getElementById('trend-info').className = "text-[10px] font-bold text-up flex items-center gap-1 mt-1";
        } else {
            el.className = "font-mono text-4xl font-bold tracking-tighter text-down drop-shadow-lg transition-colors duration-300";
            document.getElementById('trend-info').innerHTML = '<i class="fa-solid fa-arrow-trend-down"></i> <span>Suy gi·∫£m</span>';
            document.getElementById('trend-info').className = "text-[10px] font-bold text-down flex items-center gap-1 mt-1";
        }
      },

      draw: () => {
        const { ctx, width, height, data } = chart;
        ctx.clearRect(0, 0, width, height);

        // Auto Scale
        const minVal = Math.min(...data);
        const maxVal = Math.max(...data);
        const range = maxVal - minVal || 1;
        const padding = height * 0.2;
        const getY = (price) => height - padding - ((price - minVal) / range) * (height - 2*padding);
        const stepX = width / (data.length - 1);

        // Grid Lines
        ctx.beginPath();
        ctx.strokeStyle = 'rgba(255,255,255,0.03)';
        for(let i=1; i<5; i++) { const y = (height/5)*i; ctx.moveTo(0, y); ctx.lineTo(width, y); }
        ctx.stroke();

        // Main Line Path
        ctx.beginPath();
        data.forEach((p, i) => {
            const x = i * stepX;
            const y = getY(p);
            if(i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });

        // M√†u ƒë∆∞·ªùng v·∫Ω (Thay ƒë·ªïi theo tr·∫°ng th√°i th·∫Øng/thua n·∫øu ƒëang Locked)
        let strokeColor = '#0ecb81'; // M·∫∑c ƒë·ªãnh xanh
        let fillColor = 'rgba(14, 203, 129, ';
        
        if (game.data.length > 2 && game.data[game.data.length-1] < game.data[game.data.length-2]) {
             strokeColor = '#f6465d'; // ƒê·ªè n·∫øu ƒëang gi·∫£m
             fillColor = 'rgba(246, 70, 93, ';
        }
        
        // Logic m√†u khi ƒëang Lock
        if (game.phase === 'WAIT') {
             if (chart.currentPrice >= game.lockPrice) {
                 strokeColor = '#0ecb81'; // Xanh n·∫øu tr√™n gi√° Lock
                 fillColor = 'rgba(14, 203, 129, ';
             } else {
                 strokeColor = '#f6465d'; // ƒê·ªè n·∫øu d∆∞·ªõi gi√° Lock
                 fillColor = 'rgba(246, 70, 93, ';
             }
        }

        ctx.strokeStyle = strokeColor;
        ctx.lineWidth = 3;
        ctx.lineJoin = 'round';
        ctx.stroke();

        // Gradient Fill
        ctx.lineTo(width, height);
        ctx.lineTo(0, height);
        ctx.closePath();
        const grad = ctx.createLinearGradient(0, 0, 0, height);
        grad.addColorStop(0, fillColor + '0.25)');
        grad.addColorStop(1, fillColor + '0)');
        ctx.fillStyle = grad;
        ctx.fill();

        // Lock Line (N√©t ƒë·ª©t)
        if (game.phase === 'WAIT') {
            const lockY = getY(game.lockPrice);
            ctx.beginPath();
            ctx.setLineDash([6, 6]);
            ctx.strokeStyle = '#FACC15'; // M√†u v√†ng
            ctx.lineWidth = 1.5;
            ctx.moveTo(0, lockY);
            ctx.lineTo(width, lockY);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        // Glowing Dot at Tip
        const lastX = (data.length - 1) * stepX;
        const lastY = getY(data[data.length - 1]);
        
        ctx.beginPath();
        ctx.arc(lastX, lastY, 5, 0, Math.PI * 2);
        ctx.fillStyle = '#fff';
        ctx.fill();
        
        ctx.beginPath();
        ctx.arc(lastX, lastY, 12, 0, Math.PI * 2);
        ctx.fillStyle = strokeColor + '50'; // Glow
        ctx.fill();

        requestAnimationFrame(chart.draw);
      }
    };

    // ===== 4. LOGIC GAMEPLAY =====
    const game = {
      phase: 'BET', // BET -> WAIT -> RESULT
      timeLeft: CONFIG.PHASE_1_BET,
      totalTime: CONFIG.PHASE_1_BET + CONFIG.PHASE_2_WAIT,
      lockPrice: 0,
      
      currentChip: 10000,
      betSide: null, // 'UP' or 'DOWN'
      betAmount: 0,
      isBetPlaced: false, // Flag ƒë·ªÉ ch·∫∑n ƒë·ªïi phe sau khi ƒë√£ ƒë·∫∑t

      timerInterval: null,
      tickInterval: null,

      init: async () => {
        const uid = localStorage.getItem("my_wallet_uid");
        if (!uid) { alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!"); window.location.href = "index.html"; return; }
        
        app.user = { id: uid };
        await game.loadBalance();
        game.setupRealtimeBalance();
        
        // Kh·ªüi ƒë·ªông chart
        chart.init();
        game.tickInterval = setInterval(chart.tick, 800); // C·∫≠p nh·∫≠t gi√° m·ªói 0.8s
        
        game.startRound();
      },

      loadBalance: async () => {
        const { data } = await supabaseClient.from('users').select('balance').eq('id', app.user.id).maybeSingle();
        if (data) { app.balance = data.balance; game.updateBalanceUI(); }
      },
      
      setupRealtimeBalance: () => {
        supabaseClient.channel('wallet-changes').on('postgres_changes', 
          { event: 'UPDATE', schema: 'public', table: 'users', filter: `id=eq.${app.user.id}` },
          (payload) => { app.balance = payload.new.balance; game.updateBalanceUI(); }
        ).subscribe();
      },
      
      updateBalanceUI: () => {
        document.getElementById("balance").innerText = app.balance.toLocaleString('en-US');
      },

      // --- V√íNG L·∫∂P CH√çNH ---
      startRound: () => {
        game.phase = 'BET';
        game.timeLeft = CONFIG.PHASE_1_BET;
        game.lockPrice = 0;
        game.betSide = null;
        game.betAmount = 0;
        game.isBetPlaced = false;

        game.resetUI();
        
        if (game.timerInterval) clearInterval(game.timerInterval);
        game.timerInterval = setInterval(game.loop, 1000);
      },

      loop: () => {
        game.timeLeft--;
        document.getElementById('timer-display').innerText = game.timeLeft;
        
        // X·ª≠ l√Ω Progress Bar
        const bar = document.getElementById('main-progress');
        if (game.phase === 'BET') {
            const pct = (game.timeLeft / CONFIG.PHASE_1_BET) * 100;
            bar.style.width = pct + '%';
            
            // H·∫øt gi·ªù ƒë·∫∑t c∆∞·ª£c -> Chuy·ªÉn sang WAIT
            if (game.timeLeft <= 0) {
                game.switchPhaseToWait();
            }
        } else if (game.phase === 'WAIT') {
            const pct = (game.timeLeft / CONFIG.PHASE_2_WAIT) * 100;
            bar.style.width = pct + '%';
            
            // H·∫øt gi·ªù ƒë·ª£i -> X·ª≠ l√Ω k·∫øt qu·∫£
            if (game.timeLeft <= 0) {
                game.processResult();
                clearInterval(game.timerInterval);
            }
        }
      },

      switchPhaseToWait: () => {
        game.phase = 'WAIT';
        game.timeLeft = CONFIG.PHASE_2_WAIT;
        game.lockPrice = chart.currentPrice;
        
        // Update UI
        const badge = document.getElementById('phase-badge');
        badge.innerText = "CH·ªú K·∫æT QU·∫¢";
        badge.className = "inline-block px-2 py-0.5 rounded bg-down/20 text-down text-[10px] font-bold uppercase mb-1 backdrop-blur-md border border-down/30";
        
        const bar = document.getElementById('main-progress');
        bar.className = "phase-bar bg-down"; // ƒê·ªïi m√†u thanh sang ƒë·ªè
        
        // Disable n√∫t b·∫•m
        document.getElementById('btn-up').classList.add('disabled');
        document.getElementById('btn-down').classList.add('disabled');
        document.querySelectorAll('.chip').forEach(c => c.style.pointerEvents = 'none');

        // Hi·ªÉn th·ªã gi√° Lock
        const lockInfo = document.getElementById('lock-info');
        lockInfo.classList.remove('hidden');
        lockInfo.classList.add('flex');
        document.getElementById('lock-price-display').innerText = game.lockPrice.toLocaleString('en-US', {minimumFractionDigits: 2});
        
        app.showToast("ƒê√£ kh√≥a gi√°! ƒê·ª£i k·∫øt qu·∫£...", "info");
      },

      processResult: async () => {
        const result = chart.currentPrice >= game.lockPrice ? 'UP' : 'DOWN';
        
        if (game.isBetPlaced) {
            const isWin = game.betSide === result;
            if (isWin) {
                const profit = Math.floor(game.betAmount * CONFIG.ODDS);
                app.balance += profit;
                // Sync Server
                await supabaseClient.from('users').update({ balance: app.balance }).eq('id', app.user.id);
                game.updateBalanceUI();
                
                // Effect
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                game.showModal(true, profit, result);
            } else {
                game.showModal(false, 0, result);
            }
        } else {
            // Kh√¥ng c∆∞·ª£c th√¨ ch·ªâ hi·ªán th√¥ng b√°o nh·ªè
            app.showToast(`K·∫øt qu·∫£: ${result === 'UP' ? 'TƒÇNG' : 'GI·∫¢M'}`, 'info');
            setTimeout(game.startRound, 3000);
        }
      },

      // --- T∆Ø∆†NG T√ÅC NG∆Ø·ªúI CH∆†I ---
      setChip: (val) => {
        if (game.phase !== 'BET') return;
        game.currentChip = val;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        // Logic ch·ªçn visual (t√¨m element d·ª±a tr√™n text - ƒë∆°n gi·∫£n h√≥a cho code ng·∫Øn)
        const chips = document.querySelectorAll('.chip');
        for(let c of chips) { if(c.innerText.includes(val >= 1000 ? val/1000+'k' : val)) c.classList.add('active'); }
      },

      placeBet: async (side) => {
        if (game.phase !== 'BET') return app.showToast("ƒê√£ h·∫øt gi·ªù ƒë·∫∑t l·ªánh!", 'error');
        if (game.isBetPlaced) return app.showToast("B·∫°n ƒë√£ ƒë·∫∑t c∆∞·ª£c r·ªìi!", 'error');
        if (game.currentChip > app.balance) return app.showToast("S·ªë d∆∞ kh√¥ng ƒë·ªß!", 'error');

        // Logic ƒë·∫∑t c∆∞·ª£c
        game.betSide = side;
        game.betAmount = game.currentChip;
        game.isBetPlaced = true;

        // Tr·ª´ ti·ªÅn ngay l·∫≠p t·ª©c
        app.balance -= game.betAmount;
        game.updateBalanceUI();
        await supabaseClient.from('users').update({ balance: app.balance }).eq('id', app.user.id);

        // UI Update
        const btnUp = document.getElementById('btn-up');
        const btnDown = document.getElementById('btn-down');
        
        if (side === 'UP') {
            btnUp.classList.add('selected');
            btnDown.classList.add('disabled'); // Kh√≥a n√∫t c√≤n l·∫°i
            document.getElementById('badge-UP').innerText = game.betAmount.toLocaleString();
            document.getElementById('badge-UP').classList.remove('hidden');
        } else {
            btnDown.classList.add('selected');
            btnUp.classList.add('disabled');
            document.getElementById('badge-DOWN').innerText = game.betAmount.toLocaleString();
            document.getElementById('badge-DOWN').classList.remove('hidden');
        }
        
        app.showToast(`ƒê√£ c∆∞·ª£c ${side === 'UP' ? 'MUA' : 'B√ÅN'} ${game.betAmount.toLocaleString()}`, 'success');
      },

      // --- UI UTILS ---
      resetUI: () => {
        // Reset Buttons
        const btnUp = document.getElementById('btn-up');
        const btnDown = document.getElementById('btn-down');
        btnUp.className = "btn-action btn-up group";
        btnDown.className = "btn-action btn-down group";
        document.getElementById('badge-UP').classList.add('hidden');
        document.getElementById('badge-DOWN').classList.add('hidden');
        
        // Reset Progress Bar
        const bar = document.getElementById('main-progress');
        bar.className = "phase-bar bg-up";
        bar.style.width = '100%';
        
        // Reset Badge text
        const badge = document.getElementById('phase-badge');
        badge.innerText = "ƒê·∫∂T L·ªÜNH";
        badge.className = "inline-block px-2 py-0.5 rounded bg-up/20 text-up text-[10px] font-bold uppercase mb-1 backdrop-blur-md border border-up/30";

        // Hide Lock Line
        document.getElementById('lock-info').classList.add('hidden');
        document.getElementById('lock-info').classList.remove('flex');
        
        // Enable Chips
        document.querySelectorAll('.chip').forEach(c => c.style.pointerEvents = 'auto');
      },

      showModal: (isWin, amount, result) => {
        const overlay = document.getElementById('modal-overlay');
        const content = document.getElementById('modal-content');
        
        overlay.classList.remove('opacity-0', 'pointer-events-none');
        content.classList.remove('scale-90');
        content.classList.add('scale-100');
        
        const icon = document.getElementById('modal-icon');
        const title = document.getElementById('modal-title');
        const amt = document.getElementById('modal-amount');
        
        if (isWin) {
          icon.innerHTML = 'üèÜ';
          title.innerText = "TH·∫ÆNG L·ªöN";
          title.className = "text-3xl font-oswald font-bold uppercase mb-2 text-up";
          amt.innerText = "+" + amount.toLocaleString();
          amt.className = "font-mono text-2xl font-bold tracking-tight text-up";
        } else {
          icon.innerHTML = 'üìâ';
          title.innerText = "THUA CU·ªòC";
          title.className = "text-3xl font-oswald font-bold uppercase mb-2 text-[#848e9c]";
          amt.innerText = "-" + game.betAmount.toLocaleString();
          amt.className = "font-mono text-2xl font-bold tracking-tight text-[#848e9c]";
        }
        
        setTimeout(() => {
          overlay.classList.add('opacity-0', 'pointer-events-none');
          content.classList.add('scale-90');
          content.classList.remove('scale-100');
          game.startRound();
        }, 3000);
      }
    };

    window.onload = game.init;
  </script>
</body>
</html>

