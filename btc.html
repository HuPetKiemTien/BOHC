<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Crypto Pro - HC88</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;500;700;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
  <!-- SUPABASE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- CANVAS CONFETTI -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 
            oswald: ['Oswald', 'sans-serif'], 
            roboto: ['Roboto', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace']
          },
          colors: { 
            gold: '#FACC15', 
            up: '#2ebd85',     // Binance Green
            down: '#f6465d',   // Binance Red
            dark: '#1e2026',   // Binance Dark
            panel: '#2b3139'
          },
          boxShadow: { 
            'glow-up': '0 0 15px rgba(46, 189, 133, 0.4)',
            'glow-down': '0 0 15px rgba(246, 70, 93, 0.4)'
          },
          animation: {
            'flash-green': 'flashGreen 0.5s ease-out',
            'flash-red': 'flashRed 0.5s ease-out',
          },
          keyframes: {
            flashGreen: { '0%': { backgroundColor: 'rgba(46, 189, 133, 0.5)' }, '100%': { backgroundColor: 'transparent' } },
            flashRed: { '0%': { backgroundColor: 'rgba(246, 70, 93, 0.5)' }, '100%': { backgroundColor: 'transparent' } }
          }
        }
      }
    }
  </script>

  <style>
    /* CORE SETUP */
    body {
      background-color: #161a1e;
      color: #eaecef; overflow: hidden; touch-action: manipulation; user-select: none;
      -webkit-tap-highlight-color: transparent; font-family: 'Roboto', sans-serif;
      height: 100vh; height: 100dvh;
      display: flex; flex-direction: column;
    }
    
    /* CHART CONTAINER */
    #chart-wrapper {
      position: relative; flex: 1; width: 100%; overflow: hidden;
      background: #161a1e;
      cursor: crosshair;
    }
    canvas { display: block; width: 100%; height: 100%; }

    /* UI ELEMENTS */
    .glass-panel {
      background: #1e2329; border-top: 1px solid #2b3139;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
    }
    
    .btn-trade {
      position: relative; overflow: hidden; transition: all 0.1s;
      border-radius: 8px; font-weight: 700;
    }
    .btn-trade:active { transform: scale(0.98); }
    
    .btn-up { background: #2ebd85; color: white; }
    .btn-up.active-bet { box-shadow: inset 0 0 0 3px rgba(0,0,0,0.3), 0 0 15px #2ebd85; }
    
    .btn-down { background: #f6465d; color: white; }
    .btn-down.active-bet { box-shadow: inset 0 0 0 3px rgba(0,0,0,0.3), 0 0 15px #f6465d; }

    /* PRICE DISPLAY */
    .price-text { transition: color 0.2s; }
    .text-up { color: #2ebd85; }
    .text-down { color: #f6465d; }

    /* SENTIMENT BAR */
    .sentiment-bar { height: 4px; border-radius: 2px; overflow: hidden; display: flex; background: #2b3139; margin-top: 4px; }
    .sent-fill { height: 100%; transition: width 1s ease-in-out; }

    /* CHIPS */
    .chip { 
      height: 32px; padding: 0 12px; border-radius: 4px; 
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 11px; cursor: pointer; 
      background: #2b3139; color: #848e9c; border: 1px solid transparent;
      transition: all 0.2s; white-space: nowrap;
    }
    .chip.active { 
      background: #fcd535; color: #1e2329; border-color: #fcd535;
      font-weight: 900;
    }

    /* HISTORY */
    .dot { width: 4px; height: 12px; border-radius: 1px; margin-right: 2px; }
    .dot.U { background: #2ebd85; } .dot.D { background: #f6465d; }

    /* TICKER (Simulated trades) */
    .ticker-item { font-size: 10px; display: flex; justify-content: space-between; margin-bottom: 2px; opacity: 0.7; }
    .ticker-list { mask-image: linear-gradient(to bottom, black 50%, transparent 100%); }

    /* MODAL */
    .modal-enter { opacity: 0; transform: scale(0.95); }
    .modal-active { opacity: 1; transform: scale(1); }
    
    .pb-safe { padding-bottom: max(12px, env(safe-area-inset-bottom)); }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="h-14 bg-[#1e2329] border-b border-[#2b3139] flex items-center justify-between px-3 shrink-0 z-50">
    <div class="flex items-center gap-3">
      <a href="games.html" class="w-8 h-8 flex items-center justify-center text-[#848e9c] hover:text-white transition">
        <i class="fa-solid fa-arrow-left text-lg"></i>
      </a>
      <div>
        <div class="flex items-center gap-1.5 cursor-pointer">
          <i class="fa-solid fa-bars text-[#848e9c] text-xs"></i>
          <span class="font-bold text-base text-white">BTCUSDT</span>
          <span class="bg-[#2b3139] text-[#848e9c] text-[9px] px-1 rounded">Perpetual</span>
        </div>
        <div id="trend-stat" class="text-[10px] font-mono text-up flex items-center gap-1 leading-none mt-0.5">
          <span>+2.45%</span> <i class="fa-solid fa-caret-up"></i>
        </div>
      </div>
    </div>
    
    <div class="text-right">
      <div class="flex flex-col items-end">
        <span class="text-[9px] text-[#848e9c] font-bold">V√ç CH√çNH</span>
        <div class="flex items-center gap-1.5">
          <span id="balance" class="font-mono text-sm text-white font-bold">---</span>
          <span class="text-gold text-[10px] font-bold">COIN</span>
        </div>
      </div>
    </div>
  </header>

  <!-- CHART & OVERLAYS -->
  <div id="chart-wrapper">
    <!-- PRICE OVERLAY (Top Left) -->
    <div class="absolute top-4 left-4 z-10 pointer-events-none">
      <div id="live-price" class="font-mono text-3xl font-bold tracking-tight text-up">95,420.50</div>
      <div class="text-[10px] text-[#848e9c] mt-1">Mark Price</div>
    </div>

    <!-- COUNTDOWN (Top Right) -->
    <div class="absolute top-4 right-4 z-10 flex flex-col items-end pointer-events-none">
      <div id="phase-badge" class="px-2 py-0.5 rounded bg-[#2ebd85]/20 text-[#2ebd85] text-[10px] font-bold uppercase mb-1">ƒê·∫∑t l·ªánh</div>
      <div class="font-mono text-3xl font-bold text-white" id="timer-display">30</div>
      <div class="w-full h-1 bg-[#2b3139] rounded-full mt-1 overflow-hidden">
        <div id="timer-bar" class="h-full bg-gold transition-all duration-1000 ease-linear w-full"></div>
      </div>
    </div>
    
    <!-- CANVAS -->
    <canvas id="pro-chart"></canvas>

    <!-- FAKE TRADES (Bottom Left - Floating) -->
    <div class="absolute bottom-4 left-3 z-10 w-24 pointer-events-none">
      <div class="text-[9px] text-[#848e9c] font-bold mb-1 uppercase">Giao d·ªãch g·∫ßn ƒë√¢y</div>
      <div id="ticker-box" class="ticker-list h-16 overflow-hidden flex flex-col-reverse">
        <!-- JS will populate -->
      </div>
    </div>
  </div>

  <!-- CONTROL PANEL -->
  <div class="glass-panel z-20 pb-safe">
    
    <!-- SENTIMENT & HISTORY -->
    <div class="px-3 py-2 border-b border-[#2b3139] flex items-center justify-between bg-[#1e2329]">
      <div class="w-1/3">
        <div class="flex justify-between text-[9px] text-[#848e9c] font-bold mb-0.5">
          <span class="text-up">Mua 65%</span>
          <span class="text-down">35% B√°n</span>
        </div>
        <div class="sentiment-bar">
          <div class="sent-fill bg-up w-[65%]"></div>
          <div class="sent-fill bg-down w-[35%]"></div>
        </div>
      </div>
      <div class="flex items-center gap-0.5" id="roadmap">
        <!-- History dots -->
      </div>
    </div>

    <!-- BETTING CONTROLS -->
    <div class="p-3">
      <!-- Buttons -->
      <div class="grid grid-cols-2 gap-3 mb-3">
        <button id="btn-up" class="btn-trade btn-up h-12 flex items-center justify-between px-4 group" onclick="game.selectSide('UP')">
          <span class="font-bold text-lg">MUA (L√™n)</span>
          <div class="flex flex-col items-end leading-none">
            <span class="text-[10px] opacity-80">Payout</span>
            <span class="font-mono text-sm font-bold">1.95x</span>
          </div>
          <div id="badge-UP" class="absolute inset-0 bg-black/20 hidden flex items-center justify-center font-mono font-bold text-gold border-2 border-gold rounded-lg"></div>
        </button>

        <button id="btn-down" class="btn-trade btn-down h-12 flex items-center justify-between px-4 group" onclick="game.selectSide('DOWN')">
          <span class="font-bold text-lg">B√ÅN (Xu·ªëng)</span>
          <div class="flex flex-col items-end leading-none">
            <span class="text-[10px] opacity-80">Payout</span>
            <span class="font-mono text-sm font-bold">1.95x</span>
          </div>
          <div id="badge-DOWN" class="absolute inset-0 bg-black/20 hidden flex items-center justify-center font-mono font-bold text-gold border-2 border-gold rounded-lg"></div>
        </button>
      </div>

      <!-- Amount Input -->
      <div class="flex items-center gap-2 mb-1">
        <div class="flex-1 overflow-x-auto no-scrollbar flex items-center gap-2">
            <div class="chip" onclick="game.setAmount(5000)">5k</div>
            <div class="chip active" onclick="game.setAmount(10000)">10k</div>
            <div class="chip" onclick="game.setAmount(50000)">50k</div>
            <div class="chip" onclick="game.setAmount(100000)">100k</div>
            <div class="chip" onclick="game.setAmount(500000)">500k</div>
            <div class="chip" onclick="game.setAmount(app.balance)">All-in</div>
        </div>
        <button onclick="game.confirmBet()" class="h-8 px-4 rounded bg-[#fcd535] text-[#1e2329] font-black text-xs uppercase shadow hover:bg-[#ffe252] active:scale-95 transition">
          X√ÅC NH·∫¨N
        </button>
      </div>
    </div>
  </div>

  <!-- RESULT MODAL -->
  <div id="modal-overlay" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300">
    <div id="modal-content" class="bg-[#1e2329] border border-[#2b3139] rounded-2xl p-6 w-72 text-center transform scale-95 transition-transform duration-300 shadow-2xl relative overflow-hidden">
      <!-- Glow -->
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-gold to-transparent"></div>
      
      <div id="modal-icon" class="text-5xl mb-3"></div>
      <div id="modal-title" class="text-2xl font-bold text-white uppercase mb-1"></div>
      <div id="modal-amount" class="font-mono text-xl font-bold"></div>
      
      <button onclick="game.closeModal()" class="mt-5 w-full py-2 rounded bg-[#2b3139] text-[#848e9c] font-bold text-xs hover:text-white transition">ƒê√ìNG</button>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="fixed top-16 left-1/2 -translate-x-1/2 bg-[#1e2329]/90 backdrop-blur border border-[#2b3139] px-4 py-2 rounded-full flex items-center gap-3 opacity-0 pointer-events-none transition-all duration-300 z-[200] shadow-xl w-max">
    <i id="toast-icon" class="fa-solid fa-info-circle text-xs"></i>
    <span id="toast-msg" class="text-[11px] font-bold text-white uppercase tracking-wider">Th√¥ng b√°o</span>
  </div>

  <script>
    // ===== 1. CONFIG =====
    const CONFIG = {
      ROUND_TIME: 30,
      BET_TIME: 20, // 20s bet, 10s lock
      ODDS: 1.95,
      MIN_BET: 2000
    };

    // Supabase Setup
    const SUPABASE_URL = 'https://sfbaytcmpgceapdcdyer.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmYmF5dGNtcGdjZWFwZGNkeWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NDQ2MzYsImV4cCI6MjA4MTEyMDYzNn0.DeXO91pcCzQJHMcXTk9Eilcsk9IoGIPzOM-Ube4zRb8';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===== 2. APP STATE =====
    const app = {
      user: null,
      balance: 0,
      
      showToast: (msg, type='info') => {
        const t = document.getElementById("toast");
        const i = document.getElementById("toast-icon");
        document.getElementById("toast-msg").innerText = msg;
        if (type === 'error') { i.className = "fa-solid fa-circle-xmark text-down"; }
        else if (type === 'success') { i.className = "fa-solid fa-circle-check text-up"; }
        else { i.className = "fa-solid fa-info-circle text-gold"; }
        t.classList.remove("opacity-0", "pointer-events-none");
        setTimeout(() => t.classList.add("opacity-0", "pointer-events-none"), 3000);
      }
    };

    // ===== 3. PRO CHART ENGINE =====
    const chart = {
      canvas: document.getElementById('pro-chart'),
      ctx: null,
      data: [], // {price, time}
      maxPoints: 120, // ~2 mins of data at 1fps
      width: 0,
      height: 0,
      currentPrice: 95420.50,
      
      init: () => {
        chart.ctx = chart.canvas.getContext('2d');
        window.addEventListener('resize', chart.resize);
        chart.resize();
        
        // Seed initial data
        let p = chart.currentPrice;
        for(let i=0; i<chart.maxPoints; i++) {
          p += (Math.random()-0.5)*10;
          chart.data.push(p);
        }
        chart.currentPrice = p;
        requestAnimationFrame(chart.draw);
      },

      resize: () => {
        const wrap = document.getElementById('chart-wrapper');
        chart.width = wrap.clientWidth;
        chart.height = wrap.clientHeight;
        chart.canvas.width = chart.width * 2; // Retina
        chart.canvas.height = chart.height * 2;
        chart.ctx.scale(2, 2);
      },

      tick: () => {
        // Volatility logic
        const volatility = 25;
        const change = (Math.random() - 0.5) * volatility;
        chart.currentPrice += change;
        chart.data.push(chart.currentPrice);
        if(chart.data.length > chart.maxPoints) chart.data.shift();

        // Update DOM Price
        const el = document.getElementById('live-price');
        el.innerText = chart.currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        el.className = change >= 0 ? "font-mono text-3xl font-bold tracking-tight text-up" : "font-mono text-3xl font-bold tracking-tight text-down";
        
        // Fake Ticker
        game.addFakeTrade(chart.currentPrice, change >= 0);
      },

      draw: () => {
        const { ctx, width, height, data } = chart;
        ctx.clearRect(0, 0, width, height);

        // 1. Calculate Range (Auto-scale)
        const minVal = Math.min(...data);
        const maxVal = Math.max(...data);
        const range = maxVal - minVal || 1;
        const padding = height * 0.2; // 20% vertical padding
        
        const getY = (price) => height - padding - ((price - minVal) / range) * (height - 2*padding);
        const stepX = width / (data.length - 1);

        // 2. Draw Grid Lines
        ctx.strokeStyle = '#2b3139';
        ctx.lineWidth = 1;
        ctx.beginPath();
        // Horizontal lines
        for(let i=1; i<5; i++) {
            const y = (height/5) * i;
            ctx.moveTo(0, y); ctx.lineTo(width, y);
        }
        ctx.stroke();

        // 3. Draw Main Line Area
        ctx.beginPath();
        data.forEach((p, i) => {
            const x = i * stepX;
            const y = getY(p);
            if(i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });

        // Determine Line Color based on Game State
        let strokeColor = '#fcd535'; // Default Gold/Neutral
        if (game.phase === 'LOCKED') {
            strokeColor = chart.currentPrice >= game.lockPrice ? '#2ebd85' : '#f6465d';
        }

        ctx.strokeStyle = strokeColor;
        ctx.lineWidth = 2.5;
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        ctx.stroke();

        // 4. Gradient Fill
        ctx.lineTo(width, height);
        ctx.lineTo(0, height);
        ctx.closePath();
        const gradient = ctx.createLinearGradient(0, 0, 0, height);
        gradient.addColorStop(0, strokeColor + '40'); // 25% opacity
        gradient.addColorStop(1, strokeColor + '00'); // 0% opacity
        ctx.fillStyle = gradient;
        ctx.fill();

        // 5. Draw Lock Line (if locked)
        if (game.phase === 'LOCKED') {
            const lockY = getY(game.lockPrice);
            ctx.beginPath();
            ctx.setLineDash([4, 4]);
            ctx.strokeStyle = '#eaecef';
            ctx.lineWidth = 1;
            ctx.moveTo(0, lockY);
            ctx.lineTo(width, lockY);
            ctx.stroke();
            ctx.setLineDash([]); // Reset

            // Lock Label
            ctx.fillStyle = '#eaecef';
            ctx.font = '10px JetBrains Mono';
            ctx.fillText('LOCK: ' + game.lockPrice.toFixed(2), width - 90, lockY - 6);
        }

        // 6. Draw Pulsing Head
        const lastX = (data.length - 1) * stepX;
        const lastY = getY(data[data.length - 1]);
        
        // Glow ring
        ctx.beginPath();
        ctx.arc(lastX, lastY, 6, 0, Math.PI * 2);
        ctx.fillStyle = strokeColor;
        ctx.fill();
        
        ctx.beginPath();
        ctx.arc(lastX, lastY, 12, 0, Math.PI * 2);
        ctx.fillStyle = strokeColor + '40';
        ctx.fill();

        // Current Price Label Line
        ctx.beginPath();
        ctx.setLineDash([2, 2]);
        ctx.strokeStyle = strokeColor;
        ctx.lineWidth = 1;
        ctx.moveTo(0, lastY);
        ctx.lineTo(width, lastY);
        ctx.stroke();
        ctx.setLineDash([]);

        requestAnimationFrame(chart.draw);
      }
    };

    // ===== 4. GAME LOGIC =====
    const game = {
      phase: 'BET', 
      timeLeft: CONFIG.BET_TIME,
      lockPrice: 0,
      
      selectedSide: null,
      betAmount: 10000,
      confirmedBet: null, // { side, amount, atPrice }
      
      timerInterval: null,

      init: async () => {
        const uid = localStorage.getItem("my_wallet_uid");
        if (!uid) { alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!"); window.location.href = "index.html"; return; }
        
        app.user = { id: uid };
        await game.loadBalance();
        game.setupRealtimeBalance();
        
        chart.init();
        setInterval(chart.tick, 1000); // Update price every second
        
        // Fake activity
        setInterval(() => {
            const r = Math.random();
            if(r > 0.7) game.addFakeTrade(chart.currentPrice, r > 0.85);
        }, 300);

        game.startRound();
      },

      loadBalance: async () => {
        const { data } = await supabaseClient.from('users').select('balance').eq('id', app.user.id).maybeSingle();
        if (data) { app.balance = data.balance; game.updateBalanceUI(); }
      },

      setupRealtimeBalance: () => {
        supabaseClient.channel('wallet-changes').on('postgres_changes', 
          { event: 'UPDATE', schema: 'public', table: 'users', filter: `id=eq.${app.user.id}` },
          (payload) => { app.balance = payload.new.balance; game.updateBalanceUI(); }
        ).subscribe();
      },

      updateBalanceUI: () => {
        document.getElementById("balance").innerText = app.balance.toLocaleString('en-US');
      },

      startRound: () => {
        game.phase = 'BET';
        game.timeLeft = CONFIG.BET_TIME;
        game.lockPrice = 0;
        game.confirmedBet = null;
        game.selectedSide = null;
        
        // UI Reset
        document.getElementById('phase-badge').innerText = "ƒê·∫∂T L·ªÜNH";
        document.getElementById('phase-badge').className = "px-2 py-0.5 rounded bg-[#2ebd85]/20 text-[#2ebd85] text-[10px] font-bold uppercase mb-1";
        document.getElementById('badge-UP').classList.add('hidden');
        document.getElementById('badge-DOWN').classList.add('hidden');
        document.getElementById('btn-up').classList.remove('opacity-50', 'pointer-events-none');
        document.getElementById('btn-down').classList.remove('opacity-50', 'pointer-events-none');
        
        if (game.timerInterval) clearInterval(game.timerInterval);
        
        game.timerInterval = setInterval(() => {
          game.timeLeft--;
          
          const totalTime = CONFIG.ROUND_TIME;
          const progress = (game.timeLeft / totalTime) * 100;
          document.getElementById('timer-bar').style.width = progress + '%';
          document.getElementById('timer-display').innerText = game.timeLeft;

          if (game.timeLeft === (CONFIG.ROUND_TIME - CONFIG.BET_TIME)) {
            game.lockPhase();
          }

          if (game.timeLeft <= 0) {
            game.settleRound();
            clearInterval(game.timerInterval);
            setTimeout(game.startRound, 5000); // 5s break
          }
        }, 1000);
      },

      lockPhase: () => {
        game.phase = 'LOCKED';
        game.lockPrice = chart.currentPrice;
        
        document.getElementById('phase-badge').innerText = "CH·ªú K·∫æT QU·∫¢";
        document.getElementById('phase-badge').className = "px-2 py-0.5 rounded bg-[#fcd535]/20 text-[#fcd535] text-[10px] font-bold uppercase mb-1";
        
        // Disable inputs
        document.getElementById('btn-up').classList.add('opacity-50', 'pointer-events-none');
        document.getElementById('btn-down').classList.add('opacity-50', 'pointer-events-none');
      },

      settleRound: () => {
        game.phase = 'RESULT';
        const result = chart.currentPrice >= game.lockPrice ? 'UP' : 'DOWN';
        
        // Add dot
        const rm = document.getElementById('roadmap');
        const dot = document.createElement('div');
        dot.className = `dot ${result === 'UP' ? 'U' : 'D'}`;
        rm.appendChild(dot);
        if(rm.children.length > 20) rm.removeChild(rm.firstChild);

        // Win/Loss Logic
        if (game.confirmedBet) {
            const win = game.confirmedBet.side === result;
            if (win) {
                const profit = Math.floor(game.confirmedBet.amount * CONFIG.ODDS);
                app.balance += profit;
                game.syncBalance();
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                game.showModal(true, profit, result);
            } else {
                game.showModal(false, 0, result);
            }
        } else {
            // Show passive notification
            app.showToast(`K·∫øt qu·∫£: ${result === 'UP' ? 'MUA Th·∫Øng' : 'B√ÅN Th·∫Øng'}`, 'info');
        }
      },

      // --- USER ACTIONS ---
      setAmount: (val) => {
        game.betAmount = val;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        // Visual toggle logic for chip... (simplified here)
        app.showToast(`ƒê√£ ch·ªçn m·ª©c c∆∞·ª£c: ${val.toLocaleString()}`, 'info');
      },

      selectSide: (side) => {
        if(game.phase !== 'BET') return;
        game.selectedSide = side;
        
        // Visual toggle
        document.getElementById('btn-up').classList.remove('active-bet');
        document.getElementById('btn-down').classList.remove('active-bet');
        
        if (side === 'UP') document.getElementById('btn-up').classList.add('active-bet');
        else document.getElementById('btn-down').classList.add('active-bet');
      },

      confirmBet: async () => {
        if(game.phase !== 'BET') return app.showToast("ƒê√£ kh√≥a ƒë·∫∑t l·ªánh!", 'error');
        if(!game.selectedSide) return app.showToast("Vui l√≤ng ch·ªçn MUA ho·∫∑c B√ÅN", 'error');
        if(game.betAmount > app.balance) return app.showToast("S·ªë d∆∞ kh√¥ng ƒë·ªß", 'error');

        // Deduct balance
        app.balance -= game.betAmount;
        game.updateBalanceUI();
        await game.syncBalance(); // Server sync

        game.confirmedBet = { side: game.selectedSide, amount: game.betAmount };
        
        // Show Badge
        const badgeId = game.selectedSide === 'UP' ? 'badge-UP' : 'badge-DOWN';
        const badge = document.getElementById(badgeId);
        badge.classList.remove('hidden');
        badge.innerText = game.betAmount.toLocaleString();
        
        app.showToast("ƒê·∫∑t l·ªánh th√†nh c√¥ng!", 'success');
      },

      syncBalance: async () => {
        await supabaseClient.from('users').update({ balance: app.balance }).eq('id', app.user.id);
      },

      // --- UTILS ---
      addFakeTrade: (price, isBuy) => {
        const box = document.getElementById('ticker-box');
        const div = document.createElement('div');
        div.className = 'ticker-item';
        const time = new Date().toTimeString().split(' ')[0];
        const amt = (Math.random() * 0.5).toFixed(4);
        
        div.innerHTML = `
          <span class="font-mono text-[#848e9c]">${time}</span>
          <span class="font-mono ${isBuy ? 'text-up' : 'text-down'}">${price.toFixed(1)}</span>
          <span class="font-mono text-white text-right">${amt}</span>
        `;
        box.prepend(div);
        if(box.children.length > 6) box.removeChild(box.lastChild);
      },

      showModal: (isWin, amount, result) => {
        const overlay = document.getElementById('modal-overlay');
        const content = document.getElementById('modal-content');
        
        overlay.classList.remove('opacity-0', 'pointer-events-none');
        content.classList.remove('scale-95');
        content.classList.add('scale-100');
        
        document.getElementById('modal-icon').innerHTML = isWin ? 'üèÜ' : 'üìâ';
        document.getElementById('modal-title').innerText = isWin ? 'Th·∫Øng L·ªõn' : 'Thua Cu·ªôc';
        document.getElementById('modal-title').className = `text-2xl font-bold uppercase mb-1 ${isWin ? 'text-up' : 'text-[#848e9c]'}`;
        
        document.getElementById('modal-amount').innerText = isWin ? `+${amount.toLocaleString()}` : '0.00';
        document.getElementById('modal-amount').className = `font-mono text-xl font-bold ${isWin ? 'text-gold' : 'text-[#848e9c]'}`;
      },

      closeModal: () => {
        const overlay = document.getElementById('modal-overlay');
        const content = document.getElementById('modal-content');
        overlay.classList.add('opacity-0', 'pointer-events-none');
        content.classList.add('scale-95');
        content.classList.remove('scale-100');
      }
    };

    window.onload = game.init;
  </script>
</body>
</html>

