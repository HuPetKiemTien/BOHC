<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>BTC 60s Smooth - HC88</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;500;700;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 
            oswald: ['Oswald', 'sans-serif'], 
            roboto: ['Roboto', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace']
          },
          colors: { 
            gold: '#FACC15', 
            up: '#2ebd85',     
            down: '#f6465d',   
            dark: '#161a1e',
            card: '#1e2329',
            line: '#2b3139'
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #161a1e; color: #eaecef; overflow: hidden; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Roboto', sans-serif; height: 100vh; height: 100dvh; display: flex; flex-direction: column; }
    
    #chart-container { flex: 1; width: 100%; position: relative; background: #161a1e; border-bottom: 1px solid #2b3139; cursor: crosshair; }
    canvas { display: block; width: 100%; height: 100%; }

    /* UI COMPONENTS */
    .btn-action { 
        position: relative; overflow: hidden; transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center;
        border: 1px solid rgba(255,255,255,0.05); background: #2b3139;
    }
    .btn-action:active { transform: scale(0.92); } /* Hi·ªáu ·ª©ng l√∫n s√¢u h∆°n */
    .btn-action.disabled { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
    
    .btn-up { color: #2ebd85; border-color: rgba(46,189,133,0.2); }
    .btn-up.selected { background: rgba(46,189,133,0.2); border-color: #2ebd85; box-shadow: 0 0 15px rgba(46,189,133,0.3); }
    
    .btn-down { color: #f6465d; border-color: rgba(246,70,93,0.2); }
    .btn-down.selected { background: rgba(246,70,93,0.2); border-color: #f6465d; box-shadow: 0 0 15px rgba(246,70,93,0.3); }

    /* RIPPLE EFFECT */
    .ripple {
        position: absolute; border-radius: 50%; background: rgba(255, 255, 255, 0.3);
        transform: scale(0); animation: ripple 0.6s linear; pointer-events: none;
    }
    @keyframes ripple { to { transform: scale(4); opacity: 0; } }

    /* BET FLYING TEXT */
    .bet-fly {
        position: absolute; font-family: 'JetBrains Mono', monospace; font-weight: 800; font-size: 14px;
        pointer-events: none; animation: betFly 0.8s ease-out forwards; z-index: 100;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    @keyframes betFly {
        0% { opacity: 1; transform: translateY(0) scale(1); }
        100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
    }

    .chip { height: 36px; min-width: 55px; padding: 0 10px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 11px; cursor: pointer; background: #2b3139; color: #848e9c; transition: all 0.2s; white-space: nowrap; border: 1px solid transparent; }
    .chip.active { background: #FACC15; color: #1e2329; border-color: #FACC15; font-weight: 900; box-shadow: 0 2px 8px rgba(250, 204, 21, 0.3); }
    
    .btn-cancel { height: 36px; padding: 0 16px; border-radius: 8px; background: #363c45; color: #fff; font-weight: bold; font-size: 11px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.1); white-space: nowrap; flex-shrink: 0; }
    .btn-cancel:active { background: #4a5059; }

    .bet-badge { background: #fff; color: #000; font-family: 'JetBrains Mono', monospace; font-weight: 800; font-size: 10px; padding: 2px 6px; border-radius: 4px; position: absolute; top: 8px; right: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

    /* HISTORY DOTS */
    .hist-dot { width: 6px; height: 6px; border-radius: 50%; margin: 1px; }
    .hist-up { background: #2ebd85; box-shadow: 0 0 4px #2ebd85; }
    .hist-down { background: #f6465d; box-shadow: 0 0 4px #f6465d; }

    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-40px) scale(1.1); } }
    .float-money { position: fixed; top: 70px; right: 20px; font-family: 'JetBrains Mono', monospace; font-weight: 800; color: #2ebd85; font-size: 20px; pointer-events: none; animation: floatUp 2s ease-out forwards; z-index: 9999; text-shadow: 0 2px 8px rgba(0,0,0,0.8); }

    .grid-bg { background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px); background-size: 40px 40px; }
    .pb-safe { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="h-14 flex items-center justify-between px-4 shrink-0 bg-[#161a1e] border-b border-[#2b3139] z-50">
    <div class="flex items-center gap-3">
      <a href="games.html" class="w-9 h-9 rounded-xl bg-[#2b3139] flex items-center justify-center text-[#848e9c] active:scale-95 transition">
        <i class="fa-solid fa-chevron-left text-sm"></i>
      </a>
      <div class="flex items-center gap-2">
        <div class="w-9 h-9 rounded-full bg-orange-500/10 flex items-center justify-center border border-orange-500/20">
            <i class="fa-brands fa-bitcoin text-[#F7931A] text-xl"></i>
        </div>
        <div>
          <div class="font-bold text-sm text-white leading-none">BTC/USDT</div>
          <div class="text-[10px] text-[#848e9c] font-bold mt-0.5">Phi√™n: <span id="session-id" class="text-gold font-mono">...</span></div>
        </div>
      </div>
    </div>
    <div class="text-right">
      <div class="text-[9px] text-[#848e9c] font-bold uppercase tracking-wider mb-0.5">T√†i s·∫£n</div>
      <div class="flex items-center justify-end gap-1.5" id="balance-container">
        <span id="balance" class="font-mono text-sm text-white font-bold">---</span>
        <span class="text-gold text-[10px] font-black">$</span>
      </div>
    </div>
  </header>

  <!-- PROGRESS BAR -->
  <div class="w-full bg-[#2b3139] h-1 shrink-0 relative">
    <div id="phase-bar" class="h-full bg-up w-full transition-all duration-300 ease-linear"></div>
  </div>

  <!-- CHART AREA -->
  <div id="chart-container" class="grid-bg">
    
    <!-- LEFT: TIMER & PHASE -->
    <div class="absolute top-4 left-4 z-10 text-left pointer-events-none">
      <div class="flex flex-col items-start gap-1">
        <span id="phase-badge" class="px-2 py-0.5 rounded bg-up/20 text-up text-[10px] font-bold uppercase backdrop-blur border border-up/30">ƒê·∫∂T L·ªÜNH</span>
        <span class="font-oswald text-4xl font-bold text-white drop-shadow-md w-12" id="timer-display">30</span>
        <span class="text-[9px] text-[#848e9c] uppercase font-bold tracking-wider">Gi√¢y c√≤n l·∫°i</span>
      </div>
    </div>

    <!-- RIGHT: LIVE PRICE (SMOOTH & STABLE) -->
    <div class="absolute top-4 right-4 z-10 text-right pointer-events-none">
      <div id="live-price" class="font-mono text-3xl font-bold tracking-tighter text-up drop-shadow-md transition-colors duration-200">--.--</div>
      <!-- Removed percentage -->
    </div>

    <!-- CANVAS -->
    <canvas id="candle-chart"></canvas>

    <!-- LOCK LINE INFO -->
    <div id="lock-label" class="absolute left-1/2 -translate-x-1/2 bg-[#FACC15] text-black text-[10px] font-mono font-bold px-2 py-0.5 rounded shadow hidden z-20 pointer-events-none border border-white/20">
      LOCK: <span id="lock-price-val"></span>
    </div>
  </div>

  <!-- CONTROLS -->
  <div id="controls-container" class="bg-[#1e2329] z-50 pb-safe shadow-[0_-10px_40px_rgba(0,0,0,0.6)]">
    
    <!-- HISTORY BAR -->
    <div class="px-4 py-2 border-b border-[#2b3139] flex items-center justify-between bg-[#161a1e]">
      <div class="flex items-center gap-2">
        <div class="w-2 h-2 rounded-full bg-up animate-pulse"></div>
        <span class="text-[10px] font-bold text-[#848e9c] uppercase tracking-wide">L·ªãch s·ª≠ phi√™n</span>
      </div>
      <div id="roadmap" class="flex items-center gap-1 overflow-hidden justify-end h-4"></div>
    </div>

    <!-- CHIP SELECTOR -->
    <div class="flex items-center px-4 py-3 border-b border-[#2b3139]">
        <button onclick="game.cancelBet()" class="btn-cancel active:scale-95 transition shadow-lg mr-3">
            <i class="fa-solid fa-rotate-left mr-1.5 text-red-400"></i> H·ª¶Y
        </button>
        <div class="w-[1px] h-6 bg-[#2b3139] mr-3 shrink-0"></div>
        <div class="flex-1 overflow-x-auto no-scrollbar flex items-center gap-2">
            <div class="chip" onclick="game.setChip(2000)">2k</div>
            <div class="chip" onclick="game.setChip(5000)">5k</div>
            <div class="chip active" onclick="game.setChip(10000)">10k</div>
            <div class="chip" onclick="game.setChip(50000)">50k</div>
            <div class="chip" onclick="game.setChip(100000)">100k</div>
            <div class="chip" onclick="game.setChip(500000)">500k</div>
        </div>
    </div>

    <!-- BET BUTTONS -->
    <div class="p-4 grid grid-cols-2 gap-4 h-24">
      <button id="btn-up" class="btn-action btn-up h-full group" onclick="game.placeBet(event, 'UP')">
        <div class="flex flex-col items-center gap-0.5 pointer-events-none">
          <div class="flex items-center gap-2">
            <i class="fa-solid fa-arrow-trend-up text-xl mb-1"></i>
            <span class="font-oswald text-2xl font-bold text-white">MUA</span>
          </div>
          <span class="text-[10px] opacity-70 font-mono text-white/50 group-[.selected]:text-up group-[.selected]:opacity-100">Payout x1.95</span>
        </div>
        <div id="badge-UP" class="bet-badge hidden"></div>
      </button>

      <button id="btn-down" class="btn-action btn-down h-full group" onclick="game.placeBet(event, 'DOWN')">
        <div class="flex flex-col items-center gap-0.5 pointer-events-none">
          <div class="flex items-center gap-2">
            <i class="fa-solid fa-arrow-trend-down text-xl mb-1"></i>
            <span class="font-oswald text-2xl font-bold text-white">B√ÅN</span>
          </div>
          <span class="text-[10px] opacity-70 font-mono text-white/50 group-[.selected]:text-down group-[.selected]:opacity-100">Payout x1.95</span>
        </div>
        <div id="badge-DOWN" class="bet-badge hidden"></div>
      </button>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modal-overlay" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300">
    <div id="modal-content" class="bg-[#1e2329] border border-white/10 rounded-3xl p-6 w-72 text-center transform scale-90 transition-transform duration-300 shadow-2xl relative overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-white/5 to-transparent pointer-events-none"></div>
      <div id="modal-icon" class="text-6xl mb-4 drop-shadow-2xl animate-bounce"></div>
      <div id="modal-title" class="text-3xl font-oswald font-bold uppercase mb-2"></div>
      <div id="modal-amount" class="font-mono text-2xl font-bold tracking-tight"></div>
      <div class="mt-6 w-full h-1 bg-[#2b3139] rounded overflow-hidden">
        <div class="h-full bg-gold animate-[width_3s_linear_reverse] w-full"></div>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-[#1e2329]/95 backdrop-blur border border-white/10 px-5 py-2.5 rounded-full flex items-center gap-3 opacity-0 pointer-events-none transition-all duration-300 z-[9999] shadow-2xl w-max max-w-[90%] transform -translate-y-5">
    <i id="toast-icon" class="fa-solid fa-info-circle text-xs"></i>
    <span id="toast-msg" class="text-[11px] font-bold text-white uppercase tracking-wider">Th√¥ng b√°o</span>
  </div>

  <script>
    // ===== 1. C·∫§U H√åNH LOGIC =====
    const CONFIG = {
      PHASE_BET: 30,    // 0-30s
      PHASE_WAIT: 25,   // 30-55s
      PHASE_RESULT: 5,  // 55-60s
      CANDLE_TIME: 15000, // 15 GI√ÇY = 1 N·∫æN
      ODDS: 1.95,
      BASE_PRICE: 96500.00,
      LIMITS: { MIN: 2000, MAX: 500000 }
    };

    const SUPABASE_URL = 'https://sfbaytcmpgceapdcdyer.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmYmF5dGNtcGdjZWFwZGNkeWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NDQ2MzYsImV4cCI6MjA4MTEyMDYzNn0.DeXO91pcCzQJHMcXTk9Eilcsk9IoGIPzOM-Ube4zRb8';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===== 2. MARKET LOGIC (SMOOTH & STABLE) =====
    function seededRandom(seed) { var x = Math.sin(seed++) * 10000; return x - Math.floor(x); }

    // Logic gi√° ·ªïn ƒë·ªãnh h∆°n (gi·∫£m bi√™n ƒë·ªô dao ƒë·ªông ng·∫´u nhi√™n)
    function getFairPrice(candleIndex) {
        const longTrend = Math.sin(candleIndex / 40) * 150; 
        const shortTrend = Math.sin(candleIndex / 8) * 50;
        const seed = candleIndex;
        const rand = seededRandom(seed);
        // Gi·∫£m noise t·ª´ 25 xu·ªëng 15 ƒë·ªÉ b·ªõt gi·∫≠t
        const noise = (rand - 0.5) * 15; 
        return CONFIG.BASE_PRICE + longTrend + shortTrend + noise;
    }

    function generateCandleData(candleIndex) {
        const close = getFairPrice(candleIndex);
        const open = getFairPrice(candleIndex - 1);
        const seed = candleIndex * 1.1;
        const volatility = Math.abs(close - open) + 5; 
        const randHigh = seededRandom(seed) * volatility;
        const randLow = seededRandom(seed + 0.1) * volatility;
        return { open, close, high: Math.max(open, close) + randHigh, low: Math.min(open, close) - randLow, type: close >= open ? 'UP' : 'DOWN' };
    }

    // ===== 3. APP STATE =====
    const app = {
      user: null, balance: 0,
      showToast: (msg, type='info') => {
        const t = document.getElementById("toast");
        const i = document.getElementById("toast-icon");
        document.getElementById("toast-msg").innerText = msg;
        t.className = "fixed top-20 left-1/2 -translate-x-1/2 bg-[#1e2329]/95 backdrop-blur border border-white/10 px-5 py-2.5 rounded-full flex items-center gap-3 transition-all duration-300 z-[9999] shadow-2xl w-max max-w-[90%]";
        if (type === 'error') { i.className = "fa-solid fa-circle-xmark text-down"; t.classList.add('border-down/50'); }
        else if (type === 'success') { i.className = "fa-solid fa-circle-check text-up"; t.classList.add('border-up/50'); }
        else { i.className = "fa-solid fa-info-circle text-gold"; }
        t.classList.remove("opacity-0", "pointer-events-none", "-translate-y-5");
        setTimeout(() => { t.classList.add("opacity-0", "pointer-events-none", "-translate-y-5"); }, 3000);
      }
    };

    // ===== 4. CHART ENGINE (ULTRA SMOOTH) =====
    const chart = {
      canvas: document.getElementById('candle-chart'),
      ctx: null, width: 0, height: 0,
      candles: [], currentCandle: null, serverCandleIndex: 0, 
      
      // Smoothing
      visualPrice: CONFIG.BASE_PRICE, 
      
      init: () => {
        chart.ctx = chart.canvas.getContext('2d');
        window.addEventListener('resize', chart.resize);
        chart.resize();
        
        const nowMs = Date.now();
        const nowIndex = Math.floor(nowMs / CONFIG.CANDLE_TIME);
        
        for(let idx = nowIndex - 30; idx < nowIndex; idx++) {
            chart.candles.push(generateCandleData(idx));
        }
        
        chart.serverCandleIndex = nowIndex;
        const initData = generateCandleData(nowIndex);
        chart.currentCandle = { 
            open: initData.open, close: initData.open, 
            high: initData.open, low: initData.open,
            targetClose: initData.close
        };
        chart.visualPrice = initData.open;
        
        requestAnimationFrame(chart.draw);
      },

      resize: () => {
        const wrap = document.getElementById('chart-container');
        chart.width = wrap.clientWidth; chart.height = wrap.clientHeight;
        chart.canvas.width = chart.width * 2; chart.canvas.height = chart.height * 2;
        chart.ctx.scale(2, 2);
      },

      update: () => {
        const now = Date.now();
        const nowIndex = Math.floor(now / CONFIG.CANDLE_TIME);
        
        if (nowIndex > chart.serverCandleIndex) {
            chart.currentCandle.close = chart.currentCandle.targetClose;
            chart.currentCandle.high = Math.max(chart.currentCandle.high, chart.currentCandle.close);
            chart.currentCandle.low = Math.min(chart.currentCandle.low, chart.currentCandle.close);
            
            chart.candles.push({...chart.currentCandle});
            if(chart.candles.length > 30) chart.candles.shift();
            
            const nextData = generateCandleData(nowIndex);
            chart.currentCandle = {
                open: nextData.open, close: nextData.open,
                high: nextData.open, low: nextData.open,
                targetClose: nextData.close
            };
            chart.serverCandleIndex = nowIndex;
        }

        // Logic Lerp Price (M∆∞·ª£t nh∆∞ n∆∞·ªõc)
        const progress = (now % CONFIG.CANDLE_TIME) / CONFIG.CANDLE_TIME; 
        const targetClose = chart.currentCandle.targetClose;
        const linearPrice = chart.currentCandle.open + (targetClose - chart.currentCandle.open) * progress;
        
        // Gi·∫£m t·∫ßn s·ªë v√† bi√™n ƒë·ªô noise ƒë·ªÉ b·ªõt gi·∫≠t
        const noise = Math.sin(progress * Math.PI * 4) * 0.5; 
        let rawPrice = linearPrice + noise;
        
        if (progress > 0.95) {
            const blend = (progress - 0.95) * 20; 
            rawPrice = (rawPrice * (1-blend)) + (targetClose * blend);
        }
        
        // H·ªá s·ªë Lerp 0.05 gi√∫p gi√° ch·∫°y c·ª±c ƒë·∫ßm
        chart.visualPrice += (rawPrice - chart.visualPrice) * 0.05; 
        
        chart.currentCandle.close = chart.visualPrice;
        if(chart.visualPrice > chart.currentCandle.high) chart.currentCandle.high = chart.visualPrice;
        if(chart.visualPrice < chart.currentCandle.low) chart.currentCandle.low = chart.visualPrice;

        const el = document.getElementById('live-price');
        el.innerText = chart.visualPrice.toLocaleString('en-US', {minimumFractionDigits: 2});
        el.className = chart.visualPrice >= chart.currentCandle.open ? "font-mono text-3xl font-bold tracking-tighter text-up drop-shadow-md transition-colors" : "font-mono text-3xl font-bold tracking-tighter text-down drop-shadow-md transition-colors";
      },

      draw: () => {
        const { ctx, width, height, candles, currentCandle } = chart;
        ctx.clearRect(0, 0, width, height);

        const allData = [...candles, currentCandle];
        const viewData = allData.slice(-20); 
        
        let minVal = Infinity, maxVal = -Infinity;
        viewData.forEach(c => { if(c.low < minVal) minVal = c.low; if(c.high > maxVal) maxVal = c.high; });
        if (game.phase !== 'BET' && game.lockPrice > 0) { if(game.lockPrice > maxVal) maxVal = game.lockPrice; if(game.lockPrice < minVal) minVal = game.lockPrice; }

        const range = maxVal - minVal || 1;
        const padding = height * 0.2;
        const getY = (val) => height - padding - ((val - minVal) / range) * (height - 2*padding);

        ctx.strokeStyle = '#2b3139'; ctx.lineWidth = 1; ctx.beginPath();
        for(let i=1; i<6; i++) {
          const y = (height/6)*i; ctx.moveTo(0, y); ctx.lineTo(width, y);
          const pLabel = minVal + (range * ((height-y-padding)/(height-2*padding)));
          ctx.fillStyle = '#5e6673'; ctx.font = '10px JetBrains Mono'; ctx.textAlign = 'right'; ctx.fillText(pLabel.toFixed(2), width - 5, y - 4);
        }
        ctx.stroke();

        if (game.phase !== 'BET' && game.lockPrice > 0) {
            const lockY = getY(game.lockPrice);
            const badge = document.getElementById('lock-label');
            badge.classList.remove('hidden'); badge.style.top = (lockY / 2) - 10 + "px";
            ctx.beginPath(); ctx.strokeStyle = '#FACC15'; ctx.lineWidth = 1.5; ctx.setLineDash([6, 4]); ctx.moveTo(0, lockY); ctx.lineTo(width, lockY); ctx.stroke(); ctx.setLineDash([]);
        } else { document.getElementById('lock-label').classList.add('hidden'); }

        const anchorX = width * 0.75; const spacing = width / 25; const candleW = spacing * 0.65;
        [...viewData].reverse().forEach((c, i) => {
            const x = anchorX - (i * spacing); if (x < -candleW) return;
            const yOpen = getY(c.open); const yClose = getY(c.close); const yHigh = getY(c.high); const yLow = getY(c.low);
            const isGreen = c.close >= c.open; const color = isGreen ? '#2ebd85' : '#f6465d';
            ctx.strokeStyle = color; ctx.fillStyle = color; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(x, yHigh); ctx.lineTo(x, yLow); ctx.stroke();
            const bodyH = Math.max(Math.abs(yClose - yOpen), 1); const bodyY = Math.min(yOpen, yClose);
            ctx.fillRect(x - candleW/2, bodyY, candleW, bodyH);
            if (i === 0) {
                ctx.beginPath(); ctx.setLineDash([2, 2]); ctx.moveTo(x, yClose); ctx.lineTo(width, yClose); ctx.stroke(); ctx.setLineDash([]);
                ctx.fillStyle = color; ctx.fillRect(width - 55, yClose - 10, 55, 20);
                ctx.fillStyle = isGreen ? '#000' : '#fff'; ctx.textAlign = 'center'; ctx.fillText(c.close.toFixed(2), width - 27, yClose + 4);
            }
        });
        requestAnimationFrame(chart.draw);
      }
    };

    // ===== 5. GAME LOGIC =====
    const game = {
      roundId: 0, phase: 'BET', timeLeft: 0, lockPrice: 0,
      currentChip: 10000, betSide: null, betAmount: 0, resultProcessed: false, history: [],

      init: async () => {
        const uid = localStorage.getItem("my_wallet_uid");
        if (!uid) { alert("Login required!"); window.location.href = "index.html"; return; }
        app.user = { id: uid };
        await game.loadBalance();
        game.setupRealtimeBalance();

        chart.init();
        
        // T·∫£i l·ªãch s·ª≠ 40 n·∫øn, index % 4 == 3 l√† n·∫øn k·∫øt qu·∫£
        const nowIndex = Math.floor(Date.now() / CONFIG.CANDLE_TIME);
        for(let i = nowIndex - 40; i < nowIndex; i++) {
            const c = generateCandleData(i);
            if ((i + 1) % 4 === 0) game.history.push(c.type); 
        }
        game.renderHistory();

        setInterval(() => {
            chart.update();
            game.syncLoop();
        }, 16); 
      },

      loadBalance: async () => {
        const { data } = await supabaseClient.from('users').select('balance').eq('id', app.user.id).maybeSingle();
        if (data) { app.balance = data.balance; game.updateBalanceUI(); }
      },

      setupRealtimeBalance: () => {
        supabaseClient.channel('wallet-changes').on('postgres_changes', 
          { event: 'UPDATE', schema: 'public', table: 'users', filter: `id=eq.${app.user.id}` },
          (payload) => { app.balance = payload.new.balance; game.updateBalanceUI(); }
        ).subscribe();
      },

      updateBalanceUI: () => { document.getElementById("balance").innerText = app.balance.toLocaleString('en-US'); },

      syncLoop: () => {
        const now = Date.now();
        const secInMin = Math.floor((now % 60000) / 1000); 
        
        const date = new Date();
        const sessID = date.getFullYear() + ('0'+(date.getMonth()+1)).slice(-2) + ('0'+date.getDate()).slice(-2) + ('0'+date.getHours()).slice(-2) + ('0'+date.getMinutes()).slice(-2);
        document.getElementById('session-id').innerText = "#" + sessID;

        // Logic Phase: 0-30: BET, 30-55: LOCK, 55-60: RESULT
        if (secInMin < 30) {
            // BET
            if (game.phase !== 'BET') game.resetUI();
            game.phase = 'BET';
            document.getElementById('timer-display').innerText = 30 - secInMin;
            const pct = (secInMin / 30) * 100;
            document.getElementById('phase-bar').style.width = (100 - pct) + '%';
            document.getElementById('phase-bar').className = "h-full bg-up w-full transition-all duration-300 ease-linear";
            game.resultProcessed = false;
        } else {
            const resTime = secInMin - 30;
            if (resTime < 25) {
                // WAIT
                if (game.phase === 'BET') game.switchPhaseToWait();
                game.phase = 'WAIT';
                document.getElementById('timer-display').innerText = 30 - resTime;
                const pct = (resTime / 25) * 100;
                document.getElementById('phase-bar').style.width = (100 - pct) + '%';
                document.getElementById('phase-bar').className = "h-full bg-down w-full transition-all duration-300 ease-linear";
            } else {
                // RESULT
                game.phase = 'RESULT';
                document.getElementById('timer-display').innerText = "0";
                document.getElementById('phase-bar').style.width = '0%';
                if (!game.resultProcessed) { 
                    game.processResult(); 
                    
                    // Th√™m history m·ªõi v√†o list
                    // Logic n·∫øn k·∫øt qu·∫£ l√† n·∫øn 3 (30-45) v√† 4 (45-60)? 
                    // Th·ª±c t·∫ø l√† gi√° ch·ªët t·∫°i 30 v√† gi√° kh·ªõp t·∫°i 60.
                    // Ta d·ª±a v√†o chart.visualPrice l√∫c n√†y ƒë·ªÉ quy·∫øt ƒë·ªãnh m√†u n·∫øn ·∫£o cho roadmap
                    const resType = chart.visualPrice >= game.lockPrice ? 'UP' : 'DOWN';
                    game.history.push(resType);
                    game.renderHistory();
                    
                    game.resultProcessed = true; 
                }
            }
        }
      },

      switchPhaseToWait: () => {
        game.lockPrice = chart.visualPrice; 
        const badge = document.getElementById('phase-badge');
        badge.innerText = "CH·ªú K·∫æT QU·∫¢";
        badge.className = "px-2 py-0.5 rounded bg-down/20 text-down text-[10px] font-bold uppercase backdrop-blur border border-down/30";
        document.getElementById('btn-up').classList.add('disabled');
        document.getElementById('btn-down').classList.add('disabled');
        document.getElementById('lock-price-val').innerText = game.lockPrice.toLocaleString('en-US', {minimumFractionDigits: 2});
        app.showToast("ƒê√£ kh√≥a gi√°! ƒêang ch·ªù k·∫øt qu·∫£...", "info");
      },

      processResult: async () => {
        const result = chart.visualPrice >= game.lockPrice ? 'UP' : 'DOWN';
        const badge = document.getElementById('phase-badge');
        badge.innerText = "K·∫æT QU·∫¢";
        badge.className = "px-2 py-0.5 rounded bg-gold/20 text-gold text-[10px] font-bold uppercase backdrop-blur border border-gold/30";
        app.showToast(`K·∫øt qu·∫£: ${result === 'UP' ? 'TƒÇNG' : 'GI·∫¢M'}`, result === 'UP' ? 'success' : 'error');

        if (game.betAmount > 0) {
            const isWin = game.betSide === result;
            if (isWin) {
                const profit = Math.floor(game.betAmount * CONFIG.ODDS);
                app.balance += profit;
                await supabaseClient.from('users').update({ balance: app.balance }).eq('id', app.user.id);
                game.updateBalanceUI();
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                game.showModal(true, profit, result);
                game.animateFloatingMoney(profit);
            } else { game.showModal(false, 0, result); }
        }
        game.betAmount = 0; game.betSide = null;
      },

      renderHistory: () => {
        const container = document.getElementById('roadmap'); container.innerHTML = '';
        game.history.slice(-20).forEach(type => {
            const d = document.createElement('div'); d.className = `hist-dot ${type === 'UP' ? 'hist-up' : 'hist-down'}`;
            container.appendChild(d);
        });
      },

      resetUI: () => {
        document.getElementById('btn-up').classList.remove('disabled', 'selected');
        document.getElementById('btn-down').classList.remove('disabled', 'selected');
        document.getElementById('badge-UP').classList.add('hidden');
        document.getElementById('badge-DOWN').classList.add('hidden');
        const badge = document.getElementById('phase-badge');
        badge.innerText = "ƒê·∫∂T L·ªÜNH";
        badge.className = "px-2 py-0.5 rounded bg-up/20 text-up text-[10px] font-bold uppercase backdrop-blur border border-up/30";
        document.getElementById('lock-label').classList.add('hidden');
      },

      setChip: (val) => {
        if (game.phase !== 'BET') return;
        game.currentChip = val;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        const chips = document.querySelectorAll('.chip');
        chips.forEach(c => { if(c.innerText.includes(val >= 1000 ? (val/1000)+'k' : val)) c.classList.add('active'); });
      },

      // EFFECT & LOGIC PLACE BET
      placeBet: async (e, side) => {
        if (game.phase !== 'BET') return app.showToast("ƒê√£ kh√≥a c∆∞·ª£c!", 'error');
        if (game.betAmount + game.currentChip > CONFIG.LIMITS.MAX) return app.showToast(`C∆∞·ª£c t·ªëi ƒëa ${CONFIG.LIMITS.MAX.toLocaleString()}`, 'error');
        if (game.currentChip > app.balance) return app.showToast("S·ªë d∆∞ kh√¥ng ƒë·ªß", 'error');

        // Create Effect at Click Position
        const rect = e.currentTarget.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // Ripple
        const ripple = document.createElement('span');
        ripple.className = 'ripple';
        ripple.style.left = `${x}px`; ripple.style.top = `${y}px`;
        e.currentTarget.appendChild(ripple);
        setTimeout(() => ripple.remove(), 600);

        // Flying Text
        const fly = document.createElement('div');
        fly.className = 'bet-fly text-gold';
        fly.style.left = `${e.clientX}px`; fly.style.top = `${e.clientY}px`;
        fly.innerText = `+${game.currentChip >= 1000 ? game.currentChip/1000 + 'k' : game.currentChip}`;
        document.body.appendChild(fly);
        setTimeout(() => fly.remove(), 800);

        // Logic
        game.betSide = side; game.betAmount += game.currentChip;
        app.balance -= game.currentChip;
        game.updateBalanceUI();
        await supabaseClient.from('users').update({ balance: app.balance }).eq('id', app.user.id);

        const btnUp = document.getElementById('btn-up'); const btnDown = document.getElementById('btn-down');
        if (side === 'UP') {
            btnUp.classList.add('selected'); btnDown.classList.add('disabled');
            document.getElementById('badge-UP').innerText = game.betAmount.toLocaleString();
            document.getElementById('badge-UP').classList.remove('hidden');
        } else {
            btnDown.classList.add('selected'); btnUp.classList.add('disabled');
            document.getElementById('badge-DOWN').innerText = game.betAmount.toLocaleString();
            document.getElementById('badge-DOWN').classList.remove('hidden');
        }
        if (navigator.vibrate) navigator.vibrate(40);
      },

      cancelBet: async () => {
        if (game.phase !== 'BET') return app.showToast("Kh√¥ng th·ªÉ h·ªßy!", 'error');
        if (game.betAmount === 0) return app.showToast("Ch∆∞a c∆∞·ª£c!", 'info');
        app.balance += game.betAmount;
        game.updateBalanceUI();
        await supabaseClient.from('users').update({ balance: app.balance }).eq('id', app.user.id);
        game.betAmount = 0; game.betSide = null;
        game.resetUI();
        app.showToast("ƒê√£ h·ªßy!", 'info');
      },

      animateFloatingMoney: (amount) => {
        const div = document.createElement('div'); div.className = 'float-money';
        div.innerText = '+' + amount.toLocaleString(); document.body.appendChild(div);
        setTimeout(() => div.remove(), 2000);
      },

      showModal: (isWin, amount, result) => {
        const overlay = document.getElementById('modal-overlay'); const content = document.getElementById('modal-content');
        overlay.classList.remove('opacity-0', 'pointer-events-none'); content.classList.remove('scale-90'); content.classList.add('scale-100');
        const icon = document.getElementById('modal-icon'); const title = document.getElementById('modal-title'); const amt = document.getElementById('modal-amount');
        if (isWin) {
            icon.innerHTML = 'üèÜ'; title.innerText = "TH·∫ÆNG L·ªöN"; title.className = "text-2xl font-oswald font-bold uppercase mb-1 text-up";
            amt.innerText = "+" + amount.toLocaleString(); amt.className = "font-mono text-xl font-bold text-up";
        } else {
            icon.innerHTML = '‚ùå'; title.innerText = "THUA CU·ªòC"; title.className = "text-2xl font-oswald font-bold uppercase mb-1 text-[#848e9c]";
            amt.innerText = "-" + game.betAmount.toLocaleString(); amt.className = "font-mono text-xl font-bold text-[#848e9c]";
        }
        setTimeout(() => {
            overlay.classList.add('opacity-0', 'pointer-events-none'); content.classList.add('scale-90'); content.classList.remove('scale-100');
        }, 3000);
      }
    };

    window.onload = game.init;
  </script>
</body>
</html>

