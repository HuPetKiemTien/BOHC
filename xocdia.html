<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Xóc Đĩa Global VIP - HC88</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
  <!-- SUPABASE LIBRARY -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { oswald: ['Oswald', 'sans-serif'], roboto: ['Roboto', 'sans-serif'] },
          colors: { gold: '#FFD700', 'gold-dark': '#B8860B', plate: '#E5E7EB' },
          boxShadow: { 'glow': '0 0 15px rgba(255, 215, 0, 0.5)', 'glow-red': '0 0 15px rgba(239, 68, 68, 0.5)' }
        }
      }
    }
  </script>

  <style>
    /* CORE SETUP */
    body {
      background: radial-gradient(circle at 50% -20%, #1e293b 0%, #020617 100%);
      color: white; overflow: hidden; touch-action: manipulation; user-select: none;
      -webkit-tap-highlight-color: transparent; font-family: 'Roboto', sans-serif;
    }
    
    /* GLASS PANEL */
    .glass {
      background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }

    /* 3D BOWL & PLATE (NO IMAGES - PURE CSS) */
    .plate-container {
      width: 280px; height: 280px; margin: 0 auto;
      display: flex; align-items: center; justify-content: center; position: relative;
    }
    .plate {
      position: absolute; width: 260px; height: 260px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #4b5563, #1f2937);
      box-shadow: 0 20px 50px rgba(0,0,0,0.8), inset 0 2px 5px rgba(255,255,255,0.1);
      border: 6px solid #374151; z-index: 1;
    }
    .bowl {
      position: absolute; width: 240px; height: 240px; border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #64748b, #0f172a);
      box-shadow: 
        inset 0 10px 30px rgba(255,255,255,0.15), 
        0 25px 60px rgba(0,0,0,0.9);
      z-index: 20; display: flex; align-items: center; justify-content: center;
      transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .bowl::before {
      content: ''; position: absolute; inset: 10px; border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .bowl-icon { font-size: 60px; color: rgba(255,255,255,0.05); }
    
    .bowl.open { transform: translate(50px, -150px) rotate(15deg); }
    .bowl.shaking { animation: shake 0.4s ease-in-out infinite; }
    @keyframes shake { 0%,100%{transform:translate(0,0) rotate(0)} 25%{transform:translate(-5px,5px) rotate(-5deg)} 75%{transform:translate(5px,-5px) rotate(5deg)} }

    /* COINS (CSS ONLY) */
    .coin { width: 40px; height: 40px; border-radius: 50%; position: absolute; box-shadow: 0 4px 8px rgba(0,0,0,0.4); transition: all 0.5s; }
    .c-red { background: radial-gradient(circle at 35% 35%, #ef4444, #991b1b); border: 2px solid #b91c1c; }
    .c-white { background: radial-gradient(circle at 35% 35%, #ffffff, #94a3b8); border: 2px solid #cbd5e1; }

    /* BETTING UI */
    .bet-btn { position: relative; transition: all 0.2s; overflow: hidden; }
    .bet-btn:active { transform: scale(0.96); }
    .bet-btn.winner { 
      border-color: #FFD700 !important; 
      background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,215,0,0.3));
      box-shadow: 0 0 20px rgba(255,215,0,0.3);
      animation: pulse-gold 1s infinite;
    }
    @keyframes pulse-gold { 0%,100%{box-shadow: 0 0 10px rgba(255,215,0,0.2)} 50%{box-shadow: 0 0 25px rgba(255,215,0,0.6)} }
    
    .marker { 
      position: absolute; top: 2px; right: 2px; 
      background: #fbbf24; color: black; font-weight: 900; 
      font-size: 9px; padding: 1px 5px; border-radius: 4px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 10;
    }

    /* CHIPS */
    .chip { 
      width: 46px; height: 46px; border-radius: 50%; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-weight: 900; font-size: 11px; cursor: pointer; border: 2px dashed rgba(255,255,255,0.4);
      transition: transform 0.2s; position: relative;
    }
    .chip.active { transform: translateY(-8px) scale(1.1); border-style: solid; border-color: #fbbf24; box-shadow: 0 8px 20px rgba(0,0,0,0.5); }
    .bg-1k { background: #64748b; } .bg-5k { background: #3b82f6; } .bg-10k { background: #ef4444; }
    .bg-50k { background: #a855f7; } .bg-100k { background: #f59e0b; color: black; } .bg-500k { background: #10b981; color: black; }

    /* ROADMAP DOTS */
    .dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .dot-chan { background: #3b82f6; border: 1px solid #1d4ed8; } /* Xanh */
    .dot-le { background: #ef4444; border: 1px solid #b91c1c; }   /* Đỏ */
    .dot-special { box-shadow: 0 0 0 1px #FFD700; } /* 4 đỏ hoặc 4 trắng */

    /* MODAL */
    .modal-overlay { 
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100;
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
      display: flex; align-items: center; justify-content: center;
    }
    .modal-overlay.show { opacity: 1; pointer-events: auto; }
    .modal-content { transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .modal-overlay.show .modal-content { transform: scale(1); }
    
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; display: inline-block; }
    .status-dot.online { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
  </style>
</head>
<body class="flex flex-col h-screen">

  <!-- HEADER -->
  <header class="h-14 bg-slate-900/90 border-b border-white/5 flex items-center justify-between px-4 fixed top-0 w-full z-50">
    <div class="flex items-center gap-3">
      <a href="games.html" class="w-9 h-9 rounded-full bg-slate-800 flex items-center justify-center text-slate-400 border border-white/10 active:bg-slate-700">
        <i class="fa-solid fa-chevron-left"></i>
      </a>
      <div>
        <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Global Table</div>
        <div class="flex items-center gap-1.5 font-oswald text-lg leading-none">
          <span class="text-white">XÓC ĐĨA</span>
          <span class="text-gold font-bold">VIP</span>
        </div>
      </div>
    </div>
    <div class="text-right">
      <div class="text-[10px] text-slate-500 font-bold" id="user-id">ID: ...</div>
      <div class="flex items-center gap-2 bg-slate-800/50 px-3 py-0.5 rounded-full border border-white/5 mt-0.5">
        <span id="conn-dot" class="status-dot"></span>
        <i class="fa-solid fa-wallet text-gold text-xs"></i>
        <span id="balance" class="font-oswald text-base text-white">---</span>
      </div>
    </div>
  </header>

  <!-- MAIN AREA -->
  <main class="flex-1 mt-14 flex flex-col relative">
    
    <!-- STATUS BAR -->
    <div class="h-10 flex items-center justify-center px-4 z-30 mt-2">
      <div class="glass px-6 py-1 rounded-full flex items-center gap-4 border border-emerald-500/20 shadow-lg">
        <span id="status-txt" class="text-[10px] font-black text-emerald-300 uppercase tracking-widest">ĐANG CƯỢC</span>
        <span class="w-[1px] h-3 bg-white/10"></span>
        <span id="timer" class="font-oswald font-bold text-lg text-white">--</span>
      </div>
    </div>

    <!-- GAME TABLE -->
    <div class="flex-1 flex items-center justify-center -mt-6">
      <div class="plate-container">
        <div class="plate">
          <div id="coins-container" class="absolute inset-0 z-10"></div>
        </div>
        <div id="bowl" class="bowl">
          <i class="fa-solid fa-crown bowl-icon"></i>
        </div>
      </div>
    </div>

    <!-- CONTROL PANEL (BOTTOM SHEET) -->
    <div class="glass rounded-t-[2.5rem] border-t border-white/10 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] z-40 relative pb-4">
      
      <!-- ROADMAP (LỊCH SỬ KẾT QUẢ) -->
      <div class="px-5 py-2.5 border-b border-white/5 flex items-center justify-between mb-2 bg-black/20 rounded-t-[2.5rem]">
        <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider"><i class="fa-solid fa-clock-rotate-left mr-1"></i> Cầu Gần Nhất</span>
        <div id="roadmap" class="flex items-center gap-1.5 overflow-hidden justify-end">
          <!-- Dots injected here -->
        </div>
      </div>

      <div class="px-4 space-y-3">
        <!-- SCORE BETS -->
        <div class="grid grid-cols-4 gap-2">
          <button class="bet-btn bg-slate-800/50 rounded-xl h-14 flex flex-col items-center justify-center border border-white/5" onclick="game.placeBet('4D')">
            <div class="flex gap-0.5"><div class="w-1.5 h-1.5 rounded-full bg-red-500"></div><div class="w-1.5 h-1.5 rounded-full bg-red-500"></div><div class="w-1.5 h-1.5 rounded-full bg-red-500"></div><div class="w-1.5 h-1.5 rounded-full bg-red-500"></div></div>
            <span class="text-[9px] text-slate-400 mt-1">x12</span>
            <div id="badge-4D" class="marker hidden">0</div>
          </button>
          <button class="bet-btn bg-slate-800/50 rounded-xl h-14 flex flex-col items-center justify-center border border-white/5" onclick="game.placeBet('3D1T')">
            <div class="flex gap-0.5"><div class="w-1.5 h-1.5 rounded-full bg-red-500"></div><div class="w-1.5 h-1.5 rounded-full bg-red-500"></div><div class="w-1.5 h-1.5 rounded-full bg-red-500"></div><div class="w-1.5 h-1.5 rounded-full bg-white"></div></div>
            <span class="text-[9px] text-slate-400 mt-1">x2.6</span>
            <div id="badge-3D1T" class="marker hidden">0</div>
          </button>
          <button class="bet-btn bg-slate-800/50 rounded-xl h-14 flex flex-col items-center justify-center border border-white/5" onclick="game.placeBet('3T1D')">
            <div class="flex gap-0.5"><div class="w-1.5 h-1.5 rounded-full bg-white"></div><div class="w-1.5 h-1.5 rounded-full bg-white"></div><div class="w-1.5 h-1.5 rounded-full bg-white"></div><div class="w-1.5 h-1.5 rounded-full bg-red-500"></div></div>
            <span class="text-[9px] text-slate-400 mt-1">x2.6</span>
            <div id="badge-3T1D" class="marker hidden">0</div>
          </button>
          <button class="bet-btn bg-slate-800/50 rounded-xl h-14 flex flex-col items-center justify-center border border-white/5" onclick="game.placeBet('4T')">
            <div class="flex gap-0.5"><div class="w-1.5 h-1.5 rounded-full bg-white"></div><div class="w-1.5 h-1.5 rounded-full bg-white"></div><div class="w-1.5 h-1.5 rounded-full bg-white"></div><div class="w-1.5 h-1.5 rounded-full bg-white"></div></div>
            <span class="text-[9px] text-slate-400 mt-1">x12</span>
            <div id="badge-4T" class="marker hidden">0</div>
          </button>
        </div>

        <!-- CHAN / LE -->
        <div class="grid grid-cols-2 gap-3">
          <button id="btn-CHAN" class="bet-btn bg-gradient-to-br from-purple-900/40 to-slate-900/40 border border-purple-500/20 rounded-2xl h-16 px-4 flex justify-between items-center" onclick="game.placeBet('CHAN')">
            <div>
              <div class="font-oswald text-2xl text-purple-400 font-bold drop-shadow-md">CHẴN</div>
              <div class="text-[8px] text-purple-300/50 uppercase tracking-widest">Even</div>
            </div>
            <span class="text-xs font-bold text-purple-300">x0.96</span>
            <div id="badge-CHAN" class="marker hidden">0</div>
          </button>

          <button id="btn-LE" class="bet-btn bg-gradient-to-br from-orange-900/40 to-slate-900/40 border border-orange-500/20 rounded-2xl h-16 px-4 flex justify-between items-center" onclick="game.placeBet('LE')">
            <div>
              <div class="font-oswald text-2xl text-orange-400 font-bold drop-shadow-md">LẺ</div>
              <div class="text-[8px] text-orange-300/50 uppercase tracking-widest">Odd</div>
            </div>
            <span class="text-xs font-bold text-orange-300">x0.96</span>
            <div id="badge-LE" class="marker hidden">0</div>
          </button>
        </div>

        <!-- CHIPS -->
        <div class="flex justify-between items-center py-2 overflow-x-auto gap-2 scrollbar-hide">
          <div class="chip bg-1k" onclick="game.setChip(1000, this)">1k</div>
          <div class="chip bg-5k" onclick="game.setChip(5000, this)">5k</div>
          <div class="chip bg-10k active" onclick="game.setChip(10000, this)">10k</div>
          <div class="chip bg-50k" onclick="game.setChip(50000, this)">50k</div>
          <div class="chip bg-100k" onclick="game.setChip(100000, this)">100k</div>
          <div class="chip bg-500k" onclick="game.setChip(500000, this)">500k</div>
        </div>

        <!-- ACTIONS -->
        <div class="grid grid-cols-4 gap-2 h-12">
          <button onclick="game.cancelBets()" class="rounded-xl bg-slate-800 border border-white/10 text-slate-400 text-[10px] font-bold uppercase active:scale-95 transition">Hủy</button>
          
          <button onclick="game.rebet()" class="rounded-xl bg-slate-700 border border-white/10 text-white text-[10px] font-bold uppercase active:scale-95 transition">Cược lại</button>

          <button onclick="game.confirmBets()" class="col-span-2 rounded-xl bg-gradient-to-r from-gold-dark to-gold text-black font-black text-sm uppercase shadow-lg shadow-gold/20 active:scale-95 transition flex items-center justify-center gap-2">
            ĐẶT CƯỢC <i class="fa-solid fa-check"></i>
          </button>
        </div>

      </div>
    </div>
  </main>

  <!-- MODAL RESULT -->
  <div id="modal-result" class="modal-overlay">
    <div class="modal-content bg-slate-900 border border-gold/30 rounded-3xl p-6 w-64 text-center shadow-2xl relative overflow-hidden">
      <!-- Glow effect -->
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-gold to-transparent"></div>
      
      <div id="mod-title" class="text-5xl font-oswald font-bold text-gold mb-2 drop-shadow-md italic">--</div>
      <div id="mod-desc" class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">--</div>
      <div id="mod-win" class="text-xl font-bold text-white"></div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 glass px-6 py-3 rounded-full flex items-center gap-3 opacity-0 pointer-events-none transition-all duration-300 z-[200] border border-white/10 shadow-xl">
    <i id="toast-icon" class="fa-solid fa-info-circle"></i>
    <span id="toast-msg" class="text-[11px] font-bold text-white uppercase tracking-wider">Thông báo</span>
  </div>

  <script>
    // ===== 1. SUPABASE CONFIGURATION =====
    const SUPABASE_URL = 'https://sfbaytcmpgceapdcdyer.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmYmF5dGNtcGdjZWFwZGNkeWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NDQ2MzYsImV4cCI6MjA4MTEyMDYzNn0.DeXO91pcCzQJHMcXTk9Eilcsk9IoGIPzOM-Ube4zRb8';
    
    const WALLET_TABLE = 'users';              
    const WALLET_BALANCE_COLUMN = 'balance'; 

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===== 2. GAME CONSTANTS =====
    const CONFIG = {
      PERIOD: 35000,
      PHASES: { SHAKE: 3000, BET: 28000, LOCK: 32000, REVEAL: 35000 },
      ODDS: { CHAN: 0.96, LE: 0.96, '4D': 12, '4T': 12, '3D1T': 2.6, '3T1D': 2.6 }
    };

    // ===== 3. GAME LOGIC =====
    const app = {
      user: null, // { id, balance }
      realtimeChannel: null,
      
      showToast: (msg, type='info') => {
        const t = document.getElementById("toast");
        const i = document.getElementById("toast-icon");
        document.getElementById("toast-msg").innerText = msg;
        
        if (type === 'error') { i.className = "fa-solid fa-circle-xmark text-red-500"; }
        else if (type === 'success') { i.className = "fa-solid fa-circle-check text-green-500"; }
        else { i.className = "fa-solid fa-info-circle text-blue-500"; }
        
        t.classList.remove("opacity-0", "pointer-events-none");
        setTimeout(() => t.classList.add("opacity-0", "pointer-events-none"), 3000);
      }
    };

    const game = {
      roundId: 0,
      phase: 'WAIT', // SHAKE, BET, LOCK, REVEAL
      resolved: false,
      
      bets: {
        pending: { CHAN:0, LE:0, '4D':0, '4T':0, '3D1T':0, '3T1D':0 },
        confirmed: { CHAN:0, LE:0, '4D':0, '4T':0, '3D1T':0, '3T1D':0 },
        lastRound: null
      },
      currentChip: 10000,

      // --- INIT WITH SUPABASE & RECOVERY ---
      init: async () => {
        // 1. Check Auth
        const uid = localStorage.getItem("my_wallet_uid");
        if (!uid) {
          alert("Vui lòng đăng nhập lại!");
          window.location.href = "index.html";
          return;
        }

        app.user = { id: uid, balance: 0 };
        document.getElementById("user-id").innerText = "ID: " + uid.substring(0, 8).toUpperCase();
        document.getElementById("conn-dot").classList.add("online");

        // 2. Load Balance
        await game.loadBalance();
        game.setupRealtimeBalance();

        // 3. CHECK PENDING BETS (RECOVERY LOGIC)
        await game.checkPendingState();

        // 4. Start Loop
        game.renderRoadmap();
        setInterval(game.loop, 100);
      },

      // --- PERSISTENCE LOGIC (FIX FOR EXITING GAME) ---
      savePendingState: () => {
        const data = {
            roundId: game.roundId,
            bets: game.bets.confirmed,
            timestamp: Date.now()
        };
        localStorage.setItem("xd_pending_bet", JSON.stringify(data));
      },

      clearPendingState: () => {
        localStorage.removeItem("xd_pending_bet");
      },

      checkPendingState: async () => {
        const raw = localStorage.getItem("xd_pending_bet");
        if (!raw) return;

        try {
            const data = JSON.parse(raw);
            const now = Date.now();
            const currentRound = Math.floor(now / CONFIG.PERIOD);

            // Case A: Round has passed -> Calculate Result & Refund/Pay
            if (data.roundId < currentRound) {
                console.log("Found old bet for round", data.roundId);
                const res = game.getResult(data.roundId);
                let winAmt = 0;
                
                for (let k in data.bets) {
                    let isWin = false;
                    if (k === 'CHAN' && res.isChan) isWin = true;
                    if (k === 'LE' && !res.isChan) isWin = true;
                    if (k === '4D' && res.reds === 4) isWin = true;
                    if (k === '4T' && res.reds === 0) isWin = true;
                    if (k === '3D1T' && res.reds === 3) isWin = true;
                    if (k === '3T1D' && res.reds === 1) isWin = true;
                    
                    if (isWin) winAmt += data.bets[k] * (1 + CONFIG.ODDS[k]);
                }

                if (winAmt > 0) {
                    const final = Math.floor(winAmt);
                    app.user.balance += final;
                    await game.syncBalance();
                    app.showToast(`Bạn thắng ${final.toLocaleString()} ván trước!`, 'success');
                } else {
                    app.showToast(`Kết quả ván trước: ${res.txt} ${res.sub}`, 'info');
                }
                game.clearPendingState();
            } 
            // Case B: Round is still active -> Restore Bet UI
            else if (data.roundId === currentRound) {
                console.log("Restoring active bet for round", data.roundId);
                game.bets.confirmed = data.bets;
                game.updateBadges();
            }
        } catch (e) {
            console.error("Recovery error:", e);
        }
      },

      loadBalance: async () => {
        try {
          const { data, error } = await supabaseClient
            .from(WALLET_TABLE)
            .select(WALLET_BALANCE_COLUMN)
            .eq('id', app.user.id)
            .maybeSingle();

          if (!data) {
             await supabaseClient.from(WALLET_TABLE).insert({ id: app.user.id, balance: 0 });
             app.user.balance = 0;
          } else {
             app.user.balance = data[WALLET_BALANCE_COLUMN] || 0;
          }
          game.updateBalanceUI();
        } catch (err) {
          console.error(err);
        }
      },

      setupRealtimeBalance: () => {
        if (!app.user) return;
        if (app.realtimeChannel) supabaseClient.removeChannel(app.realtimeChannel);

        app.realtimeChannel = supabaseClient
          .channel('wallet-changes')
          .on(
            'postgres_changes',
            { event: 'UPDATE', schema: 'public', table: WALLET_TABLE, filter: `id=eq.${app.user.id}` },
            (payload) => {
              const newBal = payload.new[WALLET_BALANCE_COLUMN];
              if (newBal !== undefined && newBal !== app.user.balance) {
                app.user.balance = newBal;
                game.updateBalanceUI();
              }
            }
          )
          .subscribe();
      },

      syncBalance: async () => {
        if (!app.user) return;
        try {
          const { error } = await supabaseClient
            .from(WALLET_TABLE)
            .update({ [WALLET_BALANCE_COLUMN]: app.user.balance })
            .eq('id', app.user.id);
        } catch (e) { console.error('Sync Ex:', e); }
      },

      updateBalanceUI: () => {
        const b = app.user.balance;
        const fmt = b >= 1000000 ? (b/1000000).toFixed(2)+'M' : (b >= 1000 ? (b/1000).toFixed(0)+'k' : b.toLocaleString());
        document.getElementById("balance").innerText = fmt;
      },

      // --- GAME LOOP ---
      loop: () => {
        const now = Date.now();
        const rid = Math.floor(now / CONFIG.PERIOD);
        const cyc = now % CONFIG.PERIOD;
        
        if (rid !== game.roundId) game.newRound(rid);

        const tm = document.getElementById("timer");
        const st = document.getElementById("status-txt");
        const bowl = document.getElementById("bowl");

        if (cyc < CONFIG.PHASES.SHAKE) {
          game.setPhase('SHAKE');
          st.innerText = "ĐANG XÓC"; st.className = "text-[10px] font-black text-blue-300 uppercase tracking-widest";
          tm.innerText = "";
          bowl.classList.add("shaking"); bowl.classList.remove("open");

        } else if (cyc < CONFIG.PHASES.BET) {
          game.setPhase('BET');
          st.innerText = "ĐẶT CƯỢC"; st.className = "text-[10px] font-black text-emerald-300 uppercase tracking-widest";
          const left = Math.ceil((CONFIG.PHASES.BET - cyc)/1000);
          tm.innerText = left;
          bowl.classList.remove("shaking");

        } else if (cyc < CONFIG.PHASES.LOCK) {
          game.setPhase('LOCK');
          st.innerText = "CHỜ MỞ"; st.className = "text-[10px] font-black text-rose-300 uppercase tracking-widest";
          tm.innerText = "--";
          bowl.classList.remove("shaking");

        } else {
          game.setPhase('REVEAL');
          st.innerText = "KẾT QUẢ"; st.className = "text-[10px] font-black text-gold uppercase tracking-widest";
          
          if (!game.resolved) {
            game.resolved = true;
            const res = game.getResult(rid);
            game.renderCoins(res.coins);
            
            setTimeout(() => {
              bowl.classList.add("open");
              game.highlightWin(res);
              game.payout(res);
              game.addRoadmap(res);
            }, 500);
          }
        }
      },

      setPhase: (p) => {
        if (game.phase !== p) {
          game.phase = p;
          if (p === 'BET') {
             document.querySelectorAll('.bet-btn').forEach(b => b.classList.remove('winner', 'disabled'));
          } else if (p === 'LOCK') {
             document.querySelectorAll('.bet-btn').forEach(b => b.classList.add('disabled'));
          }
        }
      },

      newRound: (id) => {
        game.roundId = id;
        game.resolved = false;
        
        let hasBet = false;
        for (let k in game.bets.confirmed) if(game.bets.confirmed[k] > 0) hasBet = true;
        if (hasBet) game.bets.lastRound = {...game.bets.confirmed};

        game.bets.pending = { CHAN:0, LE:0, '4D':0, '4T':0, '3D1T':0, '3T1D':0 };
        game.bets.confirmed = { CHAN:0, LE:0, '4D':0, '4T':0, '3D1T':0, '3T1D':0 };
        
        game.updateBadges();
        document.getElementById("coins-container").innerHTML = "";
        document.getElementById("bowl").classList.remove("open", "shaking");
        document.getElementById("modal-result").classList.remove("show");
      },

      // --- BETTING & PAYOUT ---
      setChip: (val, el) => {
        game.currentChip = val;
        document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
        el.classList.add("active");
      },

      placeBet: (type) => {
        if (game.phase !== 'BET') return app.showToast("Chưa đến giờ cược!", "error");
        
        if (type === 'CHAN' && (game.bets.pending['LE'] > 0 || game.bets.confirmed['LE'] > 0)) return app.showToast("Không cược Chẵn & Lẻ cùng lúc", "error");
        if (type === 'LE' && (game.bets.pending['CHAN'] > 0 || game.bets.confirmed['CHAN'] > 0)) return app.showToast("Không cược Chẵn & Lẻ cùng lúc", "error");
        
        const totalPending = Object.values(game.bets.pending).reduce((a,b)=>a+b,0);
        if (totalPending + game.currentChip > app.user.balance) return app.showToast("Số dư không đủ!", "error");

        game.bets.pending[type] += game.currentChip;
        game.updateBadges();
      },

      cancelBets: () => {
        game.bets.pending = { CHAN:0, LE:0, '4D':0, '4T':0, '3D1T':0, '3T1D':0 };
        game.updateBadges();
        app.showToast("Đã hủy cược chờ");
      },

      rebet: () => {
        if (game.phase !== 'BET') return app.showToast("Chưa đến giờ cược!", "error");
        if (!game.bets.lastRound) return app.showToast("Không có lịch sử cược!", "error");

        for (let k in game.bets.lastRound) {
           game.bets.pending[k] += game.bets.lastRound[k];
        }
        game.updateBadges();
        app.showToast("Đã chọn lại cược cũ");
      },

      confirmBets: async () => {
        if (game.phase !== 'BET') return app.showToast("Hết giờ cược!", "error");
        
        let total = 0;
        for (let k in game.bets.pending) total += game.bets.pending[k];
        
        if (total === 0) return;
        if (total > app.user.balance) return app.showToast("Số dư không đủ!", "error");

        // Deduct Local
        app.user.balance -= total;
        game.updateBalanceUI();
        
        // Move to Confirmed
        for (let k in game.bets.pending) {
          game.bets.confirmed[k] += game.bets.pending[k];
          game.bets.pending[k] = 0;
        }
        game.updateBadges();
        
        // Sync & SAVE STATE
        await game.syncBalance();
        game.savePendingState(); // <--- CRITICAL FIX
        
        app.showToast("Đặt cược thành công!", "success");
      },

      payout: async (res) => {
        let winTotal = 0;
        let played = false;

        for (let k in game.bets.confirmed) {
          if (game.bets.confirmed[k] > 0) {
            played = true;
            let isWin = false;
            if (k === 'CHAN' && res.isChan) isWin = true;
            if (k === 'LE' && !res.isChan) isWin = true;
            if (k === '4D' && res.reds === 4) isWin = true;
            if (k === '4T' && res.reds === 0) isWin = true;
            if (k === '3D1T' && res.reds === 3) isWin = true;
            if (k === '3T1D' && res.reds === 1) isWin = true;

            if (isWin) winTotal += game.bets.confirmed[k] * (1 + CONFIG.ODDS[k]);
          }
        }

        if (played) {
          if (winTotal > 0) {
             const final = Math.floor(winTotal);
             app.user.balance += final;
             await game.syncBalance(); // Sync win
             game.showModal(res.txt, res.sub, final);
          } else {
             game.showModal(res.txt, res.sub, 0);
          }
          // CLEAR PENDING STATE AFTER PAYOUT
          game.clearPendingState();
        }
      },

      // --- HELPERS ---
      updateBadges: () => {
        for (let k in game.bets.confirmed) {
          const t = game.bets.pending[k] + game.bets.confirmed[k];
          const el = document.getElementById(`badge-${k}`);
          if (t > 0) {
            el.classList.remove("hidden");
            el.innerText = t >= 1000 ? (t/1000).toFixed(0)+'k' : t;
          } else {
            el.classList.add("hidden");
          }
        }
      },

      renderCoins: (coins) => {
        const c = document.getElementById("coins-container");
        c.innerHTML = "";
        const pos = [{x:80,y:80},{x:80,y:140},{x:140,y:80},{x:140,y:140}];
        coins.forEach((r, i) => {
          const d = document.createElement("div");
          d.className = `coin ${r?'c-red':'c-white'}`;
          const rx = (Math.random()-0.5)*20;
          const ry = (Math.random()-0.5)*20;
          d.style.left = (pos[i].x + rx) + "px";
          d.style.top = (pos[i].y + ry) + "px";
          c.appendChild(d);
        });
      },

      getResult: (id) => {
        const rng = (seed) => {
          let t = seed += 0x6D2B79F5;
          t = Math.imul(t ^ t >>> 15, t | 1);
          t ^= t + Math.imul(t ^ t >>> 7, t | 61);
          return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }
        const coins = [];
        for(let i=0; i<4; i++) coins.push(rng(id*100 + i) > 0.5 ? 1 : 0);
        const reds = coins.reduce((a,b)=>a+b,0);
        const isChan = reds%2===0;
        
        let sub = "";
        if(reds===4) sub="4 ĐỎ";
        else if(reds===0) sub="4 TRẮNG";
        else if(reds===3) sub="3 ĐỎ 1 TRẮNG";
        else if(reds===1) sub="3 TRẮNG 1 ĐỎ";
        else sub="2 ĐỎ 2 TRẮNG";

        return { coins, reds, isChan, txt: isChan?"CHẴN":"LẺ", sub };
      },

      highlightWin: (res) => {
        const wins = [];
        if(res.isChan) wins.push('CHAN'); else wins.push('LE');
        if(res.reds===4) wins.push('4D');
        if(res.reds===0) wins.push('4T');
        if(res.reds===3) wins.push('3D1T');
        if(res.reds===1) wins.push('3T1D');
        
        wins.forEach(w => {
           const b = document.querySelector(`[onclick="game.placeBet('${w}')"]`);
           if(b) b.classList.add('winner');
        });
      },

      showModal: (title, sub, win) => {
        document.getElementById("mod-title").innerText = title;
        document.getElementById("mod-title").className = title==="CHẴN" ? "text-5xl font-oswald font-bold text-purple-400 mb-2 drop-shadow-md italic" : "text-5xl font-oswald font-bold text-orange-400 mb-2 drop-shadow-md italic";
        document.getElementById("mod-desc").innerText = sub;
        
        const wEl = document.getElementById("mod-win");
        if(win > 0) {
           wEl.innerText = "+" + win.toLocaleString();
           wEl.className = "text-3xl font-black text-green-400 animate-bounce";
        } else {
           wEl.innerText = "THỬ LẠI";
           wEl.className = "text-xl font-bold text-slate-500";
        }
        
        const m = document.getElementById("modal-result");
        m.classList.add("show");
        setTimeout(() => m.classList.remove("show"), 2500);
      },

      renderRoadmap: () => {
        const rm = document.getElementById("roadmap");
        rm.innerHTML = "";
        for(let i=18; i>0; i--) game.addRoadmap(game.getResult(game.roundId - i));
      },

      addRoadmap: (res) => {
        const rm = document.getElementById("roadmap");
        const d = document.createElement("div");
        let cls = res.isChan ? "dot-chan" : "dot-le";
        if(res.reds===0 || res.reds===4) cls += " dot-special";
        d.className = `dot ${cls}`;
        rm.appendChild(d);
        if(rm.children.length > 20) rm.removeChild(rm.firstChild);
      }
    };

    window.onload = game.init;
  </script>
</body>
</html>

