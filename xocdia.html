<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Xóc Đĩa Global - HC88</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root { --gold: #fbbf24; --bg: #0f172a; }
    body {
      background: radial-gradient(circle at 50% -10%, #334155 0%, #020617 90%);
      font-family: 'Inter', sans-serif; color: white;
      overflow: hidden; touch-action: manipulation; user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .font-oswald { font-family: 'Oswald', sans-serif; }
    .glass {
      background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.08);
    }
    
    /* DISH & BOWL */
    .plate-area { width: 260px; height: 260px; margin: 0 auto; position: relative; display: flex; align-items: center; justify-content: center; }
    .plate {
      position: absolute; inset: 0; border-radius: 50%;
      background: radial-gradient(#334155, #0f172a); border: 6px solid #475569;
      box-shadow: 0 15px 40px rgba(0,0,0,0.6); z-index: 1;
    }
    .bowl {
      position: absolute; width: 240px; height: 240px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #64748b, #1e293b);
      box-shadow: inset 0 5px 20px rgba(255,255,255,0.1), 0 20px 50px rgba(0,0,0,0.8);
      z-index: 20; display: flex; align-items: center; justify-content: center;
      transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
    }
    .bowl::after { content: 'HC88'; font-family: 'Oswald'; font-size: 40px; opacity: 0.1; }
    .bowl-open { transform: translate(60px, -140px) rotate(15deg); }
    .shaking { animation: shake 0.4s ease-in-out infinite; }
    @keyframes shake { 0%,100%{transform:rotate(0) translate(0,0)} 25%{transform:rotate(-4deg) translate(-8px,4px)} 75%{transform:rotate(4deg) translate(8px,-4px)} }

    /* COINS IN BOWL */
    .coin { width: 42px; height: 42px; border-radius: 50%; position: absolute; box-shadow: 0 4px 6px rgba(0,0,0,0.4); transition: all 0.4s; }
    .c-red { background: radial-gradient(circle at 30% 30%, #ef4444, #991b1b); border: 2px solid #b91c1c; }
    .c-white { background: radial-gradient(circle at 30% 30%, #fff, #cbd5e1); border: 2px solid #94a3b8; }

    /* CHIPS & BETS */
    .chip-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 4px; scrollbar-width: none; }
    .chip-scroll::-webkit-scrollbar { display: none; }
    .chip {
      flex-shrink: 0; width: 48px; height: 48px; border-radius: 50%; border: 3px dashed rgba(255,255,255,0.2);
      display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900;
      transition: all 0.2s; cursor: pointer;
    }
    .chip.active { transform: translateY(-8px); border: 3px solid var(--gold); box-shadow: 0 5px 15px rgba(251,191,36,0.4); }
    
    .bg-1k { background: #475569; } .bg-5k { background: #2563eb; } .bg-10k { background: #dc2626; }
    .bg-50k { background: #7c3aed; } .bg-100k { background: #d97706; color: black; }
    .bg-500k { background: #000; color: #fbbf24; border-color: #fbbf24; }

    .bet-cell { position: relative; transition: all 0.2s; overflow: hidden; }
    .bet-cell:active { transform: scale(0.95); }
    .bet-cell.disabled { opacity: 0.4; pointer-events: none; filter: grayscale(0.8); }
    .bet-cell.winner { animation: win-glow 1s infinite; border-color: var(--gold) !important; background: rgba(251,191,36,0.15); }
    @keyframes win-glow { 0%, 100% { box-shadow: inset 0 0 10px rgba(251,191,36,0.2); } 50% { box-shadow: inset 0 0 30px rgba(251,191,36,0.5); } }
    
    .marker { position: absolute; top: 4px; right: 4px; background: #fbbf24; color: black; font-size: 8px; padding: 1px 4px; border-radius: 4px; font-weight: 900; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 100; }
    .modal.show { opacity: 1; pointer-events: auto; }
    .modal-content { transform: translateY(20px); transition: transform 0.4s; }
    .modal.show .modal-content { transform: translateY(0); }
  </style>
</head>
<body class="flex flex-col h-screen">

  <!-- HEADER -->
  <header class="h-14 bg-slate-900/90 border-b border-white/5 flex items-center justify-between px-4 z-50">
    <div class="flex items-center gap-3">
      <a href="games.html" class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-slate-400 active:scale-90 transition shadow-inner">
        <i class="fa-solid fa-chevron-left"></i>
      </a>
      <div>
        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Xóc Đĩa Global</div>
        <div class="flex items-center gap-1.5 text-xs font-bold text-emerald-400">
          <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
          <span>#<span id="round-id">...</span></span>
        </div>
      </div>
    </div>
    <div class="text-right">
      <div class="text-[9px] text-slate-500 font-bold uppercase" id="user-id">ID: ...</div>
      <div class="flex items-center gap-1.5 justify-end">
        <span id="balance" class="font-oswald text-xl text-yellow-400">0</span>
        <i class="fa-solid fa-coins text-yellow-500 text-xs"></i>
      </div>
    </div>
  </header>

  <!-- MAIN AREA -->
  <main class="flex-1 relative flex flex-col pt-6">
    <!-- STATUS & TIMER -->
    <div class="flex justify-center mb-[-20px] relative z-30">
      <div id="status-badge" class="glass px-6 py-2 rounded-full flex items-center gap-4 border border-emerald-500/30 shadow-lg">
        <span id="status-txt" class="text-[11px] font-black text-emerald-100 uppercase tracking-widest">ĐANG CƯỢC</span>
        <span class="h-4 w-[1px] bg-white/10"></span>
        <span id="timer" class="font-oswald font-bold text-xl text-emerald-400 w-6 text-center">30</span>
      </div>
    </div>

    <!-- TABLE -->
    <div class="flex-1 flex items-center justify-center">
      <div class="plate-area">
        <div class="plate">
          <div id="coins-container" class="absolute inset-0 z-10"></div>
        </div>
        <div id="bowl" class="bowl"></div>
      </div>
    </div>

    <!-- BETTING CONTROLS -->
    <div class="bg-slate-900/95 border-t border-white/10 rounded-t-[2.5rem] shadow-[0_-10px_40px_rgba(0,0,0,0.6)] z-40">
      <!-- ROADMAP -->
      <div class="px-5 py-3 flex justify-between items-center border-b border-white/5">
        <span class="text-[10px] text-slate-500 font-bold uppercase tracking-tight">Cầu Coin Global</span>
        <div class="flex gap-1.5 h-3.5" id="roadmap"></div>
      </div>

      <div class="p-4 space-y-3">
        <!-- Ratios grid -->
        <div class="grid grid-cols-4 gap-2">
          <button class="bet-cell glass rounded-2xl h-16 flex flex-col items-center justify-center border border-white/5" onclick="placeBet('4D')">
            <span class="text-[10px] font-bold text-red-500">4 ĐỎ</span>
            <span class="text-[9px] text-slate-500">x12</span>
            <div id="badge-4D" class="marker hidden">0</div>
          </button>
          <button class="bet-cell glass rounded-2xl h-16 flex flex-col items-center justify-center border border-white/5" onclick="placeBet('3D1T')">
            <span class="text-[10px] font-bold text-red-400 leading-3">3 ĐỎ<br><span class="text-white text-[8px]">1 T</span></span>
            <span class="text-[9px] text-slate-500 mt-1">x2.6</span>
            <div id="badge-3D1T" class="marker hidden">0</div>
          </button>
          <button class="bet-cell glass rounded-2xl h-16 flex flex-col items-center justify-center border border-white/5" onclick="placeBet('3T1D')">
            <span class="text-[10px] font-bold text-white leading-3">3 TRẮNG<br><span class="text-red-400 text-[8px]">1 Đ</span></span>
            <span class="text-[9px] text-slate-500 mt-1">x2.6</span>
            <div id="badge-3T1D" class="marker hidden">0</div>
          </button>
          <button class="bet-cell glass rounded-2xl h-16 flex flex-col items-center justify-center border border-white/5" onclick="placeBet('4T')">
            <span class="text-[10px] font-bold text-white">4 TRẮNG</span>
            <span class="text-[9px] text-slate-500">x12</span>
            <div id="badge-4T" class="marker hidden">0</div>
          </button>
        </div>

        <!-- Major bets -->
        <div class="grid grid-cols-2 gap-4">
          <button id="btn-CHAN" class="bet-cell glass rounded-2xl h-20 flex items-center justify-between px-5 border border-purple-500/20" onclick="placeBet('CHAN')">
            <div class="text-left">
              <div class="text-lg font-black text-purple-400">CHẴN</div>
              <div class="text-[9px] text-slate-500 font-bold uppercase">2Đ-2T|4Đ|4T</div>
            </div>
            <div class="text-sm font-oswald text-purple-300">x0.96</div>
            <div id="badge-CHAN" class="marker hidden">0</div>
          </button>
          <button id="btn-LE" class="bet-cell glass rounded-2xl h-20 flex items-center justify-between px-5 border border-orange-500/20" onclick="placeBet('LE')">
            <div class="text-left">
              <div class="text-lg font-black text-orange-400">LẺ</div>
              <div class="text-[9px] text-slate-500 font-bold uppercase">3Đ-1T|3T-1Đ</div>
            </div>
            <div class="text-sm font-oswald text-orange-300">x0.96</div>
            <div id="badge-LE" class="marker hidden">0</div>
          </button>
        </div>
      </div>

      <!-- Footer chips -->
      <div class="pb-8 px-4">
        <div class="chip-scroll mb-4">
          <div class="chip bg-1k" onclick="setChip(1000, this)">1k</div>
          <div class="chip bg-5k" onclick="setChip(5000, this)">5k</div>
          <div class="chip bg-10k active" onclick="setChip(10000, this)">10k</div>
          <div class="chip bg-50k" onclick="setChip(50000, this)">50k</div>
          <div class="chip bg-100k" onclick="setChip(100000, this)">100k</div>
          <div class="chip bg-500k" onclick="setChip(500000, this)">500k</div>
        </div>
        <div class="flex gap-3 h-14">
          <button onclick="cancelPending()" class="flex-1 bg-slate-800 rounded-2xl border border-white/5 text-slate-400 font-bold text-xs uppercase transition-all active:bg-slate-700">Hủy</button>
          <button onclick="confirmBets()" class="flex-[3] bg-gradient-to-br from-yellow-400 to-amber-600 rounded-2xl text-black font-black text-sm uppercase shadow-lg active:scale-95 transition-all">Đặt Cược</button>
        </div>
      </div>
    </div>
  </main>

  <!-- RESULT MODAL -->
  <div id="result-modal" class="modal">
    <div class="modal-content glass bg-[#0f172a]/95 p-8 rounded-[2rem] border-2 border-yellow-500/40 text-center shadow-2xl min-w-[280px]">
      <div id="res-type" class="text-6xl font-oswald font-black text-yellow-400 mb-2 drop-shadow-lg italic">--</div>
      <div id="res-desc" class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-6">--</div>
      <div id="res-win-amount" class="text-2xl font-black text-emerald-400"></div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="fixed top-10 left-1/2 -translate-x-1/2 glass px-6 py-3 rounded-full flex items-center gap-3 opacity-0 pointer-events-none transition-all duration-300 z-[200] border border-white/10 shadow-2xl">
    <i id="toast-icon" class="fa-solid fa-coins text-yellow-500"></i>
    <span id="toast-msg" class="text-[11px] font-bold text-white uppercase tracking-wider">Thông báo</span>
  </div>

  <script>
    // ===== SUPABASE KẾT NỐI SỐ DƯ =====
    const SUPABASE_URL = "https://boddppngzdgpazrrdual.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvZGRwcG5nemRncGF6cnJkdWFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNTk5ODAsImV4cCI6MjA4MDkzNTk4MH0.rdNoq5qlmXzH3AafSxZOwv6qJznWhs8J_LHmdu0NT44";
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===== THỜI GIAN VÒNG CHƠI (tự động chạy) =====
    const PERIOD = 35000; // 35s 1 phiên
    const PHASES = { SHAKE: 3000, BET: 28000, LOCK: 32000, REVEAL: 35000 };
    const PAYOUTS = { CHAN: 0.96, LE: 0.96, '4D': 12, '4T': 12, '3D1T': 2.6, '3T1D': 2.6 };

    let user = { id: null, balance: 0 };
    let currentChip = 10000;
    let pendingBets = resetBets();
    let confirmedBets = resetBets();

    // quản lý vòng chơi
    let currentRoundId = -1;   // phiên hiện tại (theo thời gian)
    let roundResolved = false; // đã mở bát & trả thưởng chưa

    // ===== SYNC SỐ DƯ VỚI SUPABASE =====
    async function syncBalance(newBal) {
      user.balance = newBal;
      renderBalance();
      // upsert vào bảng users (id, balance)
      await db.from("users").upsert({ id: user.id, balance: newBal });
    }

    async function loadUser() {
      const { data, error } = await db
        .from("users")
        .select("balance")
        .eq("id", user.id)
        .maybeSingle();

      if (!error && data && typeof data.balance === "number") {
        user.balance = data.balance;
      } else {
        // user mới: tặng 100k
        await syncBalance(100000);
      }
      renderBalance();

      // realtime theo dõi nếu coin bị thay đổi từ nơi khác (admin / game khác)
      db.channel('user_sync')
        .on('postgres_changes', 
          { event: 'UPDATE', schema: 'public', table: 'users', filter: `id=eq.${user.id}` }, 
          payload => {
            user.balance = payload.new.balance;
            renderBalance();
          }
        )
        .subscribe();
    }

    function renderBalance() {
      document.getElementById("balance").innerText = formatCoin(user.balance);
    }

    function formatCoin(n) {
      if (n >= 1000000) return (n / 1000000).toFixed(1) + "M";
      if (n >= 1000) return (n / 1000).toFixed(0) + "k";
      return n;
    }

    // ===== GAME CORE: SINH KẾT QUẢ GLOBAL THEO THỜI GIAN =====
    function getResultForRound(roundId) {
      const seed = roundId * 12345;
      const coins = [];
      for (let i = 0; i < 4; i++) {
        const coinSeed = Math.sin(seed + i) * 10000;
        coins.push(coinSeed - Math.floor(coinSeed) < 0.5 ? 0 : 1); // 0 trắng, 1 đỏ
      }
      const reds = coins.filter(c => c === 1).length;
      return {
        coins,
        reds,
        isChan: reds % 2 === 0,
        type: reds === 4
          ? "4 ĐỎ"
          : reds === 0
          ? "4 TRẮNG"
          : reds === 3
          ? "3 ĐỎ 1 TRẮNG"
          : reds === 1
          ? "3 TRẮNG 1 ĐỎ"
          : "2 ĐỎ - 2 TRẮNG"
      };
    }

    // ===== VÒNG ĐỜI TRANG =====
    window.onload = async () => {
      const uid = localStorage.getItem("my_wallet_uid");
      if (!uid) { window.location.href = "games.html"; return; }

      user.id = uid;
      document.getElementById("user-id").innerText = "ID: " + uid.substring(0, 8).toUpperCase();

      await loadUser();
      initRoadmap();

      // tự động sync game 0.1s/lần -> luôn chạy dù không ai chơi
      setInterval(syncGame, 100);
    };

    // ===== ROADMAP (CẦU LỊCH SỬ) =====
    function initRoadmap() {
      const cur = Math.floor(Date.now() / PERIOD);
      const rm = document.getElementById("roadmap");
      rm.innerHTML = "";
      for (let i = 18; i >= 1; i--) {
        const res = getResultForRound(cur - i);
        addToRoadmapUI(res.isChan, res.reds);
      }
    }

    // ===== ĐỒNG BỘ TRẠNG THÁI GAME THEO THỜI GIAN =====
    function syncGame() {
      const now = Date.now();
      const roundId = Math.floor(now / PERIOD);
      const cycle = now % PERIOD;
      const bowl = document.getElementById("bowl");

      // nếu sang phiên mới -> reset vòng, tự đóng kết quả cũ, reset cược
      if (roundId !== currentRoundId) {
        currentRoundId = roundId;
        startNewRound();
      }

      document.getElementById("round-id").innerText = roundId;

      // Chia pha
      if (cycle < PHASES.SHAKE) {
        // ĐANG XÓC
        updateStatus("SHAKING", 0);
        bowl.classList.add("shaking");
        bowl.classList.remove("bowl-open");
      } else if (cycle < PHASES.BET) {
        // ĐẶT CƯỢC
        const remain = Math.ceil((PHASES.BET - cycle) / 1000);
        updateStatus("BETTING", remain);
        bowl.classList.remove("shaking");
        bowl.classList.remove("bowl-open");
      } else if (cycle < PHASES.LOCK) {
        // KHÓA CƯỢC
        updateStatus("LOCKED", 0);
        bowl.classList.remove("shaking");
      } else {
        // MỞ BÁT & TRẢ THƯỞNG
        updateStatus("REVEAL", 0);
        bowl.classList.remove("shaking");

        if (!roundResolved) {
          roundResolved = true; // đảm bảo mỗi phiên chỉ mở 1 lần
          const res = getResultForRound(roundId);
          renderCoins(res.coins);

          setTimeout(() => {
            bowl.classList.add("bowl-open");
            highlightWinners(res);
            processPayout(res);   // trả thưởng (nếu có người chơi), không có ai chơi thì chỉ show kết quả
            addToRoadmapUI(res.isChan, res.reds);
          }, 400);
        }
      }
    }

    function startNewRound() {
      // reset cược cho phiên mới (tự động đóng kết quả cũ)
      pendingBets = resetBets();
      confirmedBets = resetBets();
      roundResolved = false;
      updateBadges();

      document.getElementById("result-modal").classList.remove("show");
      document.getElementById("coins-container").innerHTML = "";
      document.querySelectorAll(".bet-cell").forEach(e => e.classList.remove("winner", "disabled"));

      const bowl = document.getElementById("bowl");
      bowl.classList.remove("bowl-open", "shaking");
    }

    // ===== CƯỢC =====
    function placeBet(type) {
      if (document.getElementById("status-txt").innerText !== "ĐẶT CƯỢC")
        return showToast("Đã hết thời gian cược!", "error");

      // không cho vừa chẵn vừa lẻ
      if (type === 'CHAN' && (pendingBets['LE'] > 0 || confirmedBets['LE'] > 0))
        return showToast("Cấm cược cả Chẵn và Lẻ!", "alert");
      if (type === 'LE' && (pendingBets['CHAN'] > 0 || confirmedBets['CHAN'] > 0))
        return showToast("Cấm cược cả Chẵn và Lẻ!", "alert");

      pendingBets[type] += currentChip;
      updateBadges();
    }

    async function confirmBets() {
      if (document.getElementById("status-txt").innerText !== "ĐẶT CƯỢC") return;

      let total = 0;
      for (let k in pendingBets) total += pendingBets[k];

      if (total === 0) return showToast("Chọn cửa để đặt cược!", "alert");
      if (user.balance < total) return showToast("Không đủ Coin!", "error");

      // trừ tiền -> lưu lên Supabase
      const newBal = user.balance - total;
      await syncBalance(newBal);

      // chuyển cược sang confirmed
      for (let k in pendingBets) {
        confirmedBets[k] += pendingBets[k];
        pendingBets[k] = 0;
      }
      updateBadges();

      // khóa cửa đối nghịch
      if (confirmedBets['CHAN'] > 0) document.getElementById("btn-LE").classList.add("disabled");
      if (confirmedBets['LE'] > 0) document.getElementById("btn-CHAN").classList.add("disabled");

      showToast("Đặt cược thành công!", "success");
    }

    async function processPayout(res) {
      let winSum = 0;
      let played = false;

      for (let k in confirmedBets) {
        if (confirmedBets[k] > 0) {
          played = true;
          let win = false;

          if (k === 'CHAN' && res.isChan) win = true;
          if (k === 'LE' && !res.isChan) win = true;
          if (k === '4D' && res.reds === 4) win = true;
          if (k === '4T' && res.reds === 0) win = true;
          if (k === '3D1T' && res.reds === 3) win = true;
          if (k === '3T1D' && res.reds === 1) win = true;

          if (win) winSum += confirmedBets[k] * (1 + PAYOUTS[k]);
        }
      }

      if (!played) return; // không ai chơi thì chỉ chạy gầm, không đụng balance

      if (winSum > 0) {
        const add = Math.floor(winSum);
        await syncBalance(user.balance + add);
        showResultModal(res.isChan ? "CHẴN" : "LẺ", res.type, add);
      } else {
        showResultModal(res.isChan ? "CHẴN" : "LẺ", res.type, 0);
      }
    }

    // ===== UI HELPERS =====
    function updateStatus(phase, time) {
      const b = document.getElementById("status-badge");
      const t = document.getElementById("status-txt");
      const tm = document.getElementById("timer");

      tm.innerText = time > 0 ? time : "--";

      if (phase === "SHAKING") {
        b.className = "glass px-6 py-2 rounded-full flex items-center gap-4 border border-blue-500/40";
        t.innerText = "ĐANG XÓC";
        t.className = "text-[11px] font-black text-blue-300";
      } else if (phase === "BETTING") {
        b.className = "glass px-6 py-2 rounded-full flex items-center gap-4 border border-emerald-500/40";
        t.innerText = "ĐẶT CƯỢC";
        t.className = "text-[11px] font-black text-emerald-200";
      } else if (phase === "LOCKED") {
        b.className = "glass px-6 py-2 rounded-full flex items-center gap-4 border border-rose-500/40";
        t.innerText = "KHÓA CƯỢC";
        t.className = "text-[11px] font-black text-rose-300";
      } else {
        b.className = "glass px-6 py-2 rounded-full flex items-center gap-4 border border-yellow-500/40";
        t.innerText = "MỞ BÁT";
        t.className = "text-[11px] font-black text-yellow-300";
      }
    }

    function renderCoins(arr) {
      const c = document.getElementById("coins-container");
      c.innerHTML = "";
      const pos = [
        { x: 100, y: 100 },
        { x: 100, y: 150 },
        { x: 150, y: 100 },
        { x: 150, y: 150 }
      ];
      arr.forEach((v, i) => {
        const d = document.createElement("div");
        d.className = `coin ${v === 1 ? 'c-red' : 'c-white'}`;
        d.style.left = (pos[i].x + (Math.random() - 0.5) * 30) + "px";
        d.style.top = (pos[i].y + (Math.random() - 0.5) * 30) + "px";
        d.style.transform = `rotate(${Math.random() * 360}deg)`;
        c.appendChild(d);
      });
    }

    function updateBadges() {
      for (let k in confirmedBets) {
        const tot = pendingBets[k] + confirmedBets[k];
        const el = document.getElementById(`badge-${k}`);
        if (!el) continue;
        if (tot > 0) {
          el.classList.remove("hidden");
          el.innerText = formatCoin(tot);
        } else {
          el.classList.add("hidden");
        }
      }
      // mở lại nút nếu không còn cược chẵn/lẻ
      if (confirmedBets['CHAN'] === 0 && pendingBets['CHAN'] === 0)
        document.getElementById("btn-CHAN").classList.remove("disabled");
      if (confirmedBets['LE'] === 0 && pendingBets['LE'] === 0)
        document.getElementById("btn-LE").classList.remove("disabled");
    }

    function addToRoadmapUI(isChan, reds) {
      const rm = document.getElementById("roadmap");
      const d = document.createElement("div");
      let cls = isChan ? "bg-white border-slate-300" : "bg-red-500 border-red-700";
      if (reds === 4 || reds === 0) cls += " ring-1 ring-yellow-400 ring-offset-1 ring-offset-slate-900";
      d.className = `w-2.5 h-2.5 rounded-full border flex-shrink-0 ${cls}`;
      rm.prepend(d);
      if (rm.children.length > 20) rm.removeChild(rm.lastChild);
    }

    function highlightWinners(res) {
      const winners = [res.isChan ? 'CHAN' : 'LE'];
      if (res.reds === 4) winners.push('4D');
      if (res.reds === 0) winners.push('4T');
      if (res.reds === 3) winners.push('3D1T');
      if (res.reds === 1) winners.push('3T1D');

      winners.forEach(k => {
        const btn = document.querySelector(`[onclick="placeBet('${k}')"]`);
        if (btn) btn.classList.add("winner");
      });
    }

    function showResultModal(type, desc, win) {
      document.getElementById("res-type").innerText = type;
      document.getElementById("res-desc").innerText = desc;

      const wEl = document.getElementById("res-win-amount");
      if (win > 0) {
        wEl.innerText = "+" + formatCoin(win) + " COIN";
        wEl.className = "text-2xl font-black text-emerald-400 animate-bounce";
      } else {
        wEl.innerText = "THỬ LẠI LẦN SAU";
        wEl.className = "text-lg font-bold text-slate-500";
      }

      const modal = document.getElementById("result-modal");
      modal.classList.add("show");

      // tự động đóng kết quả sau ~2.5s
      clearTimeout(window._resTimeout);
      window._resTimeout = setTimeout(() => {
        modal.classList.remove("show");
      }, 2500);
    }

    function showToast(m, t) {
      const el = document.getElementById("toast");
      document.getElementById("toast-msg").innerText = m;
      const i = document.getElementById("toast-icon");
      i.className =
        t === "error"
          ? "fa-solid fa-circle-xmark text-rose-500"
          : t === "alert"
          ? "fa-solid fa-triangle-exclamation text-yellow-500"
          : "fa-solid fa-coins text-yellow-500";
      el.classList.remove("opacity-0", "pointer-events-none");
      setTimeout(() => el.classList.add("opacity-0", "pointer-events-none"), 2000);
    }

    function setChip(v, el) {
      currentChip = v;
      document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
      el.classList.add("active");
    }

    function cancelPending() {
      pendingBets = resetBets();
      updateBadges();
    }

    function resetBets() {
      return { CHAN: 0, LE: 0, '4D': 0, '4T': 0, '3D1T': 0, '3T1D': 0 };
    }
  </script>
</body>
</html>
