<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mời Bạn Bè - HeoCon88</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0B0E14; color: #E2E8F0; }
        .bg-glow { position: fixed; width: 100%; height: 100%; z-index: -1; top: 0; left: 0; }
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.3; }
        .blob-1 { top: -10%; right: -10%; width: 300px; height: 300px; background: #fbbf24; }
        .blob-2 { bottom: 10%; left: -10%; width: 250px; height: 250px; background: #f59e0b; }
        .glass-panel { background: rgba(21, 26, 35, 0.6); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen flex flex-col relative overflow-hidden">

    <div class="bg-glow"><div class="blob blob-1"></div><div class="blob blob-2"></div></div>

    <!-- Header -->
    <header class="flex items-center justify-between px-5 py-4 z-20">
        <button onclick="window.location.href='home.html'" class="w-10 h-10 rounded-xl glass-panel flex items-center justify-center text-slate-300 hover:text-white transition active:scale-95">
            <i class="fa-solid fa-chevron-left"></i>
        </button>
        <h1 class="font-bold text-lg text-white">Đối Tác Kiếm Tiền</h1>
        <div class="w-10"></div>
    </header>

    <main class="flex-1 px-5 pb-8 overflow-y-auto no-scrollbar space-y-6">

        <!-- Stats -->
        <div class="glass-panel p-6 rounded-3xl relative overflow-hidden animate-up group text-center">
            <div class="absolute inset-0 bg-gradient-to-br from-yellow-500/10 to-transparent"></div>
            <div class="relative z-10">
                <div class="w-14 h-14 mx-auto bg-gradient-to-br from-yellow-400 to-orange-500 rounded-2xl flex items-center justify-center shadow-lg shadow-orange-500/30 mb-3 animate-bounce">
                    <i class="fa-solid fa-sack-dollar text-2xl text-white"></i>
                </div>
                <p class="text-xs text-yellow-200 font-bold uppercase tracking-wider mb-1">Tổng hoa hồng</p>
                <h2 class="text-4xl font-bold text-white tracking-tight font-mono" id="total-commission">0</h2>
            </div>
        </div>

        <!-- Link & Code -->
        <div class="animate-up" style="animation-delay: 0.1s;">
            <h3 class="text-sm font-bold text-white mb-3 ml-1">Mã giới thiệu của bạn</h3>
            <div class="glass-panel p-1.5 rounded-2xl flex items-center gap-2">
                <div class="flex-1 bg-black/20 rounded-xl px-4 py-3 border border-white/5 truncate">
                    <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1">REF LINK</p>
                    <p id="share-link-text" class="text-xs font-mono text-emerald-400 truncate">...</p>
                </div>
                <button onclick="copyLink()" class="h-full px-5 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-white font-bold text-sm transition active:scale-95 flex flex-col items-center justify-center gap-1 min-h-[60px]">
                    <i class="fa-solid fa-link"></i>
                    <span>Copy</span>
                </button>
            </div>
        </div>

        <!-- Policy -->
        <div class="glass-panel p-5 rounded-2xl animate-up" style="animation-delay: 0.2s;">
            <h3 class="text-sm font-bold text-white mb-4 border-l-2 border-yellow-500 pl-2">Chính sách hoa hồng</h3>
            <div class="space-y-3">
                <div class="flex items-center gap-3">
                    <span class="text-yellow-500 font-bold text-sm">10%</span>
                    <span class="text-xs text-slate-300">Hoa hồng cho mỗi lần F1 nạp tiền.</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-blue-400 font-bold text-sm">Vĩnh viễn</span>
                    <span class="text-xs text-slate-300">Hưởng trọn đời theo tài khoản.</span>
                </div>
            </div>
        </div>

        <!-- List Friends -->
        <div class="animate-up" style="animation-delay: 0.3s;">
            <div class="flex justify-between items-center mb-3 px-1">
                <h3 class="text-sm font-bold text-white">Bạn bè đã tham gia</h3>
                <span class="text-[10px] bg-slate-800 px-2 py-1 rounded text-slate-400 font-bold" id="friend-count">0 người</span>
            </div>
            <div id="friend-list" class="space-y-2 pb-10">
                <div class="text-center py-6 opacity-50">
                    <span class="loader border-slate-500"></span>
                </div>
            </div>
        </div>

    </main>

    <!-- Toast -->
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 glass-panel border-emerald-500/20 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 transition-all duration-300 opacity-0 -translate-y-20 z-50 pointer-events-none">
        <i class="fa-solid fa-check text-emerald-400"></i>
        <span class="text-xs font-bold">Đã sao chép liên kết!</span>
    </div>

    <script>
        const db = supabase.createClient("https://sfbaytcmpgceapdcdyer.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmYmF5dGNtcGdjZWFwZGNkeWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NDQ2MzYsImV4cCI6MjA4MTEyMDYzNn0.DeXO91pcCzQJHMcXTk9Eilcsk9IoGIPzOM-Ube4zRb8");
        const uid = localStorage.getItem("my_wallet_uid");

        window.onload = async () => {
            if(!uid) return window.location.href = "index.html";
            
            // Tạo link giới thiệu
            const link = `${window.location.origin}/index.html?ref=${uid}`;
            document.getElementById("share-link-text").innerText = link;

            // Load Thống kê
            // 1. Đếm số người đã mời
            const { data: friends } = await db.from("users").select("id, name, created_at").eq("ref_by", uid).order('created_at', {ascending: false});
            
            // 2. Tính tổng hoa hồng
            const { data: comms } = await db.from("deposit_history").select("amount").eq("uid", uid).eq("source", "referral_bonus");
            const total = comms ? comms.reduce((sum, item) => sum + item.amount, 0) : 0;
            
            document.getElementById("total-commission").innerText = total.toLocaleString('vi-VN');
            document.getElementById("friend-count").innerText = `${friends?.length || 0} người`;

            // Render List
            const list = document.getElementById("friend-list");
            if(!friends || friends.length === 0) {
                list.innerHTML = `<div class="text-center py-8 opacity-50 flex flex-col items-center"><i class="fa-solid fa-user-group text-2xl text-slate-600 mb-2"></i><p class="text-xs text-slate-500">Chưa có ai đăng ký qua link của bạn</p></div>`;
            } else {
                list.innerHTML = friends.map(f => `
                    <div class="glass-panel p-3 rounded-xl flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-indigo-500/20 text-indigo-400 flex items-center justify-center text-xs font-bold"><i class="fa-solid fa-user"></i></div>
                            <div>
                                <p class="text-xs font-bold text-white">${f.name || f.id}</p>
                                <p class="text-[10px] text-slate-500 font-mono">${new Date(f.created_at).toLocaleDateString()}</p>
                            </div>
                        </div>
                        <span class="text-[10px] text-emerald-400 bg-emerald-500/10 px-2 py-1 rounded border border-emerald-500/20">F1</span>
                    </div>
                `).join('');
            }
        };

        function copyLink() {
            const link = document.getElementById("share-link-text").innerText;
            navigator.clipboard.writeText(link).then(() => {
                const t = document.getElementById('toast');
                t.classList.remove('opacity-0', '-translate-y-20');
                setTimeout(() => t.classList.add('opacity-0', '-translate-y-20'), 2000);
            });
        }
    </script>
</body>
</html>


