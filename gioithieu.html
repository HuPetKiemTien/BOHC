<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mời Bạn Bè - HeoCon88</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0B0E14; color: #E2E8F0; }
        .bg-glow { position: fixed; width: 100%; height: 100%; z-index: -1; top: 0; left: 0; }
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.3; }
        .blob-1 { top: -10%; right: -10%; width: 300px; height: 300px; background: #fbbf24; }
        .blob-2 { bottom: 10%; left: -10%; width: 250px; height: 250px; background: #f59e0b; }
        .glass-panel { background: rgba(21, 26, 35, 0.6); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
        
        .loader { width: 16px; height: 16px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col relative overflow-hidden">

    <div class="bg-glow"><div class="blob blob-1"></div><div class="blob blob-2"></div></div>

    <!-- Header -->
    <header class="flex items-center justify-between px-5 py-4 z-20">
        <button onclick="window.location.href='home.html'" class="w-10 h-10 rounded-xl glass-panel flex items-center justify-center text-slate-300 hover:text-white transition active:scale-95">
            <i class="fa-solid fa-chevron-left"></i>
        </button>
        <h1 class="font-bold text-lg text-white">Đối Tác Kiếm Tiền</h1>
        <div class="w-10"></div>
    </header>

    <main class="flex-1 px-5 pb-8 overflow-y-auto no-scrollbar space-y-6">

        <!-- Commission Wallet Card -->
        <div class="glass-panel p-6 rounded-3xl relative overflow-hidden animate-up group text-center border border-yellow-500/30">
            <div class="absolute inset-0 bg-gradient-to-br from-yellow-500/10 to-transparent"></div>
            <div class="relative z-10">
                <div class="flex justify-center items-center gap-2 mb-2">
                    <i class="fa-solid fa-wallet text-yellow-400"></i>
                    <p class="text-xs text-yellow-200 font-bold uppercase tracking-wider">Số dư Ví Hoa Hồng</p>
                </div>
                
                <h2 class="text-4xl font-bold text-white tracking-tight font-mono mb-4" id="commission-balance">0</h2>
                
                <button onclick="withdrawCommission()" id="btn-withdraw" class="w-full py-3 rounded-xl bg-gradient-to-r from-yellow-500 to-orange-500 text-black font-bold text-sm shadow-lg shadow-orange-500/20 active:scale-95 transition-transform flex items-center justify-center gap-2">
                    <i class="fa-solid fa-money-bill-transfer"></i> RÚT VỀ VÍ CHÍNH
                </button>
                <p class="text-[10px] text-slate-400 mt-2 italic">*Rút tối thiểu 10,000 Coin.</p>
            </div>
        </div>

        <!-- Referral Code Only -->
        <div class="animate-up" style="animation-delay: 0.1s;">
            <h3 class="text-sm font-bold text-white mb-3 ml-1">Mã giới thiệu của bạn</h3>
            <div class="glass-panel p-1.5 rounded-2xl flex items-center gap-2">
                <div class="flex-1 bg-black/20 rounded-xl px-4 py-3 border border-white/5 flex flex-col justify-center">
                    <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1">MÃ GIỚI THIỆU</p>
                    <p id="my-ref-code" class="text-lg font-mono font-bold text-emerald-400 tracking-widest uppercase">LOADING</p>
                </div>
                <button onclick="copyCode()" class="h-full px-5 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-white font-bold text-sm transition active:scale-95 flex flex-col items-center justify-center gap-1 min-h-[60px]">
                    <i class="fa-regular fa-copy"></i>
                    <span>Copy</span>
                </button>
            </div>
        </div>

        <!-- Policy -->
        <div class="glass-panel p-5 rounded-2xl animate-up" style="animation-delay: 0.2s;">
            <h3 class="text-sm font-bold text-white mb-4 border-l-2 border-yellow-500 pl-2">Quyền lợi đại lý</h3>
            <div class="space-y-3">
                <div class="flex items-center gap-3">
                    <span class="text-yellow-500 font-bold text-sm">4%</span>
                    <span class="text-xs text-slate-300">Nhận hoa hồng trọn đời mỗi khi F1 nạp tiền.</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-blue-400 font-bold text-sm">Tự Động</span>
                    <span class="text-xs text-slate-300">Hệ thống tự cộng tiền vào ví hoa hồng ngay lập tức.</span>
                </div>
            </div>
        </div>

        <!-- List Friends -->
        <div class="animate-up" style="animation-delay: 0.3s;">
            <div class="flex justify-between items-center mb-3 px-1">
                <h3 class="text-sm font-bold text-white">Thành viên đã mời</h3>
                <span class="text-[10px] bg-slate-800 px-2 py-1 rounded text-slate-400 font-bold" id="friend-count">0 người</span>
            </div>
            <div id="friend-list" class="space-y-2 pb-10">
                <div class="text-center py-6 opacity-50">
                    <span class="loader border-slate-500"></span>
                </div>
            </div>
        </div>

    </main>

    <!-- Toast -->
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 glass-panel border-emerald-500/20 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 transition-all duration-300 opacity-0 -translate-y-20 z-50 pointer-events-none">
        <i id="toast-icon" class="fa-solid fa-check text-emerald-400"></i>
        <span id="toast-msg" class="text-xs font-bold">Thành công!</span>
    </div>

    <script>
        const db = supabase.createClient("https://sfbaytcmpgceapdcdyer.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmYmF5dGNtcGdjZWFwZGNkeWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NDQ2MzYsImV4cCI6MjA4MTEyMDYzNn0.DeXO91pcCzQJHMcXTk9Eilcsk9IoGIPzOM-Ube4zRb8");
        const uid = localStorage.getItem("my_wallet_uid");
        let currentCommission = 0;
        let isWithdrawing = false;

        window.onload = async () => {
            if(!uid) return window.location.href = "index.html";
            document.getElementById("my-ref-code").innerText = uid.toUpperCase();
            await loadData();
        };

        async function loadData() {
            // 1. Lấy số dư hoa hồng hiện tại (Để rút)
            const { data: user } = await db.from("users").select("commission_balance").eq("id", uid).single();
            if (user) {
                currentCommission = user.commission_balance || 0;
                document.getElementById("commission-balance").innerText = currentCommission.toLocaleString('vi-VN');
            }

            // 2. Lấy danh sách bạn bè (F1)
            const { data: friends } = await db.from("users").select("id, name, created_at").eq("ref_by", uid).order('created_at', {ascending: false});
            document.getElementById("friend-count").innerText = `${friends?.length || 0} người`;

            const list = document.getElementById("friend-list");
            
            if(!friends || friends.length === 0) {
                list.innerHTML = `<div class="text-center py-8 opacity-50 flex flex-col items-center"><i class="fa-solid fa-user-group text-2xl text-slate-600 mb-2"></i><p class="text-xs text-slate-500">Chưa có ai nhập mã giới thiệu của bạn</p></div>`;
                return;
            }

            // 3. TÍNH HOA HỒNG TỪNG NGƯỜI (LOGIC MỚI)
            // Lấy tất cả lịch sử nạp tiền của những người này
            const friendIds = friends.map(f => f.id);
            
            // Query các khoản nạp (source hợp lệ)
            const { data: deposits } = await db.from("deposit_history")
                .select("uid, amount")
                .in("uid", friendIds)
                .in("source", ['admin_add', 'admin_create', 'code', 'code_deposit']);

            // Map tổng nạp theo từng User ID
            const commissionMap = {};
            if(deposits) {
                deposits.forEach(d => {
                    if (!commissionMap[d.uid]) commissionMap[d.uid] = 0;
                    // Hoa hồng = 4% tổng nạp
                    commissionMap[d.uid] += (d.amount * 0.04);
                });
            }

            // Render Danh sách
            list.innerHTML = friends.map(f => {
                const commAmount = commissionMap[f.id] || 0;
                const time = new Date(f.created_at).toLocaleDateString('vi-VN');
                
                return `
                    <div class="glass-panel p-3 rounded-xl flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-slate-300 font-bold text-xs uppercase border border-slate-700">
                                ${f.name ? f.name.charAt(0) : 'U'}
                            </div>
                            <div>
                                <p class="text-xs font-bold text-white uppercase">${f.name || f.id}</p>
                                <p class="text-[10px] text-slate-500 font-mono">Gia nhập: ${time}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-slate-400">Hoa hồng</div>
                            <div class="text-sm font-bold font-mono ${commAmount > 0 ? 'text-yellow-400' : 'text-slate-600'}">
                                +${commAmount.toLocaleString('vi-VN')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function withdrawCommission() {
            if (isWithdrawing) return;
            if (currentCommission < 10000) return showToast("Tối thiểu rút 10,000 Coin", "error");

            if(!confirm(`Xác nhận rút ${currentCommission.toLocaleString()} Coin về ví chính?`)) return;

            isWithdrawing = true;
            const btn = document.getElementById("btn-withdraw");
            btn.innerHTML = `<span class="loader"></span> Đang xử lý...`;

            try {
                // Lấy số dư chính hiện tại
                const { data: u } = await db.from("users").select("balance").eq("id", uid).single();
                if (!u) throw new Error("Lỗi user");

                // 1. Cộng vào balance chính
                const newMainBalance = (u.balance || 0) + currentCommission;
                
                // 2. Trừ ví hoa hồng về 0
                const { error } = await db.from("users").update({ 
                    balance: newMainBalance,
                    commission_balance: 0 
                }).eq("id", uid);

                if (error) throw error;

                // 3. Ghi lịch sử rút hoa hồng
                await db.from("deposit_history").insert({
                    uid: uid,
                    amount: currentCommission,
                    source: "commission_withdraw", 
                    note: "Rút hoa hồng về ví"
                });

                showToast("Rút thành công!", "success");
                await loadData(); // Reload UI

            } catch (e) {
                console.error(e);
                showToast("Lỗi hệ thống", "error");
            } finally {
                isWithdrawing = false;
                btn.innerHTML = `<i class="fa-solid fa-money-bill-transfer"></i> RÚT VỀ VÍ CHÍNH`;
            }
        }

        function copyCode() {
            const code = document.getElementById("my-ref-code").innerText;
            navigator.clipboard.writeText(code).then(() => {
                showToast("Đã sao chép mã!");
            });
        }

        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            const icon = document.getElementById('toast-icon');
            
            if(type === 'error') {
                icon.className = "fa-solid fa-triangle-exclamation text-rose-500";
            } else {
                icon.className = "fa-solid fa-check text-emerald-400";
            }

            t.classList.remove('opacity-0', '-translate-y-20');
            setTimeout(() => t.classList.add('opacity-0', '-translate-y-20'), 2000);
        }
    </script>
</body>
</html>


