<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HeoCon88 - Trang Chá»§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; color: white; }
        .tab-active { background:#1e293b; color:#38bdf8; font-weight:700; }
        .content { display:none; }
        .content.active { display:block; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

<!-- ====== APP CHÃNH: TRANG CHá»¦ 2 TAB ====== -->
<div id="appMain" class="flex-1 flex flex-col">

  <!-- Header -->
  <header class="p-4 text-xl font-bold bg-slate-900 shadow-md flex justify-between items-center">
    <div>
      <span>ğŸ· HeoCon88</span>
      <div class="text-xs text-slate-400" id="userEmailLabel"></div>
    </div>
    <div class="flex items-center gap-2">
      <!-- NÃºt sang trang tÃ i khoáº£n báº¡n Ä‘Ã£ cÃ³ -->
      <button class="text-sm bg-slate-700 px-3 py-1 rounded-lg"
              onclick="window.location.href='tai-khoan.html'">
        <i class="fa-solid fa-wallet"></i> TÃ i khoáº£n
      </button>
      <button class="text-red-400 text-sm font-semibold flex items-center gap-1"
              onclick="logoutSupabase()">
        <i class="fa-solid fa-right-from-bracket"></i> ThoÃ¡t
      </button>
    </div>
  </header>

  <!-- Tabs -->
  <div class="grid grid-cols-2 text-center text-lg">
    <button id="tabDauTu" class="p-3 tab-active" onclick="switchMainTab('dautu')">ğŸ’° Äáº§u tÆ°</button>
    <button id="tabTroChoi" class="p-3" onclick="switchMainTab('trochoi')">ğŸ® TrÃ² chÆ¡i</button>
  </div>

  <!-- Ná»™i dung -->
  <div class="p-4 flex-1 overflow-y-auto">

    <!-- Äáº¦U TÆ¯ -->
    <div id="content_dautu" class="content active">
      <h2 class="text-xl font-bold mb-3">ğŸ’° Danh má»¥c Ä‘áº§u tÆ°</h2>

      <!-- Khá»‘i HÅ© sinh lá»i (demo) -->
      <div class="bg-slate-800 p-4 rounded-lg mb-4">
        <div class="flex justify-between items-center">
          <div>
            <p class="font-semibold text-lg">HÅ© sinh lá»i</p>
            <p class="text-xs text-gray-300">
              LÃ£i suáº¥t cÆ¡ báº£n: 1%/nÄƒm Â· Gá»­i tá»‘i thiá»ƒu 30.000
            </p>
          </div>
          <span class="text-xs bg-emerald-500/20 text-emerald-300 px-2 py-1 rounded-full">
            Äang phÃ¡t triá»ƒn
          </span>
        </div>
        <p class="mt-2 text-xs text-gray-400">
          Logic lÃ£i theo phÃºt, nhiá»‡m vá»¥ tÄƒng lÃ£i,... sáº½ code sau.
        </p>
      </div>

      <!-- Tráº¡ng thÃ¡i load gÃ³i Ä‘áº§u tÆ° -->
      <div id="investmentLoading" class="text-sm text-slate-400 mb-2">
        Äang táº£i gÃ³i Ä‘áº§u tÆ° tá»« há»‡ thá»‘ng...
      </div>
      <div id="investmentError" class="text-sm text-red-400 mb-2 hidden"></div>

      <!-- Danh sÃ¡ch gÃ³i Ä‘áº§u tÆ° -->
      <div id="investmentList" class="space-y-3">
        <!-- Card gÃ³i Ä‘áº§u tÆ° sáº½ Ä‘Æ°á»£c render báº±ng JS -->
      </div>
    </div>

    <!-- TRÃ’ CHÆ I -->
    <div id="content_trochoi" class="content">
      <h2 class="text-xl font-bold mb-3">ğŸ® Trung tÃ¢m trÃ² chÆ¡i</h2>

      <div class="bg-slate-800 p-4 rounded-lg mb-3 flex justify-between items-center">
        <div>
          <p class="font-semibold text-lg">Game TÃ i Xá»‰u</p>
          <p class="text-sm text-gray-300">Realtime (sáº½ gáº¯n link sau)</p>
        </div>
        <button class="bg-purple-500 px-3 py-2 rounded text-sm">ChÆ¡i</button>
      </div>

      <div class="bg-slate-800 p-4 rounded-lg mb-3 flex justify-between items-center">
        <div>
          <p class="font-semibold text-lg">NÃ´ng Tráº¡i MMO</p>
          <p class="text-sm text-gray-300">Trá»“ng cÃ¢y - thu hoáº¡ch</p>
        </div>
        <button class="bg-green-500 px-3 py-2 rounded text-sm">VÃ o game</button>
      </div>
    </div>

  </div>
</div>

<script>
/* ===== Supabase config â€“ Sá»¬A CHO ÄÃšNG ===== */
const SUPABASE_URL = "https://boddppngzdgpazrrdual.supabase.co";  // URL project cá»§a báº¡n
const SUPABASE_ANON_KEY = "DÃN_ANON_KEY_Cá»¦A_Báº N_VÃ€O_ÄÃ‚Y";         // anon public key
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Biáº¿n global */
let currentUserId = null;
let investmentPackages = [];

/* ===== Tabs pháº§n TRANG CHá»¦ ===== */
function switchMainTab(tab) {
  document.getElementById("content_dautu").classList.remove("active");
  document.getElementById("content_trochoi").classList.remove("active");
  document.getElementById("tabDauTu").classList.remove("tab-active");
  document.getElementById("tabTroChoi").classList.remove("tab-active");

  if (tab === "dautu") {
    document.getElementById("content_dautu").classList.add("active");
    document.getElementById("tabDauTu").classList.add("tab-active");
  } else {
    document.getElementById("content_trochoi").classList.add("active");
    document.getElementById("tabTroChoi").classList.add("tab-active");
  }
}

/* ===== ÄÄƒng xuáº¥t ===== */
async function logoutSupabase() {
  await supabaseClient.auth.signOut();
  // Sau khi logout, Ä‘Æ°a vá» trang Ä‘Äƒng nháº­p báº¡n Ä‘Ã£ cÃ³ sáºµn
  window.location.href = 'login.html'; // sá»­a thÃ nh file Ä‘Äƒng nháº­p cá»§a báº¡n
}

/* ===== Format tiá»n ===== */
function formatCurrency(num) {
  if (num == null) return "0";
  return num.toLocaleString('vi-VN');
}

/* ===== Load gÃ³i Ä‘áº§u tÆ° tá»« Supabase (báº£ng packages) ===== */
async function loadInvestmentPackages() {
  const loadingEl = document.getElementById('investmentLoading');
  const errorEl = document.getElementById('investmentError');
  const listEl = document.getElementById('investmentList');

  loadingEl.style.display = 'block';
  errorEl.classList.add('hidden');
  listEl.innerHTML = '';

  const { data, error } = await supabaseClient
    .from('packages')
    .select('id, name, description, min_amount, max_amount, profit_percent, duration_hours, active')
    .eq('active', true)
    .order('id', { ascending: true });

  loadingEl.style.display = 'none';

  if (error) {
    console.error(error);
    errorEl.classList.remove('hidden');
    errorEl.textContent = "KhÃ´ng táº£i Ä‘Æ°á»£c gÃ³i Ä‘áº§u tÆ°: " + error.message;
    return;
  }

  if (!data || data.length === 0) {
    listEl.innerHTML = '<p class="text-sm text-slate-400">ChÆ°a cÃ³ gÃ³i Ä‘áº§u tÆ° nÃ o. HÃ£y táº¡o dá»¯ liá»‡u trong báº£ng <b>packages</b>.</p>';
    return;
  }

  investmentPackages = data;
  data.forEach(pkg => {
    const minFmt = formatCurrency(pkg.min_amount);
    const maxFmt = formatCurrency(pkg.max_amount);
    const card = document.createElement('div');
    card.className = "bg-slate-800 p-4 rounded-lg mb-2 border border-slate-700";
    card.innerHTML = `
      <div class="flex justify-between items-center mb-2">
        <div>
          <p class="font-semibold text-lg">${pkg.name}</p>
          <p class="text-xs text-gray-300">${pkg.description || ''}</p>
        </div>
        <span class="text-xs bg-sky-500/20 text-sky-300 px-2 py-1 rounded-full">
          +${pkg.profit_percent}% Â· ${pkg.duration_hours}h
        </span>
      </div>
      <p class="text-xs text-gray-400 mb-2">
        Háº¡n má»©c: ${minFmt} â€“ ${maxFmt} VNÄ
      </p>
      <button class="mt-2 bg-yellow-500 hover:bg-yellow-600 w-full p-2 rounded text-sm font-semibold"
              onclick="openInvestPrompt(${pkg.id})">
        Äáº§u tÆ° ngay
      </button>
    `;
    listEl.appendChild(card);
  });
}

/* ===== Prompt sá»‘ tiá»n Ä‘áº§u tÆ° & insert vÃ o báº£ng investments ===== */
async function openInvestPrompt(packageId) {
  if (!currentUserId) {
    alert("Báº¡n cáº§n Ä‘Äƒng nháº­p trÆ°á»›c.");
    // CÃ³ thá»ƒ redirect sang trang Ä‘Äƒng nháº­p náº¿u muá»‘n
    return;
  }
  const pkg = investmentPackages.find(p => p.id === packageId);
  if (!pkg) {
    alert("KhÃ´ng tÃ¬m tháº¥y gÃ³i Ä‘áº§u tÆ°.");
    return;
  }

  const min = pkg.min_amount || 0;
  const max = pkg.max_amount || 0;
  const input = prompt(
    `Nháº­p sá»‘ tiá»n muá»‘n Ä‘áº§u tÆ° vÃ o "${pkg.name}" (VNÄ)\nTá»‘i thiá»ƒu: ${formatCurrency(min)} - Tá»‘i Ä‘a: ${formatCurrency(max)}`
  );
  if (!input) return;

  const amount = parseInt(input.replace(/\D/g, ''), 10);
  if (isNaN(amount) || amount <= 0) {
    alert("Sá»‘ tiá»n khÃ´ng há»£p lá»‡.");
    return;
  }
  if (min && amount < min) {
    alert("Sá»‘ tiá»n nhá» hÆ¡n má»©c tá»‘i thiá»ƒu.");
    return;
  }
  if (max && amount > max) {
    alert("Sá»‘ tiá»n vÆ°á»£t quÃ¡ má»©c tá»‘i Ä‘a.");
    return;
  }

  // TODO: á»Ÿ Ä‘Ã¢y nÃªn kiá»ƒm tra sá»‘ dÆ° vÃ­ trÆ°á»›c (trong trang tÃ i khoáº£n báº¡n xá»­ lÃ½)
  if (!confirm(`XÃ¡c nháº­n Ä‘áº§u tÆ° ${formatCurrency(amount)} VNÄ vÃ o gÃ³i "${pkg.name}"?`)) {
    return;
  }

  const { data, error } = await supabaseClient
    .from('investments')
    .insert([{
      user_id: currentUserId,
      package_id: packageId,
      amount: amount,
      status: 'pending'  // hoáº·c 'running' tÃ¹y logic cá»§a báº¡n
    }])
    .select()
    .single();

  if (error) {
    console.error(error);
    alert("Táº¡o lá»‡nh Ä‘áº§u tÆ° tháº¥t báº¡i: " + error.message);
  } else {
    alert("ÄÃ£ táº¡o lá»‡nh Ä‘áº§u tÆ° thÃ nh cÃ´ng! Báº¡n xá»­ lÃ½ duyá»‡t / trá»« tiá»n á»Ÿ phÃ­a admin hoáº·c trang tÃ i khoáº£n.");
  }
}

/* ===== Check session khi má»Ÿ TRANG CHá»¦ ===== */
(async ()=>{
  const { data, error } = await supabaseClient.auth.getSession();
  if (error) {
    console.error(error);
  }

  if (!data || !data.session) {
    // chÆ°a Ä‘Äƒng nháº­p â†’ Ä‘Æ°a vá» trang login báº¡n Ä‘ang dÃ¹ng
    window.location.href = 'login.html'; // Ä‘á»•i thÃ nh file Ä‘Äƒng nháº­p tháº­t cá»§a báº¡n
    return;
  }

  const session = data.session;
  currentUserId = session.user.id;
  const emailLabel = document.getElementById('userEmailLabel');
  emailLabel.textContent = "ğŸ‘¤ " + (session.user.email || '');

  // ÄÃ£ Ä‘Äƒng nháº­p â†’ load gÃ³i Ä‘áº§u tÆ°
  loadInvestmentPackages();
})();
</script>
</body>
</html>
