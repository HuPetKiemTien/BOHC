<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H≈© Sinh L·ªùi - HeoCon88</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glassmorphism Effect */
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .glass-header {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        /* Animations */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(16, 185, 129, 0.2); }
            50% { box-shadow: 0 0 25px rgba(16, 185, 129, 0.5); }
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .piggy-icon {
            animation: float 4s ease-in-out infinite;
            filter: drop-shadow(0 0 15px rgba(251, 191, 36, 0.4));
        }

        .money-glow {
            text-shadow: 0 0 20px rgba(52, 211, 153, 0.4);
        }

        .btn-action {
            transition: all 0.2s;
        }
        .btn-action:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="flex flex-col">

<!-- BACKGROUND DECORATION -->
<div class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none -z-10">
    <div class="absolute top-20 left-[-10%] w-72 h-72 bg-purple-500/20 rounded-full blur-3xl"></div>
    <div class="absolute bottom-20 right-[-10%] w-80 h-80 bg-emerald-500/10 rounded-full blur-3xl"></div>
</div>

<!-- HEADER -->
<header class="glass-header sticky top-0 z-50 px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
        <button onclick="goHome()" class="w-8 h-8 rounded-full bg-slate-700/50 flex items-center justify-center hover:bg-slate-600 transition">
            <i class="fa-solid fa-arrow-left text-slate-300"></i>
        </button>
        <span class="font-bold text-lg tracking-wide text-white">HeoCon88</span>
    </div>
    <div class="flex items-center gap-3">
        <div class="text-right hidden sm:block">
            <p id="userEmailLabel" class="text-xs text-slate-400 font-medium">Guest</p>
        </div>
        <button onclick="goAccount()" class="w-8 h-8 rounded-full bg-slate-700/50 flex items-center justify-center hover:bg-slate-600 transition text-slate-300">
            <i class="fa-solid fa-wallet"></i>
        </button>
        <button onclick="logoutSupabase()" class="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center hover:bg-red-500/30 transition text-red-400">
            <i class="fa-solid fa-power-off"></i>
        </button>
    </div>
</header>

<!-- MAIN CONTENT -->
<main class="flex-1 p-4 pb-20 flex flex-col items-center">
    
    <!-- Title Section -->
    <div class="text-center mt-2 mb-6">
        <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-amber-600">
            H≈© Sinh L·ªùi
        </h1>
        <p class="text-slate-400 text-sm">T√≠ch l≈©y m·ªói ng√†y, nh·∫≠n l√£i t·ª´ng ph√∫t</p>
    </div>

    <!-- MAIN CARD -->
    <div class="w-full max-w-md glass-panel rounded-3xl p-6 relative overflow-hidden">
        
        <!-- Status Badge -->
        <div class="absolute top-4 right-4">
            <span class="flex items-center gap-1.5 bg-emerald-500/20 border border-emerald-500/30 text-emerald-400 px-3 py-1 rounded-full text-xs font-semibold backdrop-blur-md">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                </span>
                ƒêang sinh l√£i
            </span>
        </div>

        <!-- Piggy Icon & Balance -->
        <div class="flex flex-col items-center mt-4 mb-6">
            <div class="text-6xl mb-4 piggy-icon">
                üê∑
            </div>
            <p class="text-slate-400 text-sm mb-1">T·ªïng t√†i s·∫£n trong h≈©</p>
            <div class="flex items-baseline gap-1">
                <span id="potBalance" class="text-4xl font-extrabold text-white money-glow tracking-tight">0</span>
                <span class="text-lg font-medium text-emerald-400">‚Ç´</span>
            </div>
            <div class="mt-2 flex items-center gap-2 bg-white/5 px-3 py-1.5 rounded-lg border border-white/10">
                <i class="fa-solid fa-arrow-trend-up text-emerald-400 text-xs"></i>
                <span id="potRate" class="text-xs font-semibold text-emerald-300">12%/nƒÉm</span>
            </div>
        </div>

        <!-- Info Grid -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="bg-slate-900/40 p-3 rounded-xl border border-slate-700/50">
                <p class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">C·∫≠p nh·∫≠t l√∫c</p>
                <p id="potUpdated" class="text-xs font-mono text-white truncate">-</p>
            </div>
            <div class="bg-slate-900/40 p-3 rounded-xl border border-slate-700/50">
                <p class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">H·∫°n m·ª©c t·ªëi ƒëa</p>
                <p class="text-xs font-mono text-white">900.000 ‚Ç´</p>
            </div>
        </div>

        <!-- Progress Bar (Visual only) -->
        <div class="w-full bg-slate-700/50 h-1.5 rounded-full mb-6 overflow-hidden">
            <div class="h-full bg-gradient-to-r from-emerald-500 to-teal-400 w-1/3 rounded-full shadow-[0_0_10px_rgba(16,185,129,0.5)]"></div>
        </div>

        <!-- Actions -->
        <div class="grid grid-cols-2 gap-4">
            <button onclick="depositToPotPrompt()" 
                class="btn-action bg-gradient-to-br from-emerald-500 to-teal-600 hover:from-emerald-400 hover:to-teal-500 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-emerald-500/20 flex flex-col items-center justify-center gap-1">
                <i class="fa-solid fa-circle-plus text-xl"></i>
                <span class="text-sm">N·∫°p Ti·ªÅn</span>
            </button>
            <button onclick="withdrawPotPrompt()" 
                class="btn-action bg-gradient-to-br from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-amber-500/20 flex flex-col items-center justify-center gap-1">
                <i class="fa-solid fa-wallet text-xl"></i>
                <span class="text-sm">R√∫t H·∫øt</span>
            </button>
        </div>

        <!-- Footer Note -->
        <div class="mt-6 pt-4 border-t border-white/5 text-center">
            <p class="text-[10px] text-slate-500 leading-relaxed">
                <i class="fa-solid fa-circle-info mr-1"></i>
                L√£i su·∫•t ƒë∆∞·ª£c t√≠nh theo t·ª´ng ph√∫t. B·∫°n c√≥ th·ªÉ r√∫t ti·ªÅn b·∫•t c·ª© l√∫c n√†o. Demo ch∆∞a k·∫øt n·ªëi v√≠ ch√≠nh.
            </p>
        </div>
    </div>
</main>

<script>
/* ======================================================== */
/* LOGIC GI·ªÆ NGUY√äN (KH√îNG THAY ƒê·ªîI)             */
/* ======================================================== */

/* ===== Supabase config ‚Äì ƒê√É G·∫ÆN S·∫¥N PROJECT C·ª¶A B·∫†N ===== */
const SUPABASE_URL = "https://boddppngzdgpazrrdual.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvZGRwcG5nemRncGF6cnJkdWFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNTk5ODAsImV4cCI6MjA4MDkzNTk4MH0.rdNoq5qlmXzH3AafSxZOwv6qJznWhs8J_LHmdu0NT44";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== ƒê∆Ø·ªúNG D·∫™N ƒêI GI·ªÆA C√ÅC TRANG ===== */
function goHome() {
    window.location.href = "index.html";        
}
function goAccount() {
    window.location.href = "tai-khoan.html";    
}

/* ===== BI·∫æN GLOBAL CHO H≈® ===== */
let currentUserId = null;
let savingPotRow = null;

// L√£i su·∫•t m·∫∑c ƒë·ªãnh: 12%/nƒÉm
const DEFAULT_ANNUAL_RATE = 12.0;

// Gi·ªõi h·∫°n h≈©
const MIN_DEPOSIT = 30000;   // t·ªëi thi·ªÉu m·ªói l·∫ßn g·ª≠i
const MAX_BALANCE = 900000;  // t·ªëi ƒëa s·ªë ti·ªÅn trong h≈©

/* ===== FORMAT TI·ªÄN ===== */
function formatCurrency(num) {
    if (num == null) return "0";
    return num.toLocaleString('vi-VN');
}

/* ===== T√çNH S·ªê D∆Ø T·∫†M T√çNH (G·ªêC + L√ÉI) ===== */
function getPotDisplayBalance() {
    if (!savingPotRow) return 0;

    const principal = Number(savingPotRow.balance || 0);
    const rate = Number(savingPotRow.annual_rate || DEFAULT_ANNUAL_RATE); // %
    const updatedAt = savingPotRow.updated_at ? new Date(savingPotRow.updated_at) : null;

    if (!updatedAt || principal <= 0 || rate <= 0) {
        return principal;
    }

    const now = new Date();
    const secondsElapsed = (now - updatedAt) / 1000;
    const secondsPerYear = 365 * 24 * 60 * 60;
    const yearFraction = secondsElapsed / secondsPerYear;

    const interest = principal * (rate / 100) * yearFraction;
    const total = principal + interest;

    return Math.floor(total);
}

/* ===== C·∫¨P NH·∫¨T UI H≈® ===== */
function updatePotDisplay() {
    const potBalanceEl = document.getElementById("potBalance");
    const potRateEl = document.getElementById("potRate");
    const potUpdatedEl = document.getElementById("potUpdated");

    if (!savingPotRow) {
        potBalanceEl.textContent = "0";
        potRateEl.textContent = `${DEFAULT_ANNUAL_RATE}%`;
        potUpdatedEl.textContent = "-";
        return;
    }

    const displayBalance = getPotDisplayBalance();
    potBalanceEl.textContent = formatCurrency(displayBalance);
    // C·∫≠p nh·∫≠t text hi·ªÉn th·ªã ng·∫Øn g·ªçn h∆°n cho UI m·ªõi
    potRateEl.textContent = `${savingPotRow.annual_rate}%/nƒÉm`;
    potUpdatedEl.textContent = savingPotRow.updated_at
        ? new Date(savingPotRow.updated_at).toLocaleString("vi-VN")
        : "-";
}

/* ===== LOAD / T·∫†O H≈® CHO USER ===== */
async function loadSavingPot() {
    if (!currentUserId) return;

    let { data, error } = await supabaseClient
        .from("saving_pots")
        .select("id, user_id, balance, annual_rate, updated_at")
        .eq("user_id", currentUserId)
        .maybeSingle();

    if (error && error.code !== "PGRST116") {
        console.error("L·ªói l·∫•y saving_pots:", error);
    }

    // N·∫øu ch∆∞a c√≥ h≈© -> t·∫°o m·ªõi
    if (!data) {
        const { data: inserted, error: insertError } = await supabaseClient
            .from("saving_pots")
            .insert([{
                user_id: currentUserId,
                balance: 0,
                annual_rate: DEFAULT_ANNUAL_RATE,
                updated_at: new Date().toISOString()
            }])
            .select()
            .single();

        if (insertError) {
            console.error("L·ªói t·∫°o saving_pots:", insertError);
            alert("Kh√¥ng t·∫°o ƒë∆∞·ª£c h≈© sinh l·ªùi: " + insertError.message);
            return;
        }
        savingPotRow = inserted;
    } else {
        if (!data.annual_rate || data.annual_rate !== DEFAULT_ANNUAL_RATE) {
            data.annual_rate = DEFAULT_ANNUAL_RATE;
        }
        savingPotRow = data;
    }

    updatePotDisplay();
}

/* ===== CORE: C·∫¨P NH·∫¨T S·ªê D∆Ø H≈® ===== */
async function applyPotDelta(deltaAmount) {
    if (!savingPotRow) {
        alert("Ch∆∞a t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu h≈©.");
        return;
    }

    const currentTotal = getPotDisplayBalance();
    const newTotal = currentTotal + deltaAmount;

    if (newTotal < 0) {
        alert("S·ªë ti·ªÅn r√∫t v∆∞·ª£t qu√° s·ªë d∆∞ trong h≈©.");
        return;
    }
    if (newTotal > MAX_BALANCE) {
        alert("S·ªë ti·ªÅn trong h≈© sau khi g·ª≠i s·∫Ω v∆∞·ª£t qu√° " + formatCurrency(MAX_BALANCE) + " VNƒê.");
        return;
    }

    const nowIso = new Date().toISOString();

    const { data, error } = await supabaseClient
        .from("saving_pots")
        .update({
            balance: Math.floor(newTotal),
            annual_rate: DEFAULT_ANNUAL_RATE,
            updated_at: nowIso
        })
        .eq("id", savingPotRow.id)
        .select()
        .single();

    if (error) {
        console.error("L·ªói c·∫≠p nh·∫≠t saving_pots:", error);
        alert("C·∫≠p nh·∫≠t h≈© th·∫•t b·∫°i: " + error.message);
        return;
    }

    savingPotRow = data;
    updatePotDisplay();
}

/* ===== G·ª¨I TI·ªÄN V√ÄO H≈® (PROMPT) ===== */
async function depositToPotPrompt() {
    if (!currentUserId) {
        alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p tr∆∞·ªõc.");
        return;
    }

    const input = prompt(
        "Nh·∫≠p s·ªë ti·ªÅn mu·ªën g·ª≠i v√†o h≈© (VNƒê)\n" +
        "‚Ä¢ T·ªëi thi·ªÉu: " + formatCurrency(MIN_DEPOSIT) + " VNƒê\n" +
        "‚Ä¢ T·ªëi ƒëa t·ªïng trong h≈©: " + formatCurrency(MAX_BALANCE) + " VNƒê"
    );
    if (!input) return;

    const amount = parseInt(input.replace(/\D/g, ""), 10);
    if (isNaN(amount) || amount <= 0) {
        alert("S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá.");
        return;
    }
    if (amount < MIN_DEPOSIT) {
        alert("S·ªë ti·ªÅn g·ª≠i ph·∫£i t·ª´ " + formatCurrency(MIN_DEPOSIT) + " VNƒê tr·ªü l√™n.");
        return;
    }
    if (amount > MAX_BALANCE) {
        alert("M·ªôt l·∫ßn g·ª≠i kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° " + formatCurrency(MAX_BALANCE) + " VNƒê.");
        return;
    }

    const currentTotal = getPotDisplayBalance();
    if (currentTotal + amount > MAX_BALANCE) {
        alert(
          "T·ªïng s·ªë ti·ªÅn trong h≈© sau khi g·ª≠i s·∫Ω v∆∞·ª£t qu√° " +
          formatCurrency(MAX_BALANCE) +
          " VNƒê.\nHi·ªán ƒëang c√≥: " + formatCurrency(currentTotal) + " VNƒê."
        );
        return;
    }

    if (!confirm(`X√°c nh·∫≠n g·ª≠i ${formatCurrency(amount)} VNƒê v√†o h≈© sinh l·ªùi?`)) {
        return;
    }

    await applyPotDelta(amount);
    alert("G·ª≠i ti·ªÅn v√†o h≈© th√†nh c√¥ng!");
}

/* ===== R√öT H·∫æT H≈® (PROMPT) ===== */
async function withdrawPotPrompt() {
    if (!currentUserId) {
        alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p tr∆∞·ªõc.");
        return;
    }

    const currentTotal = getPotDisplayBalance();
    if (currentTotal <= 0) {
        alert("H≈© ƒëang tr·ªëng, kh√¥ng c√≥ g√¨ ƒë·ªÉ r√∫t.");
        return;
    }

    if (!confirm(
        `B·∫°n mu·ªën r√∫t to√†n b·ªô ${formatCurrency(currentTotal)} VNƒê (g·ªìm c·∫£ l√£i) ra kh·ªèi h≈©?\n` +
        "S·ªë ti·ªÅn n√†y n√™n ƒë∆∞·ª£c c·ªông v·ªÅ v√≠ ch√≠nh ·ªü trang t√†i kho·∫£n."
    )) {
        return;
    }

    await applyPotDelta(-currentTotal);
    alert("ƒê√£ r√∫t h·∫øt h≈© sinh l·ªùi!");
}

/* ===== ƒêƒÇNG XU·∫§T ===== */
async function logoutSupabase() {
    await supabaseClient.auth.signOut();
    window.location.href = "login.html"; 
}

/* ===== CHECK SESSION ===== */
(async () => {
    const { data, error } = await supabaseClient.auth.getSession();
    if (error) {
        console.error(error);
    }

    if (!data || !data.session) {
        // Ch∆∞a ƒëƒÉng nh·∫≠p -> v·ªÅ trang login
        window.location.href = "login.html"; 
        return;
    }

    const session = data.session;
    currentUserId = session.user.id;

    const emailLabel = document.getElementById("userEmailLabel");
    // Ch·ªâ l·∫•y ph·∫ßn t√™n user tr∆∞·ªõc @ ho·∫∑c hi·ªÉn th·ªã s·ªë ƒëi·ªán tho·∫°i n·∫øu l√† email ·∫£o
    let displayName = session.user.email || "";
    if(displayName.includes("@")) displayName = displayName.split("@")[0];
    emailLabel.textContent = displayName;

    await loadSavingPot();
    
    // Auto update l√£i hi·ªÉn th·ªã m·ªói 10 gi√¢y cho c·∫£m gi√°c "sinh l·ªùi t·ª´ng ph√∫t"
    setInterval(updatePotDisplay, 10000);
})();
</script>
</body>
</html>

